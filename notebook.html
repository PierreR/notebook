<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.6.1">
<meta name="keywords" content="nix, nixos">
<meta name="author" content="Pierre Radermecker">
<title>Notebook</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:initial}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px 0}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:.4em .75em 0 .75em;line-height:1;vertical-align:top}
.colist>table tr>td:first-of-type img{max-width:initial}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
<style>
.listingblock .pygments .hll { background-color: #ffffcc }
.listingblock .pygments, .listingblock .pygments code { background: #f8f8f8; }
.listingblock .pygments .tok-c { color: #408080; font-style: italic } /* Comment */
.listingblock .pygments .tok-err { border: 1px solid #FF0000 } /* Error */
.listingblock .pygments .tok-k { color: #008000; font-weight: bold } /* Keyword */
.listingblock .pygments .tok-o { color: #666666 } /* Operator */
.listingblock .pygments .tok-ch { color: #408080; font-style: italic } /* Comment.Hashbang */
.listingblock .pygments .tok-cm { color: #408080; font-style: italic } /* Comment.Multiline */
.listingblock .pygments .tok-cp { color: #BC7A00 } /* Comment.Preproc */
.listingblock .pygments .tok-cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
.listingblock .pygments .tok-c1 { color: #408080; font-style: italic } /* Comment.Single */
.listingblock .pygments .tok-cs { color: #408080; font-style: italic } /* Comment.Special */
.listingblock .pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
.listingblock .pygments .tok-ge { font-style: italic } /* Generic.Emph */
.listingblock .pygments .tok-gr { color: #FF0000 } /* Generic.Error */
.listingblock .pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
.listingblock .pygments .tok-gi { color: #00A000 } /* Generic.Inserted */
.listingblock .pygments .tok-go { color: #888888 } /* Generic.Output */
.listingblock .pygments .tok-gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.listingblock .pygments .tok-gs { font-weight: bold } /* Generic.Strong */
.listingblock .pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.listingblock .pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
.listingblock .pygments .tok-kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.listingblock .pygments .tok-kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.listingblock .pygments .tok-kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.listingblock .pygments .tok-kp { color: #008000 } /* Keyword.Pseudo */
.listingblock .pygments .tok-kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.listingblock .pygments .tok-kt { color: #B00040 } /* Keyword.Type */
.listingblock .pygments .tok-m { color: #666666 } /* Literal.Number */
.listingblock .pygments .tok-s { color: #BA2121 } /* Literal.String */
.listingblock .pygments .tok-na { color: #7D9029 } /* Name.Attribute */
.listingblock .pygments .tok-nb { color: #008000 } /* Name.Builtin */
.listingblock .pygments .tok-nc { color: #0000FF; font-weight: bold } /* Name.Class */
.listingblock .pygments .tok-no { color: #880000 } /* Name.Constant */
.listingblock .pygments .tok-nd { color: #AA22FF } /* Name.Decorator */
.listingblock .pygments .tok-ni { color: #999999; font-weight: bold } /* Name.Entity */
.listingblock .pygments .tok-ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.listingblock .pygments .tok-nf { color: #0000FF } /* Name.Function */
.listingblock .pygments .tok-nl { color: #A0A000 } /* Name.Label */
.listingblock .pygments .tok-nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.listingblock .pygments .tok-nt { color: #008000; font-weight: bold } /* Name.Tag */
.listingblock .pygments .tok-nv { color: #19177C } /* Name.Variable */
.listingblock .pygments .tok-ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.listingblock .pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
.listingblock .pygments .tok-mb { color: #666666 } /* Literal.Number.Bin */
.listingblock .pygments .tok-mf { color: #666666 } /* Literal.Number.Float */
.listingblock .pygments .tok-mh { color: #666666 } /* Literal.Number.Hex */
.listingblock .pygments .tok-mi { color: #666666 } /* Literal.Number.Integer */
.listingblock .pygments .tok-mo { color: #666666 } /* Literal.Number.Oct */
.listingblock .pygments .tok-sa { color: #BA2121 } /* Literal.String.Affix */
.listingblock .pygments .tok-sb { color: #BA2121 } /* Literal.String.Backtick */
.listingblock .pygments .tok-sc { color: #BA2121 } /* Literal.String.Char */
.listingblock .pygments .tok-dl { color: #BA2121 } /* Literal.String.Delimiter */
.listingblock .pygments .tok-sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.listingblock .pygments .tok-s2 { color: #BA2121 } /* Literal.String.Double */
.listingblock .pygments .tok-se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.listingblock .pygments .tok-sh { color: #BA2121 } /* Literal.String.Heredoc */
.listingblock .pygments .tok-si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.listingblock .pygments .tok-sx { color: #008000 } /* Literal.String.Other */
.listingblock .pygments .tok-sr { color: #BB6688 } /* Literal.String.Regex */
.listingblock .pygments .tok-s1 { color: #BA2121 } /* Literal.String.Single */
.listingblock .pygments .tok-ss { color: #19177C } /* Literal.String.Symbol */
.listingblock .pygments .tok-bp { color: #008000 } /* Name.Builtin.Pseudo */
.listingblock .pygments .tok-fm { color: #0000FF } /* Name.Function.Magic */
.listingblock .pygments .tok-vc { color: #19177C } /* Name.Variable.Class */
.listingblock .pygments .tok-vg { color: #19177C } /* Name.Variable.Global */
.listingblock .pygments .tok-vi { color: #19177C } /* Name.Variable.Instance */
.listingblock .pygments .tok-vm { color: #19177C } /* Name.Variable.Magic */
.listingblock .pygments .tok-il { color: #666666 } /* Literal.Number.Integer.Long */
</style>
<style>
 h1, h2 { font-weight: 400;}
 h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 {
     /* color: #0b1e54; */
     color: #56103f;
 }

 table tr th, table tr td {
     padding: .45em .6em !important;
 }
 ul.sectlevel1 > li > a  {
     font-weight: bold !important;
 }

 div#toctitle {
     color: #1d4b8f !important;
     font-size: 1.45em !important;
     font-weight: 500 !important;

 }
 .admonitionblock .icon {
     font-size: smaller !important;
 }
 h3 .icon, h4 .icon {
     font-size: smaller !important;
 }
 .conum[data-value] {
     font-size: .65em !important;
 }
 mark {
     color: inherit !important;
     background-color: inherit !important;
     border: 1px solid #ccc;
     border-radius: 8px;
     margin-left: 3px;
     margin-right: 3px;
     padding-left: 5px;
     padding-right: 5px;
     padding-bottom: 1px;
 }

 .quoteblock blockquote:before {
     font-size: 1.75em !important;
 }
 .quoteblock blockquote, .quoteblock blockquote p {
     font-size: 1rem !important;
 }
 .sidebarblock {
     font-size: small;
     border-style: dotted;
     background: #fdfbfb;
 }
 .sidebarblock .literalblock  pre {
     background: #fdfbfb;
 }
.tri {
    width: 0;
    height: 0;
    border-top: 10px solid transparent;
    border-bottom: 10px solid transparent;
    border-right: 10px solid black;
    float: right;
    -moz-transition: -moz-transform .3s;
    -webkit-transition: -webkit-transform .3s;
    -o-transition: -o-transform .3s;
    transition: transform .3s;
}

.toggle {
    -moz-transform: rotate(-90deg);
     -o-transform: rotate(-90deg);
    -webkit-transform: rotate(-90deg);
    transform: rotate(-90deg);
}

</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Notebook</h1>
<div class="details">
<span id="author" class="author">Pierre Radermecker</span><br>
<span id="email" class="email"><a href="mailto:pierrer@pi3r.be">pierrer@pi3r.be</a></span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Notebook</div>
<ul class="sectlevel1">
<li><a href="#_nix">Nix</a>
<ul class="sectlevel2">
<li><a href="#_nixos">NixOS</a></li>
<li><a href="#_derivation">Derivation</a></li>
<li><a href="#_channels">Channels</a></li>
<li><a href="#_nix_shell">Nix-shell</a></li>
<li><a href="#_nix_env">Nix-env</a></li>
<li><a href="#_nix_build">Nix-build</a></li>
<li><a href="#_language_expressions">Language Expressions</a></li>
<li><a href="#_tips_and_tricks">Tips and tricks</a></li>
<li><a href="#_bootstrap">Bootstrap</a></li>
<li><a href="#_ruby">Ruby</a></li>
<li><a href="#_references">References</a></li>
</ul>
</li>
<li><a href="#_haskell">Haskell</a>
<ul class="sectlevel2">
<li><a href="#_concepts">Concepts</a></li>
<li><a href="#_fold_and_traverse">Fold and Traverse</a></li>
<li><a href="#_lenses">Lenses</a></li>
<li><a href="#_monads">Monads</a></li>
<li><a href="#_exceptions">Exceptions</a></li>
<li><a href="#_shake">Shake</a></li>
<li><a href="#_turtle">Turtle</a></li>
<li><a href="#_pipes">Pipes</a></li>
<li><a href="#_dhall">Dhall</a></li>
<li><a href="#_naming_convention">Naming convention</a></li>
<li><a href="#_idioms">Idioms</a></li>
<li><a href="#_extensions">Extensions</a></li>
<li><a href="#_common_functions">Common functions</a></li>
<li><a href="#_gats">GATS</a></li>
<li><a href="#_operational">Operational</a></li>
<li><a href="#_operator_colloquial_name">Operator colloquial name</a></li>
<li><a href="#_developments">Developments</a></li>
<li><a href="#_blast">Blast</a></li>
</ul>
</li>
<li><a href="#_spacemacs">Spacemacs</a>
<ul class="sectlevel2">
<li><a href="#_cheatsheet">Cheatsheet</a></li>
<li><a href="#_surround">Surround</a></li>
<li><a href="#_replace_on_multiple_files">Replace on multiple files</a></li>
</ul>
</li>
<li><a href="#_docker">Docker</a>
<ul class="sectlevel2">
<li><a href="#_intro">Intro</a></li>
<li><a href="#_useful_command">Useful command</a></li>
<li><a href="#_link">Link</a></li>
<li><a href="#_ssh_tunnel">SSH-tunnel</a></li>
<li><a href="#_export_import">Export/Import</a></li>
<li><a href="#_mount">Mount</a></li>
<li><a href="#_initial_win7_host_setup">Initial Win7 host setup</a></li>
<li><a href="#_trouble_shouting">Trouble Shouting</a></li>
<li><a href="#_docker_compose">Docker compose</a></li>
<li><a href="#_swarm_node">Swarm node</a></li>
<li><a href="#_dns">DNS</a></li>
</ul>
</li>
<li><a href="#_salt">Salt</a>
<ul class="sectlevel2">
<li><a href="#_targeting">Targeting</a></li>
<li><a href="#_salt_states">Salt states</a></li>
<li><a href="#_external_auth">External Auth</a></li>
<li><a href="#_standalone_minions">Standalone minions</a></li>
<li><a href="#_master_event">Master Event</a></li>
<li><a href="#_pillars">Pillars</a></li>
<li><a href="#_gitfs">GITFS</a></li>
<li><a href="#_salt_api">Salt API</a></li>
<li><a href="#_orchestration">Orchestration</a></li>
<li><a href="#_salt_ssl">Salt SSL</a></li>
<li><a href="#_useful_commands">Useful commands</a></li>
<li><a href="#_postgrest">Postgrest</a></li>
<li><a href="#_install_prd_bootstrap">Install PRD / Bootstrap</a></li>
<li><a href="#_issues">Issues</a></li>
</ul>
</li>
<li><a href="#_git">Git</a>
<ul class="sectlevel2">
<li><a href="#_internals">Internals</a></li>
<li><a href="#_tips">Tips</a></li>
</ul>
</li>
<li><a href="#_linux">Linux</a>
<ul class="sectlevel2">
<li><a href="#_script">Script</a></li>
<li><a href="#_lvm">LVM</a></li>
<li><a href="#_tips_2">Tips</a></li>
<li><a href="#_definitions">Definitions</a></li>
<li><a href="#_logs">Logs</a></li>
</ul>
</li>
<li><a href="#_postgres">Postgres</a>
<ul class="sectlevel2">
<li><a href="#_general">General</a></li>
<li><a href="#_nixos_2">NixOS</a></li>
<li><a href="#_tips_3">Tips</a></li>
<li><a href="#_replication">Replication</a></li>
</ul>
</li>
<li><a href="#_programming_notes">Programming Notes</a>
<ul class="sectlevel2">
<li><a href="#_notion">Notion</a></li>
<li><a href="#_quotes">Quotes</a></li>
<li><a href="#_scrible">Scrible</a></li>
</ul>
</li>
<li><a href="#_elastic_search">Elastic Search</a>
<ul class="sectlevel2">
<li><a href="#_characteristics">Characteristics</a></li>
</ul>
</li>
<li><a href="#_category_theory">Category theory</a></li>
<li><a href="#_purescript">Purescript</a>
<ul class="sectlevel2">
<li><a href="#_quick_setup">Quick setup</a></li>
<li><a href="#_tips_tricks">Tips &amp; tricks</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_nix">Nix</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Nix is not a configuration management tool alike <code>Puppet</code>, <code>Chef</code> or <code>Salt</code>. It is more accurately described as a (universal) package manager.</p>
</div>
<div class="paragraph">
<p>In that regard, unless you are running <code>nixos</code>, <code>disnix</code> (or use other tricks), nix won&#8217;t configure systemd services for instance.
Nix only operates on its store (usually located in '/nix') to gather packages called <code>derivations</code> in nix parlance.</p>
</div>
<div class="sect2">
<h3 id="_nixos">NixOS</h3>
<div class="sect3">
<h4 id="_span_class_icon_i_class_fa_fa_tasks_i_span_install"><span class="icon"><i class="fa fa-tasks"></i></span> Install</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Switch to azerty keyboard</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>→ loadkeys be-latin1</code></pre>
</div>
</div>
</li>
<li>
<p>Partition with gdisk (<a href="https://nixos.org/nixos/manual/index.html#sec-uefi-installation">efi</a>) or fdisk (noefi)</p>
<div class="paragraph">
<p><span class="icon"><i class="fa fa-info-circle fa-1x"></i></span> using virtualbox you don&#8217;t want/need efi</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>→ <span class="tok-o">(</span>g/f<span class="tok-o">)</span>disk /dev/sda</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create 2 partitions sda1(83 default)/sda2(82).</p>
</div>
<div class="paragraph">
<p>[efi] Create an extra (boot) partition with type EF00.</p>
</div>
</li>
<li>
<p>Create file system</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>→ mkfs.ext4 -L nixos /dev/sda1
→ mkswap -L swap /dev/sda2</code></pre>
</div>
</div>
<div class="paragraph">
<p>[efi] Choose <code>vfat</code>.</p>
</div>
</li>
<li>
<p>Mount it</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>→ mount /dev/disk/by-label/nixos /mnt</code></pre>
</div>
</div>
<div class="paragraph">
<p>[efi] <code>mkdir /mnt/boot</code> and mount the boot partition in.</p>
</div>
</li>
<li>
<p>Generate a default config</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>→ nixos-generate-config --root /mnt</code></pre>
</div>
</div>
</li>
<li>
<p>Minimal edit the config; don&#8217;t forget to uncomment the option 'boot.loader.grub.device'</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>→ vim /mnt/etc/nixos/configuration.nix</code></pre>
</div>
</div>
<div class="paragraph">
<p>[efi] No edit required.</p>
</div>
</li>
<li>
<p>Install</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>→ nixos-install</code></pre>
</div>
</div>
</li>
<li>
<p>Reboot</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>→ reboot</code></pre>
</div>
</div>
</li>
<li>
<p>Upgrade</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>→ nixos-rebuild boot --upgrade
→ reboot</code></pre>
</div>
</div>
</li>
<li>
<p><a href="#Configuration"><span class="icon"><i class="fa fa-wrench"></i></span> Configuration</a></p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="Configuration"><span class="icon"><i class="fa fa-wrench"></i></span> Configuration</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Some nix properties are set up in <code>/etc/nix/nix.conf</code></p>
</div>
<div class="paragraph">
<p>for <code>wifi</code>, manually configure it by using <code>NetworkManager</code> through the <code>nmtui</code> text interface</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">/etc/nixos/configuration</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="nix"><span></span>  nixpkgs<span class="tok-o">.</span>config<span class="tok-o">.</span><span class="tok-ss">allowUnfree =</span> <span class="tok-no">true</span><span class="tok-p">;</span>

  <span class="tok-ss">i18n =</span> <span class="tok-p">{</span>
    <span class="tok-ss">consoleFont =</span> <span class="tok-s2">&quot;Lat2-Terminus16&quot;</span><span class="tok-p">;</span>
    <span class="tok-ss">consoleKeyMap =</span> <span class="tok-s2">&quot;be-latin1&quot;</span><span class="tok-p">;</span>
    <span class="tok-ss">defaultLocale =</span> <span class="tok-s2">&quot;en_US.UTF-8&quot;</span><span class="tok-p">;</span>
  <span class="tok-p">}</span> <span class="tok-p">;</span>

  environment<span class="tok-o">.</span><span class="tok-ss">systemPackages =</span> <span class="tok-k">with</span> pkgs<span class="tok-p">;</span> <span class="tok-p">[</span>
    asciidoctor <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="tok-p">];</span>

  <span class="tok-c1"># Define a user account. Don&#39;t forget to set a password with ‘passwd’.</span>
  users<span class="tok-o">.</span>extraUsers<span class="tok-o">.</span><span class="tok-ss">nix =</span> <span class="tok-p">{</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-ss">createHome =</span> <span class="tok-no">true</span><span class="tok-p">;</span>
    <span class="tok-ss">home =</span> <span class="tok-s2">&quot;/home/nix&quot;</span><span class="tok-p">;</span>
    <span class="tok-ss">isSystemUser =</span> <span class="tok-no">true</span><span class="tok-p">;</span>
    <span class="tok-ss">extraGroups =</span> <span class="tok-p">[</span> <span class="tok-s2">&quot;wheel&quot;</span> <span class="tok-s2">&quot;disk&quot;</span> <span class="tok-s2">&quot;vboxusers&quot;</span> <span class="tok-s2">&quot;docker&quot;</span><span class="tok-p">];</span>
    <span class="tok-ss">shell =</span> <span class="tok-s2">&quot;/run/current-system/sw/bin/bash&quot;</span><span class="tok-p">;</span>
    <span class="tok-ss">uid =</span> <span class="tok-mi">1000</span><span class="tok-p">;</span>
  <span class="tok-p">};</span>

  programs<span class="tok-o">.</span>bash<span class="tok-o">.</span><span class="tok-ss">enableCompletion =</span> <span class="tok-no">true</span><span class="tok-p">;</span>
  security<span class="tok-o">.</span>sudo<span class="tok-o">.</span><span class="tok-ss">wheelNeedsPassword =</span> <span class="tok-no">false</span><span class="tok-p">;</span>

  <span class="tok-ss">fonts =</span> <span class="tok-p">{</span>
    <span class="tok-ss">enableFontDir =</span> <span class="tok-no">true</span><span class="tok-p">;</span>
    <span class="tok-ss">fonts =</span> <span class="tok-p">[</span> pkgs<span class="tok-o">.</span>source-code-pro <span class="tok-p">];</span>
  <span class="tok-p">};</span>

  nix<span class="tok-o">.</span><span class="tok-ss">extraOptions =</span> <span class="tok-s1">&#39;&#39;</span>
<span class="tok-s1">    gc-keep-outputs = true </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-s1">    gc-keep-derivations = true </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-s1">  &#39;&#39;</span><span class="tok-p">;</span>

  virtualisation<span class="tok-o">.</span>docker<span class="tok-o">.</span><span class="tok-ss">enable =</span> <span class="tok-no">true</span><span class="tok-p">;</span>
  virtualisation<span class="tok-o">.</span>docker<span class="tok-o">.</span><span class="tok-ss">extraOptions =</span> <span class="tok-s2">&quot;--insecure-registry x.lan --insecure-registry y.lan&quot;</span><span class="tok-p">;</span>

  virtualisation<span class="tok-o">.</span>virtualbox<span class="tok-o">.</span>guest<span class="tok-o">.</span><span class="tok-ss">enable =</span> <span class="tok-no">true</span><span class="tok-p">;</span> <i class="conum" data-value="4"></i><b>(4)</b>
  boot<span class="tok-o">.</span>initrd<span class="tok-o">.</span><span class="tok-ss">checkJournalingFS =</span> <span class="tok-no">false</span><span class="tok-p">;</span> <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>add packages</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>do create a new user ! <br>
(root won&#8217;t be able to have a chromium session by default)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>prevent too much gc in developer environment</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>virtualbox only</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_span_class_icon_i_class_fa_fa_cog_i_span_system_management"><span class="icon"><i class="fa fa-cog"></i></span> System management</h4>
<div class="listingblock">
<div class="title">Update</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>→ sudo nixos-rebuild switch
→ sudo nixos-rebuild boot --upgrade <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>safer to use <code>boot</code> when upgrading</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_derivation">Derivation</h3>
<div class="paragraph">
<p>Nix produces build product by following a two steps phase:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>Nix expression &#160;&#160; <em>(evaluation)</em> &#8594; &#160;&#160; Derivation &#160;&#160; <em>(realisation)</em> &#8594; &#160;&#160; Build product</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The first evaluation step is pure. The produced drv file acts as an intermediate specification for a build that can be freely redistribute to a set of machines.</p>
</div>
<div class="paragraph">
<p>Derivations are stored in the nix store as follows: /nix/store/hash-name, where the hash uniquely identifies the derivation (not true, it&#8217;s a little more complex than this), and name is the name of the derivation.</p>
</div>
<div class="paragraph">
<p>From a nix language point of view, a derivation is simply a set, with some attributes.</p>
</div>
<div class="paragraph">
<p>To build a package, <code>nixpkgs</code> makes heavy usage of <code>stdenv</code> and its function <code>mkDerivation</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="nix"><span></span>stdenv<span class="tok-o">.</span>mkDerivation <span class="tok-k">rec</span> <span class="tok-p">{</span>
  <span class="tok-ss">name =</span> <span class="tok-s2">&quot;libfoo-</span><span class="tok-si">${</span>version<span class="tok-si">}</span><span class="tok-s2">&quot;</span><span class="tok-p">;</span> <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="tok-ss">version =</span> <span class="tok-s2">&quot;1.2.3&quot;</span>
  <span class="tok-ss">src =</span> fetchurl <span class="tok-p">{</span>
    <span class="tok-ss">url =</span> <span class="tok-l">http://example.org/libfoo-1.2.3.tar.bz2</span><span class="tok-p">;</span>
    <span class="tok-ss">md5 =</span> <span class="tok-s2">&quot;e1ec107956b6ddcb0b8b0679367e9ac9&quot;</span><span class="tok-p">;</span> <i class="conum" data-value="2"></i><b>(2)</b>
  <span class="tok-p">};</span>
  <span class="tok-ss">builder =</span> <span class="tok-o">.</span><span class="tok-l">/builder.sh</span><span class="tok-p">;</span> <i class="conum" data-value="3"></i><b>(3)</b>
  <span class="tok-ss">buildInputs =</span> <span class="tok-p">[</span>ruby<span class="tok-p">];</span> <i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>mandatory <code>name</code> attr</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>mandatory checksum for remote source</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>if not provided, the generic builder is used</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>additional requirement needed to build the derivation</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The output of a derivation needs to be deterministic. That&#8217;s why you can fetch source remotely iff you know the hash beforehand.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">drv files</dt>
<dd>
<p>specification of how to build a derivation similar to the <code>.o</code> file in C.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_channels">Channels</h3>
<div class="paragraph">
<p>A channel is the Nix mechanism for distributing a consistent set of Nix expressions and binaries.
nix-channel --add</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>→ nix-channel --add http://nixos.org/channels/nixpkgs-unstable
→ nix-channel --update
→ nixos-rebuild switch</code></pre>
</div>
</div>
<div class="paragraph">
<p>The unstable channel is usually a few days older from <code>nixpkgs</code> master.
For a precise status, check <a href="http://howoldis.herokuapp.com">here</a>.</p>
</div>
<div class="paragraph">
<p>You can directly use a derivation from master. For instance, after cloning <code>nixpkgs</code>, you could type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>→  <span class="tok-nv">NIX_PATH</span><span class="tok-o">=</span><span class="tok-nv">nixpkgs</span><span class="tok-o">=</span>/home/vagrant/projects/nix/nixpkgs nix-env -f <span class="tok-s1">&#39;&lt;nixpkgs&gt;&#39;</span> -iA haskellPackages.stack</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>In future version of nix, <code>channel</code> might be deprecated to favor <code>NIX_PATH</code> solely.</p>
</li>
<li>
<p>On <code>nixos</code>, you should stick to <code>nixos-unstable</code> (don&#8217;t use <code>nixpkgs-unstable</code> because specific nixos sanity check won&#8217;t applied)</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_nix_shell">Nix-shell</h3>
<div class="paragraph">
<p>When Nix builds a package, it builds it in an isolated environment. It does this by creating a clean, child shell, then adding only the dependencies the package declares. After setting up the dependencies, it runs the build script, moves the built app into the Nix store, and sets up the environment to point to it. Finally, it destroys this child shell.</p>
</div>
<div class="paragraph">
<p>But we can ask Nix to not destroy the child shell, and instead let us use it for working iteratively on the app.
This is what the <mark>nix-shell</mark> is about: it will build the dependencies of the specified derivation, but <strong>not</strong> the derivation itself.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span> nix-shell <span class="tok-s1">&#39;&lt;nixpkgs&gt;&#39;</span> -p ruby haskellPackages.stack <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>p</code> and <code>-A</code> are mutually exclusive</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If a path is not given, nix-shell defaults to <code>shell.nix</code> if it exists, and <code>default.nix</code> otherwise.<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnote_1" title="View footnote.">1</a>]</sup></p>
</div>
<div class="paragraph">
<p>This allows for a nice trick. We can decribe a virtual dev environment (of any sort for any language) by decribing a derivation in <code>default.nix</code> like so:</p>
</div>
<div class="listingblock">
<div class="title">default.nix</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="nix"><span></span><span class="tok-k">with</span> <span class="tok-nb">import</span> <span class="tok-l">&lt;nixpkgs&gt;</span> <span class="tok-p">{};</span>

<span class="tok-k">let</span> <span class="tok-ss">henv =</span> haskellPackages<span class="tok-o">.</span>ghcWithPackages <span class="tok-p">(</span>p<span class="tok-p">:</span> <span class="tok-k">with</span> p<span class="tok-p">;</span> <span class="tok-p">[</span>shake<span class="tok-p">]);</span>

<span class="tok-k">in</span>
stdenv<span class="tok-o">.</span>mkDerivation <span class="tok-p">{</span>
  <span class="tok-ss">name =</span> <span class="tok-s2">&quot;haskell-env&quot;</span><span class="tok-p">;</span>
  <span class="tok-ss">buildInputs =</span> <span class="tok-p">[</span> henv pythonPackages<span class="tok-o">.</span>pyyaml<span class="tok-p">];</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>nix-shell will use the <code>NIX_PATH</code> environment variable which by default in user space points to the root nixpkgs channel. That means that (unlike <code>nix-env</code>), even if your channel points to unstable in user space, nix-shell might still use the root stable channel. You can change that behavior by running for instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>nix-shell -I <span class="tok-nv">nixpkgs</span><span class="tok-o">=</span>https://github.com/NixOS/nixpkgs-channels/archive/nixos-unstable.tar.gz</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can force any script file to run in a nix-shell as such:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-ch">#! /usr/bin/env nix-shell</span>
<span class="tok-c1">#! nix-shell -i bash</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>or without a default.nix file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-ch">#! /usr/bin/env nix-shell</span>
<span class="tok-c1">#! nix-shell --pure</span>
<span class="tok-c1">#! nix-shell -p asciidoctor -p pythonPackages.pygments</span>
<span class="tok-c1">#! nix-shell -p &quot;haskellPackages.ghcWithPackages(p: with p; [shake])&quot; </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-c1">#! nix-shell -i bash</span>
<span class="tok-c1">#! /usr/bin/env nix-shell</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Double quotes are required. Don&#8217;t add <code>-p ghc</code> as you will end up with two different ghcs !</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In Haskell, we need the --attr <a href="https://github.com/NixOS/nixpkgs/blob/b40e1efe000ec5c4616cecc9d6836eade419434e/pkgs/development/haskell-modules/generic-builder.nix#L283">env</a> to tell <code>nix-shell</code> to compute the isolated development environment:</p>
</div>
<div class="listingblock">
<div class="title">shell.nix</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="nix"><span></span><span class="tok-k">with</span> <span class="tok-p">(</span><span class="tok-nb">import</span> <span class="tok-l">&lt;nixpkgs&gt;</span> <span class="tok-p">{})</span><span class="tok-o">.</span>pkgs<span class="tok-p">;</span>
<span class="tok-p">(</span>haskellPackages<span class="tok-o">.</span>callPackage <span class="tok-o">.</span><span class="tok-l">/.</span> <span class="tok-p">{})</span><span class="tok-o">.</span>env <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>callPackage</code> will use the current defined scope to pass matched arguments</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>default.nix</code> is then generated by <code>cabal2nix</code> to describe how to nix-build the haskell package.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_nix_env">Nix-env</h3>
<div class="paragraph">
<p><mark>nix-env</mark> is the command to use to search, install, remove packages locally in user space (or profile). These packages are installed in the <code>nix-store</code> but are only accessible inside one environment (aka user/profile).</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>nix-env</code> doesn&#8217;t require a starting nix expression. As a consequence, <code>nix-env</code> does not use <code>&lt;nixpkgs&gt;</code> as NIX_PATH. It actually uses <code>~/.nix-defexpr/channels</code>.<br>
If you want to use &lt;nixpkgs&gt;, you would explicitly use the <code>-f</code> (or <code>--file</code>) option on the command line.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>-q</strong> list installed derivations within a profile</p>
</li>
<li>
<p><strong>-qaP</strong> list available package with the path</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When searching for packages, it is usually more efficient to specify a namespace attribute using the <code>-A</code> option.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># in nixos:</span>
→ nix-env -qaP -A nixos.haskellPackages
→ nix-env -qaP -A nixos.pythonPackages
<span class="tok-c1"># outside nixos:</span>
→ nix-env -qaP -A nixpkgs.pythonPackages</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also omit the channel namespace and specify the input for <code>nixpkgs</code> explicitly with the <code>-f</code> option:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>→ nix-env -f <span class="tok-s1">&#39;&lt;nixpkgs&gt;&#39;</span> -qaP -A haskellPackages.shake --description</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>-i</strong> install derivations</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>→ nix-env -f <span class="tok-s1">&#39;&lt;nixpkgs&gt;&#39;</span> -iA pythonPackages.pyyaml <i class="conum" data-value="1"></i><b>(1)</b>
→ nix-env -f <span class="tok-s1">&#39;&lt;nixpkgs&gt;&#39;</span> -i brackets -I <span class="tok-nv">nixpkgs</span><span class="tok-o">=</span>https://github.com/NixOS/nixpkgs/archive/master.tar.gz’ <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>on nixos, you might use <code>nix-env -iA nixos.pythonPackages.pyyaml</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>install from master directly</td>
</tr>
</table>
</div>
</li>
<li>
<p><strong>-e</strong> erase</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>→ nix-env -e python2.7-PyYAML-3.11</code></pre>
</div>
</div>
</li>
<li>
<p><strong>-u</strong> update</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>→ nix-env -u</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_nix_build">Nix-build</h3>
<div class="paragraph">
<p>nix-build tool does two main jobs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>nix-instantiate: parse the <code>.nix</code> file and return the .drv file (the evaluation step)</p>
</li>
<li>
<p>nix-store -r: realise the .drv, which actually builds the derivation</p>
</li>
</ul>
</div>
<div class="sidebarblock">
<div class="content">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<code>nix-pull</code> is deprecated and replaced by the use of <code>binary caches</code>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_language_expressions">Language Expressions</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">String</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="nix"><span></span><span class="tok-k">let</span>
  <span class="tok-ss">h =</span> <span class="tok-s2">&quot;Hello&quot;</span><span class="tok-p">;</span>
  <span class="tok-ss">value =</span> <span class="tok-mi">4</span><span class="tok-p">;</span>
<span class="tok-k">in</span>
<span class="tok-p">{</span>
  <span class="tok-ss">helloWorld =</span> <span class="tok-s2">&quot;</span><span class="tok-si">${</span>h<span class="tok-si">}</span><span class="tok-s2"> </span><span class="tok-si">${</span><span class="tok-nb">toString</span> value<span class="tok-si">}</span><span class="tok-s2"> the win!&quot;</span><span class="tok-p">;</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>interpolation of the <code>toString</code> builtin function to convert an int value</td>
</tr>
</table>
</div>
</dd>
<dt class="hdlist1">List</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="nix"><span></span><span class="tok-p">[</span> <span class="tok-mi">123</span> <span class="tok-o">.</span><span class="tok-l">/foo.nix</span> <span class="tok-s2">&quot;abc&quot;</span> <span class="tok-p">(</span>f <span class="tok-p">{</span> <span class="tok-ss">x =</span> y<span class="tok-p">;</span> <span class="tok-p">})</span> <span class="tok-p">]</span></code></pre>
</div>
</div>
</dd>
<dt class="hdlist1">Set</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="nix"><span></span><span class="tok-k">let</span> <span class="tok-ss">x =</span> <span class="tok-mi">12</span><span class="tok-p">;</span>
    <span class="tok-ss">y =</span> <span class="tok-mi">34</span><span class="tok-p">;</span>
    <span class="tok-ss">f =</span> <span class="tok-p">{</span>n<span class="tok-p">}:</span> <span class="tok-mi">5</span> <span class="tok-o">+</span> n<span class="tok-p">;</span>
<span class="tok-k">in</span>
<span class="tok-k">rec</span> <span class="tok-p">{</span>
  <span class="tok-ss">r =</span> <span class="tok-p">{</span> <span class="tok-k">inherit</span> x y<span class="tok-p">;</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-ss">text =</span> <span class="tok-s2">&quot;Hello&quot;</span><span class="tok-p">;</span>
    <span class="tok-ss">add =</span> f <span class="tok-p">{</span> <span class="tok-ss">n =</span> <span class="tok-mi">56</span><span class="tok-p">;</span> <span class="tok-p">};</span> <i class="conum" data-value="2"></i><b>(2)</b>
  <span class="tok-p">};</span>
  <span class="tok-ss">sum =</span> r<span class="tok-o">.</span>add <span class="tok-o">+</span> r<span class="tok-o">.</span>y<span class="tok-p">;</span>
  <span class="tok-ss">hello =</span> r<span class="tok-o">.</span>text <span class="tok-ow">or</span> <span class="tok-s2">&quot;World&quot;</span><span class="tok-p">;</span> <i class="conum" data-value="3"></i><b>(3)</b>
  <span class="tok-ss">b =</span> r <span class="tok-o">?</span> x<span class="tok-p">;</span> <i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>when defining a set it is often convenient to copy variables from the surrounding lexical scope</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>all <code>;</code> are mandatory</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Sets accessor using <code>.</code><br>
Default using <code>or</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>does the record 'r' contains an attribute 'x' <code>?</code></td>
</tr>
</table>
</div>
</dd>
<dt class="hdlist1">Function</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="nix"><span></span>pattern<span class="tok-p">:</span> body</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="nix"><span></span><span class="tok-c1"># `min` and `max` are available in stdenv.lib</span>
<span class="tok-ss">min =</span> x<span class="tok-p">:</span> y<span class="tok-p">:</span> <span class="tok-k">if</span> x <span class="tok-err">&lt;</span> y <span class="tok-k">then</span> x <span class="tok-k">else</span> y<span class="tok-p">;</span> <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>pattern is a func returning a func (2 arguments)</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="nix"><span></span><span class="tok-p">{</span>stdenv<span class="tok-p">,</span> fetchurl<span class="tok-p">,</span> perl<span class="tok-p">,</span> <span class="tok-o">...</span> <span class="tok-p">}:</span> <i class="conum" data-value="1"></i><b>(1)</b>

  stdenv<span class="tok-o">.</span>mkDerivation <span class="tok-p">{</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-ss">name =</span> <span class="tok-s2">&quot;hello-2.1.1&quot;</span><span class="tok-p">;</span>
	<span class="tok-o">...</span>
  <span class="tok-p">};</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>pattern is a set of arguments<br>
the 'ellipsis' (<code>&#8230;&#8203;</code>) allows the passing of a bigger set, one that contains more than the 3 required arguments.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>function call passing a set as argument</td>
</tr>
</table>
</div>
</dd>
<dt class="hdlist1">With</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="nix"><span></span><span class="tok-k">with</span> e1<span class="tok-p">;</span> e2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Introduces all attributes of the set <code>e1</code> into the lexical scope of the expression <code>e2</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="nix"><span></span><span class="tok-k">let</span> <span class="tok-ss">as =</span> <span class="tok-p">{</span> <span class="tok-ss">x =</span> <span class="tok-s2">&quot;foo&quot;</span><span class="tok-p">;</span> <span class="tok-ss">y =</span> <span class="tok-s2">&quot;bar&quot;</span><span class="tok-p">;</span> <span class="tok-p">};</span>
<span class="tok-k">in</span>
<span class="tok-ss">foobar =</span> <span class="tok-k">with</span> as<span class="tok-p">;</span> x <span class="tok-o">+</span> y</code></pre>
</div>
</div>
</dd>
<dt class="hdlist1">Optional argument</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="nix"><span></span><span class="tok-p">{</span> x<span class="tok-p">,</span> y <span class="tok-o">?</span> <span class="tok-s2">&quot;foo&quot;</span><span class="tok-p">,</span> z <span class="tok-o">?</span> <span class="tok-s2">&quot;bar&quot;</span> <span class="tok-p">}:</span> z <span class="tok-o">+</span> y <span class="tok-o">+</span> x <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>a function that only requires an attribute named x, but optionally accepts y and z.</td>
</tr>
</table>
</div>
</dd>
<dt class="hdlist1">Merge sets</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="nix"><span></span>e1 <span class="tok-o">//</span> e2 <span class="tok-c1"># merge e1 and e2 with e2 taking precedence in case of equally named attribute</span></code></pre>
</div>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_tips_and_tricks">Tips and tricks</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">Customize nixpkgs locally</dt>
<dd>
<div class="paragraph">
<p>You can override derivation attributes in user space without forking the <code>nixpkgs</code> repository.
In <code>~/.nixpkgs/config.nix</code> you typically declare a <code>packageOverrides</code> function and then use <code>override</code> to customize attributes:</p>
</div>
<div class="listingblock">
<div class="title">~/.nixpkgs/config.nix</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="nix"><span></span><span class="tok-p">{</span>
  <span class="tok-ss">packageOverrides =</span> super<span class="tok-p">:</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-k">let</span> <span class="tok-ss">self =</span> super<span class="tok-o">.</span>pkgs<span class="tok-p">;</span>
        <span class="tok-ss">foo =</span> super<span class="tok-o">.</span>foo<span class="tok-o">.</span>override <span class="tok-p">{</span> <span class="tok-ss">barSupport =</span> <span class="tok-no">true</span> <span class="tok-p">;</span> <span class="tok-p">};</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-k">in</span>
    <span class="tok-p">{</span>
      <span class="tok-k">inherit</span> foo<span class="tok-p">;</span>
      <span class="tok-ss">haskellPackages =</span> super<span class="tok-o">.</span>haskellPackages<span class="tok-o">.</span>override <span class="tok-p">{</span>
        <span class="tok-ss">overrides =</span> self<span class="tok-p">:</span> super<span class="tok-p">:</span> <span class="tok-p">{</span> <i class="conum" data-value="3"></i><b>(3)</b>
          <span class="tok-ss">language-puppet_1_3_3 =</span> self<span class="tok-o">.</span>callPackage <span class="tok-o">.</span><span class="tok-l">/pkgs/language-puppet</span> <span class="tok-p">{</span><span class="tok-k">inherit</span> foo<span class="tok-p">;};</span> <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="tok-p">};</span>
    <span class="tok-p">};</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><mark>packageOverrides</mark> takes the original (super) nixpkgs set and return a new (self) record set.
<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnote_2" title="View footnote.">2</a>]</sup></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>call <mark>override</mark> (defined on much derivations) to changes the arguments passed to it.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>override the <mark>overrides</mark> attribute of haskellPackages</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>key = value of the return set</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title"> <div class="tri"></div>  override/fix pattern</div>
<div class="literalblock">
<div class="content">
<pre>fix = f:
  let self = f self;
  in self;

extend = attrs: f: self:
  let super = attrs self;
  in super // f self super;

ps = self:
  { foo = "foo"; bar = "bar";
     foobar = self.foo + self.bar;
  };

f = self: super:
  { foo = reverse super.foo; }

(fix ps).foobar # "foobar"

(fix (extend ps f)).foobar # "oofbar"</pre>
</div>
</div>
</div>
</div>
</dd>
<dt class="hdlist1">Overlays</dt>
<dd>
<p>Since <code>17.03</code> there is a more idiomatic way to achieve such local customization:</p>
<div class="listingblock">
<div class="title">~/.config/nixpgks/overlays/default.nix</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>self: super:
<span class="tok-nb">let</span>
  <span class="tok-nv">hlib</span> <span class="tok-o">=</span> super.haskell.lib<span class="tok-p">;</span>
in
<span class="tok-o">{</span>
  <span class="tok-nv">haskellPackages</span> <span class="tok-o">=</span> super.haskellPackages.override <span class="tok-o">{</span>
    <span class="tok-nv">overrides</span> <span class="tok-o">=</span>  hpkgs: _hpkgs: <span class="tok-o">{</span>
      cicd-shell <span class="tok-o">=</span> hlib.dontCheck <span class="tok-o">(</span>hlib.dontHaddock
        <span class="tok-o">(</span>_hpkgs.callCabal2nix <span class="tok-s2">&quot;cicd-shell&quot;</span> <span class="tok-o">(</span>super.fetchgit <span class="tok-o">{</span> <i class="conum" data-value="1"></i><b>(1)</b>
           <span class="tok-nv">url</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;http://stash.cirb.lan/scm/cicd/cicd-shell.git&quot;</span><span class="tok-p">;</span>
           <span class="tok-nv">rev</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;d76c532d69e4d01bdaf2c716533d9557371c28ea&quot;</span><span class="tok-p">;</span>
           <span class="tok-nv">sha256</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;0yval6k6rliw1q79ikj6xxnfz17wdlnjz1428qbv8yfl8692p13h&quot;</span><span class="tok-p">;</span>
         <span class="tok-o">})</span> <span class="tok-o">{</span>
              <span class="tok-nv">protolude</span> <span class="tok-o">=</span> _hpkgs.protolude_0_2<span class="tok-p">;</span>
            <span class="tok-o">}</span>
        <span class="tok-o">))</span><span class="tok-p">;</span>
      <span class="tok-o">}</span><span class="tok-p">;</span>
    <span class="tok-o">}</span><span class="tok-p">;</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>callCabal2nix</code> allows to automatically fetch and build any haskell package from the web</td>
</tr>
</table>
</div>
</dd>
<dt class="hdlist1">Overrides haskell packages for the <code>ghc821</code> compiler</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>self: super:
<span class="tok-nb">let</span>
  <span class="tok-nv">hlib</span> <span class="tok-o">=</span> super.haskell.lib<span class="tok-p">;</span>
in
<span class="tok-o">{</span>
<span class="tok-nv">haskell</span> <span class="tok-o">=</span> super.haskell // <span class="tok-o">{</span> <span class="tok-nv">packages</span> <span class="tok-o">=</span> super.haskell.packages // <span class="tok-o">{</span> <span class="tok-nv">ghc821</span> <span class="tok-o">=</span> super.haskell.packages.ghc821.override <span class="tok-o">{</span> <i class="conum" data-value="1"></i><b>(1)</b>
   <span class="tok-nv">overrides</span> <span class="tok-o">=</span>  hpkgs: _hpkgs: <span class="tok-o">{</span>
     <span class="tok-nv">containers</span> <span class="tok-o">=</span> hlib.dontCheck<span class="tok-o">(</span>_hpkgs.containers<span class="tok-o">)</span><span class="tok-p">;</span>
   <span class="tok-o">}</span><span class="tok-p">;</span>
<span class="tok-o">}</span><span class="tok-p">;</span><span class="tok-o">}</span><span class="tok-p">;</span><span class="tok-o">}</span><span class="tok-p">;</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>haskell</code> equals <code>super.haskell</code> except packages, which equals <code>super.haskell.packages</code> except for <code>ghc821</code>, which is the overriden version of <code>super 821</code></td>
</tr>
</table>
</div>
</dd>
<dt class="hdlist1">Private packages</dt>
<dd>
<div class="paragraph">
<p>You can also extend <code>nixpkgs</code> with private derivations without any forking. For instance using a custom file:</p>
</div>
<div class="listingblock">
<div class="title">dotfiles.nix</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="nix"><span></span><span class="tok-k">with</span> <span class="tok-nb">import</span> <span class="tok-l">&lt;nixpkgs&gt;</span> <span class="tok-p">{};</span> <i class="conum" data-value="1"></i><b>(1)</b>

<span class="tok-k">let</span> <span class="tok-ss">xmonadEnv =</span> haskellPackages<span class="tok-o">.</span>ghcWithPackages <span class="tok-p">(</span>p<span class="tok-p">:</span> <span class="tok-k">with</span> p<span class="tok-p">;</span> <span class="tok-p">[</span>xmonad xmonad-contrib<span class="tok-p">]);</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-k">in</span>

stdenv<span class="tok-o">.</span>mkDerivation <span class="tok-p">{</span>
  <span class="tok-ss">name =</span> <span class="tok-s2">&quot;devbox_dotfiles-0.1&quot;</span><span class="tok-p">;</span>

  <span class="tok-ss">src =</span> fetchFromGitHub <span class="tok-p">{</span>
    <span class="tok-ss">owner =</span> <span class="tok-s2">&quot;CIRB&quot;</span><span class="tok-p">;</span>
    <span class="tok-ss">repo =</span> <span class="tok-s2">&quot;devbox-dotfiles&quot;</span><span class="tok-p">;</span>
    <span class="tok-ss">rev =</span> <span class="tok-s2">&quot;801f66f3c7d657f5648963c60e89743d85133b1a&quot;</span> <span class="tok-p">;</span>
    <span class="tok-ss">sha256 =</span> <span class="tok-s2">&quot;1w4vaqp21dmdd1m5akmzq4c3alabyn0mp94s6lqzzp1qpla0sdx0&quot;</span> <span class="tok-p">;</span>
  <span class="tok-p">};</span>

  <span class="tok-ss">buildInputs =</span> <span class="tok-p">[</span> xmonadEnv <span class="tok-p">];</span>

  <span class="tok-ss">installPhase =</span> <span class="tok-s1">&#39;&#39;</span>
<span class="tok-s1">    </span><span class="tok-si">${</span>xmonadEnv<span class="tok-si">}</span><span class="tok-s1">/bin/ghc --make .xmonad/xmonad.hs -o .xmonad/xmonad-x86_64-linux </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-s1">    cp -R ./. $out </span><i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-s1">  &#39;&#39;</span><span class="tok-p">;</span>

  <span class="tok-ss">meta =</span> <span class="tok-p">{</span>
    <span class="tok-ss">description =</span> <span class="tok-s2">&quot;Dot files for the devbox&quot;</span><span class="tok-p">;</span>
  <span class="tok-p">};</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>dependencies provided by <code>nixpkgs</code> using $NIX_PATH</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>ghc with module deps included</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>at this stage, the shell is inside a temp dir with the src included</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>copy the content of the current dir into $out</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You then build the derivation or install it in the user environment.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>→ nix-build dotfiles.nix
→ nix-env -f dotfiles.nix -i devbox_dotfiles <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>nix-env -i</code> takes the name attribute and strip the version (first numeric after <code>-</code>)</td>
</tr>
</table>
</div>
</dd>
<dt class="hdlist1">Pinned a version of nixpkgs</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nv">nixpkgs</span> <span class="tok-o">=</span> <span class="tok-o">(</span>import &lt;nixpkgs&gt; <span class="tok-o">{})</span>.pkgs.fetchgit <span class="tok-o">{</span>
            <span class="tok-nv">url</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;https://github.com/nixos/nixpkgs-channels&quot;</span><span class="tok-p">;</span>
            <span class="tok-nv">rev</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;f93a8ee1105f4cc3770ce339a8c1a4acea3b2fb6&quot;</span><span class="tok-p">;</span>
            <span class="tok-nv">sha256</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;01fnyw711p6kf9qpdabys9im10hlih1l1pxwp06wkq7b9wsljawd&quot;</span><span class="tok-p">;</span>
          <span class="tok-o">}</span><span class="tok-p">;</span>

in

with import nixpkgs <span class="tok-o">{}</span><span class="tok-p">;</span></code></pre>
</div>
</div>
</dd>
<dt class="hdlist1">Caching the list of all available package into a local file</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>nix-env -qaP --description <span class="tok-s1">&#39;*&#39;</span> &gt; ~/allpkgs.desc</code></pre>
</div>
</div>
</dd>
<dt class="hdlist1">Reproduce any hydra build locally</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>bash &lt;<span class="tok-o">(</span>curl https://hydra.nixos.org/build/57055021/reproduce<span class="tok-o">)</span></code></pre>
</div>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_bootstrap">Bootstrap</h3>
<div class="paragraph">
<p>Nix composes all of these individual functions into a large package repository. This repository essentially calls every single top level function, with support for recursive bindings in order to satisfy dependencies. Continuing with the hello example, we may have a top-level entry point like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="nix"><span></span><span class="tok-k">rec</span> <span class="tok-p">{</span>
  <span class="tok-ss">hello =</span> <span class="tok-nb">import</span> <span class="tok-l">/path/to/hello.nix</span> <span class="tok-p">{</span> <span class="tok-k">inherit</span> stdenv fetchurl<span class="tok-p">;</span> <span class="tok-p">};</span> <i class="conum" data-value="1"></i><b>(1)</b>

  <span class="tok-ss">stdenv =</span> <span class="tok-nb">import</span> <span class="tok-l">/path/to/stdenv.nix</span> <span class="tok-p">{</span> <span class="tok-k">inherit</span> gcc <span class="tok-p">};</span>

  <span class="tok-ss">fetchurl =</span> <span class="tok-nb">import</span> <span class="tok-l">/path/to</span> <span class="tok-p">;</span>

  <span class="tok-ss">gcc =</span> <span class="tok-nb">import</span> <span class="tok-l">/path/to/gcc.nix</span> <span class="tok-p">{};</span>

  <span class="tok-c1"># ...</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Import loads a file containing a function and then calls that function with the provided arguments</td>
</tr>
</table>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>But wait - I just said this calls all functions… so wouldn’t that then mean that all software gets installed? The trick here is that Nix is a lazy language.</p>
</div>
</blockquote>
</div>
</div>
<div class="sect2">
<h3 id="_ruby">Ruby</h3>
<div class="ulist">
<ul>
<li>
<p>Create or copy a Gemfile at the root dir of the project</p>
</li>
<li>
<p>Install bundler in my user profile if it is not already there.</p>
</li>
<li>
<p>Create a Gemfile.lock by running bundler lock</p>
</li>
<li>
<p>Use bundix in the target directory: $(nix-build '&lt;nixpkgs&gt;' -A bundix)/bin/bundix. It will create a gimset.nix file</p>
</li>
<li>
<p>Create a default.nix file</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_references">References</h3>
<div class="ulist">
<ul>
<li>
<p><a href="http://lethalman.blogspot.be/search/label/nixpills">nix pills</a></p>
</li>
<li>
<p><a href="http://sandervanderburg.blogspot.be/2014/07/managing-private-nix-packages-outside.html">private packages</a></p>
</li>
<li>
<p><a href="https://nixcloud.io/tour/?id=1" class="bare">https://nixcloud.io/tour/?id=1</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_haskell">Haskell</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_concepts">Concepts</h3>
<div class="sect3">
<h4 id="_type_class">Type class</h4>
<div class="paragraph">
<p>Type classes are in a sense dual to type declarations. Whereas the latter defines how types are created, type class defines how a set of types are consumed.</p>
</div>
<div class="paragraph">
<p>When talking about polymorphism, type class enables a form of <code>adhoc polymorphism</code>  or <code>overloading</code> <sup class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnote_3" title="View footnote.">3</a>]</sup> that needs to be delimited as such to play well with <code>parametric polymorphism</code> and keeping the type checking sane.</p>
</div>
<div class="paragraph">
<p>Type class are not first class in Haskell. They cannot be used in place of type (as you would in Java with interface).</p>
</div>
<div class="paragraph">
<p>It is internally implemented as <strong><em>dictionnary passing</em></strong>: <code>ghc</code> puts the methods of the instance in a dictionary and passes that implicitly to any functions having a class constraint.</p>
</div>
<div class="paragraph">
<p>It is best to look at them as a set of constraints on type.
One notable drawback is that each type can have at most one implementation of the type class.</p>
</div>
<div class="paragraph">
<p><mark>Eq</mark>, <mark>Show</mark>, <mark>Num</mark>, <mark>Integral</mark>, <mark>Ord</mark>, <mark>Enum</mark> are classical examples.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-kr">class</span> <span class="tok-kt">Num</span> <span class="tok-n">a</span> <span class="tok-kr">where</span>
  <span class="tok-p">(</span><span class="tok-o">+</span><span class="tok-p">)</span> <span class="tok-ow">::</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">a</span>
  <span class="tok-p">(</span><span class="tok-o">*</span><span class="tok-p">)</span> <span class="tok-ow">::</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">a</span>
  <span class="tok-p">(</span><span class="tok-o">-</span><span class="tok-p">)</span> <span class="tok-ow">::</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">a</span>
  <span class="tok-n">negate</span> <span class="tok-ow">::</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">a</span>
  <span class="tok-n">abs</span> <span class="tok-ow">::</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">a</span>
  <span class="tok-n">signum</span> <span class="tok-ow">::</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">a</span>
  <span class="tok-n">fromInteger</span> <span class="tok-ow">::</span> <span class="tok-kt">Integer</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">a</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Using <mark>enumFromTo</mark> from the Enum type class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="shell"><span></span>→ enumFromTo 3 8     -&gt; [3,4,5,6,7,8]
→ enumFromTo &#39;a&#39; &#39;f&#39; -&gt; &quot;abcdef&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p><span class="icon"><i class="fa fa-info-circle fa-1x"></i></span> In Scala, type-classes are types themselves, and instances are first class values.</p>
</div>
</div>
<div class="sect3">
<h4 id="_type_family">Type Family</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-kr">data</span> <span class="tok-kt">Nat</span> <span class="tok-ow">=</span> <span class="tok-kt">Zero</span> <span class="tok-o">|</span> <span class="tok-kt">Succ</span> <span class="tok-kt">Nat</span>

<span class="tok-c1">-- Add is a type which is a function on types</span>
<span class="tok-kr">type</span> <span class="tok-n">family</span> <span class="tok-kt">Add</span> <span class="tok-p">(</span><span class="tok-n">x</span> <span class="tok-ow">::</span> <span class="tok-kt">Nat</span><span class="tok-p">)</span> <span class="tok-p">(</span><span class="tok-n">y</span> <span class="tok-ow">::</span> <span class="tok-kt">Nat</span><span class="tok-p">)</span> <span class="tok-ow">::</span> <span class="tok-kt">Nat</span>
<span class="tok-c1">-- Then comes the implementation of the (type) function</span>
<span class="tok-kr">type</span> <span class="tok-kr">instance</span> <span class="tok-kt">Add</span> <span class="tok-kt">Zero</span>     <span class="tok-n">y</span> <span class="tok-ow">=</span> <span class="tok-n">y</span>
<span class="tok-kr">type</span> <span class="tok-kr">instance</span> <span class="tok-kt">Add</span> <span class="tok-p">(</span><span class="tok-kt">Succ</span> <span class="tok-n">x</span><span class="tok-p">)</span> <span class="tok-n">y</span> <span class="tok-ow">=</span> <span class="tok-kt">Succ</span> <span class="tok-p">(</span><span class="tok-kt">Add</span> <span class="tok-n">x</span> <span class="tok-n">y</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_typeable">Typeable</h4>
<div class="paragraph">
<p>The <mark>Typeable</mark> class is used to create runtime type information for arbitrary types:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-cm">{-# LANGUAGE DeriveDataTypeable #-}</span>

<span class="tok-kr">import</span> <span class="tok-nn">Data.Typeable</span>

<span class="tok-kr">data</span> <span class="tok-kt">Animal</span> <span class="tok-ow">=</span> <span class="tok-kt">Cat</span> <span class="tok-o">|</span> <span class="tok-kt">Dog</span> <span class="tok-kr">deriving</span> <span class="tok-kt">Typeable</span>
<span class="tok-kr">data</span> <span class="tok-kt">Zoo</span> <span class="tok-n">a</span> <span class="tok-ow">=</span> <span class="tok-kt">Zoo</span> <span class="tok-p">[</span><span class="tok-n">a</span><span class="tok-p">]</span> <span class="tok-kr">deriving</span> <span class="tok-kt">Typeable</span>

<span class="tok-nf">example</span> <span class="tok-ow">::</span> <span class="tok-kt">TypeRep</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-nf">example</span> <span class="tok-ow">=</span> <span class="tok-n">typeRep</span> <span class="tok-p">(</span><span class="tok-kt">Zoo</span> <span class="tok-p">[</span><span class="tok-kt">Cat</span><span class="tok-p">,</span> <span class="tok-kt">Dog</span><span class="tok-p">])</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-c1">-- Zoo Animal</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Runtime representation of the type of the value</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><mark>typeRep</mark> correspond to <code>typeOf</code> which is kept for backwards-compatibility</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-kr">class</span> <span class="tok-kt">Typeable</span> <span class="tok-n">a</span> <span class="tok-kr">where</span>
  <span class="tok-n">typeRep</span> <span class="tok-ow">::</span> <span class="tok-kt">Proxy</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">TypeRep</span> <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>take a type (Proxy) that it never look at</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>Typeable</code> is actually as old as Haskell (before it was even called Haskell &#8230;&#8203;)</p>
</div>
</div>
<div class="sect3">
<h4 id="_ref_state_primitives">Ref/State Primitives</h4>
<div class="dlist">
<dl>
<dt class="hdlist1">MVars</dt>
<dd>
<p>concurrency primitive, designed for access from multiple threads.
It is a box which can be full or empty. If a thread tries to read a value from an empty MVar, it will block until the MVar gets filled (by another thread). Same with full and takeMVar.</p>
</dd>
<dt class="hdlist1">IVar</dt>
<dd>
<p>Immutable variable you are only allowed to write to it once.</p>
</dd>
<dt class="hdlist1">STM</dt>
<dd>
<p>Retry aborts the transaction and retry it whenever the TVar gets modified.</p>
</dd>
<dt class="hdlist1">IORef</dt>
<dd>
<p>Just a reference to some data, a <code>cell</code>.
Operate in IO.
You can think of it like a database, file, or other external data store.
<code>atomicModifyIORef</code> uses CAS (compare and swap implemented at the hardware level) to guarantee the atomicity of read-modify-write kind of operations.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_functor">Functor</h4>
<div class="exampleblock">
<div class="content">
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>A functor is a structure-preserving mapping (or homomorphism) between 2 categories.</p>
</div>
</blockquote>
</div>
</div>
</div>
<div class="paragraph">
<p>This means that :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>for an object <code>A</code> in one category, there is a corresponding object <code>F A</code> in the second one.</p>
</li>
<li>
<p>for a morphism (A &#8594; B), there is the corresponding F A &#8594; F B</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In Haskell, the objects are types and the mappings are functions. Type constructors (* &#8594; *) are used to map types into types.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-kr">class</span> <span class="tok-kt">Functor</span> <span class="tok-n">f</span> <span class="tok-kr">where</span>
	<span class="tok-n">fmap</span> <span class="tok-ow">::</span> <span class="tok-p">(</span><span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">b</span><span class="tok-p">)</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">f</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">f</span> <span class="tok-n">b</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The functor defines the action of an arbitrary function (a &#8594; b) on a structure (f a) of elements of type a resulting in the same structure but full of elements of type b.</p>
</div>
<div class="exampleblock">
<div class="title">Laws:</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-nf">fmap</span> <span class="tok-n">id</span> <span class="tok-ow">=</span> <span class="tok-n">id</span>

<span class="tok-nf">fmap</span> <span class="tok-p">(</span><span class="tok-n">g</span> <span class="tok-o">.</span> <span class="tok-n">h</span><span class="tok-p">)</span> <span class="tok-ow">=</span> <span class="tok-n">fmap</span> <span class="tok-n">g</span> <span class="tok-o">.</span> <span class="tok-n">fmap</span> <span class="tok-n">h</span></code></pre>
</div>
</div>
</div>
</div>
<div class="listingblock">
<div class="title">Example:</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-kr">instance</span> <span class="tok-kt">Functor</span> <span class="tok-p">((</span><span class="tok-ow">-&gt;</span><span class="tok-p">)</span> <span class="tok-n">r</span><span class="tok-p">)</span> <span class="tok-kr">where</span>
  <span class="tok-n">fmap</span> <span class="tok-n">f</span> <span class="tok-n">g</span> <span class="tok-ow">=</span> <span class="tok-n">f</span> <span class="tok-o">.</span> <span class="tok-n">g</span> <span class="tok-c1">-- or fmap = (.)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Another intuition is to look at functors as producers of output that can have its type adapted. So <code>Maybe a</code> represents an output of type a that might be present (Just a) or absent (Nothing). <code>fmap f</code> allows us to adapt the output of type a to an output of type b.</p>
</div>
<div class="paragraph">
<p>Whenever you have producer of outputs, you might also have the dual consumer of inputs. This is where Contravariant comes in. The intuition behind a Contravariant is that it reflects a sort of "consumer of input" that can have the type of accepted input adapted.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-kr">class</span> <span class="tok-kt">Contravariant</span> <span class="tok-n">f</span> <span class="tok-kr">where</span>
  <span class="tok-n">contramap</span> <span class="tok-ow">::</span> <span class="tok-p">(</span><span class="tok-n">b</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">a</span><span class="tok-p">)</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">f</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">f</span> <span class="tok-n">b</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So here we can adapt the <strong>input</strong> to go from a consumer of input 'a' to a consumer of input 'b'. But to go there you need to provide a function from 'b' to 'a'</p>
</div>
</div>
<div class="sect3">
<h4 id="_isomorphisms">Isomorphisms</h4>
<div class="paragraph">
<p>Category theory allows us to give a precise, abstract (works for all categories) and self-contained definition of an isomorphism:</p>
</div>
<div class="paragraph">
<p>An arrow/morphism f: A &#8594; B is called an isomorphism in <strong>C</strong> if there is an arrow g that goes from B to A such that:<br>
g ∘ f = 1A and f ∘ g = 1B</p>
</div>
</div>
<div class="sect3">
<h4 id="_applicative">Applicative</h4>
<div class="paragraph">
<p>With a functor f it is not possible to apply a function wrapped by the structure <code>f</code> to a value wrapped by f. This is given by Applicative:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-kr">class</span> <span class="tok-kt">Functor</span> <span class="tok-n">f</span> <span class="tok-ow">=&gt;</span> <span class="tok-kt">Applicative</span> <span class="tok-n">f</span> <span class="tok-kr">where</span>
  <span class="tok-n">pure</span> <span class="tok-ow">::</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">f</span> <span class="tok-n">a</span>
 <span class="tok-p">(</span><span class="tok-o">&lt;*&gt;</span><span class="tok-p">)</span> <span class="tok-ow">::</span> <span class="tok-n">f</span> <span class="tok-p">(</span><span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">b</span><span class="tok-p">)</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">f</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">f</span> <span class="tok-n">b</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><mark>&lt;*&gt;</mark> is just function application within a computational context.</p>
</div>
<div class="paragraph">
<p>As soon as you want to define the type <code>(a &#8594; b &#8594; c) &#8594; f a &#8594; f b &#8594; f c</code> you need the applicative construction:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-nf">liftA2</span> <span class="tok-ow">::</span> <span class="tok-kt">Applicative</span> <span class="tok-n">f</span> <span class="tok-ow">=&gt;</span> <span class="tok-p">(</span><span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">b</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">c</span><span class="tok-p">)</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">f</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">f</span> <span class="tok-n">b</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">f</span> <span class="tok-n">c</span>
<span class="tok-nf">liftA2</span> <span class="tok-n">f</span> <span class="tok-n">a</span> <span class="tok-n">b</span> <span class="tok-ow">=</span> <span class="tok-n">fmap</span> <span class="tok-n">f</span> <span class="tok-n">a</span> <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">b</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It is not that hard to convince yourself that an applicative functor is just a functor that knows how to lift functions of arbitrary arities.</p>
</div>
<div class="exampleblock">
<div class="title">Law</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-nf">fmap</span> <span class="tok-n">g</span> <span class="tok-n">x</span> <span class="tok-ow">=</span> <span class="tok-n">pure</span> <span class="tok-n">g</span> <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">x</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Applicative functors are to be preferred to monads when the structure of a computation is fixed a priori.
That makes it possible to perform certain kinds of static analysis on applicative values.</p>
</div>
<div class="sect4">
<h5 id="_alternative">Alternative</h5>
<div class="paragraph">
<p>An Alternative instance gives an applicative functor the structure of a monoid,
with <mark>empty</mark> as the unit element, and <mark>&lt;|&gt;</mark> as the binary operation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-kr">class</span> <span class="tok-kt">Applicative</span> <span class="tok-n">f</span> <span class="tok-ow">=&gt;</span> <span class="tok-kt">Alternative</span> <span class="tok-n">f</span> <span class="tok-kr">where</span>
  <span class="tok-n">empty</span> <span class="tok-ow">::</span> <span class="tok-n">f</span> <span class="tok-n">a</span>
 <span class="tok-p">(</span><span class="tok-o">&lt;|&gt;</span><span class="tok-p">)</span> <span class="tok-ow">::</span> <span class="tok-n">f</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">f</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">f</span> <span class="tok-n">a</span></code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><mark>asum</mark></dt>
<dd>
<p>give you the first successful computation or the last zero value. With failures, it really disregards them striving for success. It is defined as:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-nf">asum</span> <span class="tok-ow">=</span> <span class="tok-n">foldr</span> <span class="tok-p">(</span><span class="tok-o">&lt;|&gt;</span><span class="tok-p">)</span> <span class="tok-n">empty</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="shell"><span></span>→ asum [Just 1, Just 2, Nothing]              -&gt; Just 1
→ asum [Left &quot;Failing&quot;, Right()]              -&gt; Right ()
→ asum [Left &quot;Failing&quot;, Left &quot;Failing again&quot;] -&gt; Left &quot;Failing again&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that some monad such as ExceptT are appending (using the monoid instance) the error messages (the <code>Monoid m &#8658; Left m</code>)  when using <code>asum</code> or <code>msum</code>.</p>
</div>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>MonadPlus</code> together with <code>mzero</code>, <code>mplus</code> and <code>msum</code> are the monadic equivalents. Since 7.10, all MonadPlus are Alternative (likewise all monads are applicatives).
so you whould avoid using these and prefer empty, (&lt;|&gt;) and asum.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_monad">Monad</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-kr">class</span> <span class="tok-kt">Applicative</span> <span class="tok-n">m</span> <span class="tok-ow">=&gt;</span> <span class="tok-kt">Monad</span> <span class="tok-n">m</span> <span class="tok-kr">where</span>
  <span class="tok-n">join</span> <span class="tok-ow">::</span> <span class="tok-n">m</span> <span class="tok-p">(</span><span class="tok-n">m</span> <span class="tok-n">a</span><span class="tok-p">)</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">m</span> <span class="tok-n">a</span>

<span class="tok-p">(</span><span class="tok-o">&gt;&gt;=</span><span class="tok-p">)</span> <span class="tok-ow">::</span> <span class="tok-n">m</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-p">(</span><span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">m</span> <span class="tok-n">b</span><span class="tok-p">)</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">m</span> <span class="tok-n">b</span> <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The signature of <code>bind</code> allows the second computation to depend on the value of the first one.</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="content">
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Monadic values are produced in a context. Monads provide both substitution (fmap) and renormalization (join).</p>
</div>
</blockquote>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-nf">m</span> <span class="tok-o">&gt;&gt;=</span> <span class="tok-n">f</span> <span class="tok-ow">=</span> <span class="tok-n">join</span> <span class="tok-p">(</span><span class="tok-n">fmap</span> <span class="tok-n">f</span> <span class="tok-n">m</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Even if a monad is strictly more powerful than an Applicative, there are situations for which an applicative is the only valid choice.
Indeed <code>&lt;*&gt;</code> lets you explore both arguments by pattern matching but with <code>ap</code> the right hand side cannot be evaluated without the result from the left.</p>
</div>
<div class="paragraph">
<p>As a stretch while applicative allows for parallelism, monad allows for sequencing.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>A monad is like a monoid where we combine functors "vertically". <code>join</code> is analogous to <code>(+)</code> and <code>return</code> to <code>0</code>.</p>
</div>
</blockquote>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
By law <code>&gt;&gt;</code> = <code>*&gt;</code>. Consequently <code>mapM_</code> =  <code>traverse_</code>.
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>Side-Effect</p>
</li>
<li>
<p>Environment</p>
</li>
<li>
<p>Error</p>
</li>
<li>
<p>Indeterminism</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_free">Free</h4>
<div class="paragraph">
<p>A free construction is a real instance of that construction that hold no extra property. It is the least special possible instance.
A free monad is just substitution (fmap) with the minimum amount of renormalization needed to pass the monad laws.</p>
</div>
<div class="paragraph">
<p>It is perfect to separate syntax (data, ast, parsing) from semantics (interpretation)</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>The free monad is guaranteed to be the formulation that gives you the most flexibility how to interpret it, since it is purely syntactic.</p>
</div>
</blockquote>
</div>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-kr">data</span> <span class="tok-kt">Free</span> <span class="tok-n">f</span> <span class="tok-n">a</span> <span class="tok-ow">=</span> <span class="tok-kt">Pure</span> <span class="tok-n">a</span> <span class="tok-o">|</span> <span class="tok-kt">Free</span> <span class="tok-p">(</span><span class="tok-n">f</span> <span class="tok-p">(</span><span class="tok-kt">Free</span> <span class="tok-n">f</span> <span class="tok-n">a</span><span class="tok-p">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The fixed point of a function is generally just the repeated application of that function:
fix f = f (f (f (f (f (f (f (f (f (f (f (f (f &#8230;&#8203; ))))))))))))
or
fix f = f (fix f)</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>A Monad n is a free Monad for f if every Monad homomorphism from n to another monad m is equivalent to a natural transformation from f to m.</p>
</div>
</blockquote>
</div>
</div>
<div class="sect3">
<h4 id="_existential_classes">Existential classes</h4>
<div class="exampleblock">
<div class="content">
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>When someone defines a universal type ∀X they&#8217;re saying: you can plug in whatever type you want, I don&#8217;t need to know anything about the type to do my job, I&#8217;ll only refer to it opaquely as X.</p>
</div>
<div class="paragraph">
<p>When someone defines an existential type ∃X they&#8217;re saying: I&#8217;ll use whatever type I want here; you won&#8217;t know anything about the type, so you can only refer to it opaquely as X</p>
</div>
</blockquote>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_bytestring">ByteString</h4>
<div class="ulist">
<ul>
<li>
<p>Word8 is Haskell&#8217;s standard representation of a byte</p>
</li>
<li>
<p>ByeString character functions (<code>Data.ByteString.Char8</code>) only work with ASCII text, hence the Char8 in the package name
&#8594; if you are working with unicode, you should use the Text package</p>
</li>
<li>
<p>In general we use strict bytestring when you have control about the message. Lazy bytestring is a bit more flexible and used for streaming.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="https://www.fpcomplete.com/school/pick-of-the-week/bytestring-bits-and-pieces?show=tutorials">FP tutorial</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_lazyness">Lazyness</h4>
<div class="paragraph">
<p>Reduction is done using outermost reduction. For instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-nf">loop</span> <span class="tok-ow">=</span> <span class="tok-n">tail</span> <span class="tok-n">loop</span>

<span class="tok-nf">fst</span> <span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-n">loop</span><span class="tok-p">)</span>
<span class="tok-c1">-- innermost reduction gives:</span>
<span class="tok-c1">-- fst (1, (tail loop))</span>
<span class="tok-c1">-- fst (1, (tail (tail loop))) and never terminates</span>
<span class="tok-c1">-- but outermost reduction gives:</span>
<span class="tok-c1">-- fst (1, loop) = 1 and terminates</span></code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_redex">Redex</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-c1">-- only one redex (2*3) both innermost and outermost</span>
<span class="tok-mi">1</span> <span class="tok-o">+</span> <span class="tok-p">(</span><span class="tok-mi">2</span> <span class="tok-o">*</span> <span class="tok-mi">3</span><span class="tok-p">)</span>

<span class="tok-c1">-- 2 redexes :</span>
<span class="tok-c1">-- (\x -&gt; 1 + x ) (2 * 3) outermost</span>
<span class="tok-c1">-- (2 * 3) innermost</span>
<span class="tok-p">(</span><span class="tok-nf">\</span><span class="tok-n">x</span> <span class="tok-ow">-&gt;</span> <span class="tok-mi">1</span> <span class="tok-o">+</span> <span class="tok-n">x</span> <span class="tok-p">)</span> <span class="tok-p">(</span><span class="tok-mi">2</span> <span class="tok-o">*</span> <span class="tok-mi">3</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_mind_blowing">Mind blowing</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-kr">instance</span> <span class="tok-kt">Monoid</span> <span class="tok-n">r</span> <span class="tok-ow">=&gt;</span> <span class="tok-kt">Monoid</span> <span class="tok-p">(</span><span class="tok-kt">Managed</span> <span class="tok-n">r</span><span class="tok-p">)</span> <span class="tok-kr">where</span>
    <span class="tok-n">mempty</span> <span class="tok-ow">=</span> <span class="tok-n">pure</span> <span class="tok-n">mempty</span>
    <span class="tok-n">mappend</span> <span class="tok-ow">=</span> <span class="tok-n">liftA2</span> <span class="tok-n">mappend</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-nf">xs</span> <span class="tok-ow">=</span> <span class="tok-mi">1</span> <span class="tok-kt">:</span> <span class="tok-p">[</span><span class="tok-n">x</span> <span class="tok-o">+</span> <span class="tok-mi">1</span> <span class="tok-o">|</span> <span class="tok-n">x</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">xs</span><span class="tok-p">]</span> <span class="tok-o">--&gt;</span> <span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">,</span><span class="tok-mi">2</span><span class="tok-p">,</span><span class="tok-mi">3</span> <span class="tok-o">...</span><span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-kt">Right</span> <span class="tok-n">cfg</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">return</span> <span class="tok-o">.</span> <span class="tok-kt">Right</span> <span class="tok-o">.</span> <span class="tok-n">query</span> <span class="tok-n">cfg</span> <span class="tok-n">fp</span> <span class="tok-o">=&lt;&lt;</span> <span class="tok-kt">F</span><span class="tok-o">.</span><span class="tok-n">newFileCache</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ui">UI</h4>
<div class="ulist">
<ul>
<li>
<p>HsQML (qt 5)</p>
</li>
<li>
<p>SDL2/gl for game</p>
</li>
<li>
<p>Web (ghcjs, threepenny, &#8230;&#8203;)</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_pitfall">Pitfall</h4>
<div class="paragraph">
<p><mark>(++)</mark> needs to reconstruct the list on the left !</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="shell"><span></span># ! inefficient !
→ [1..10000] ++ [4]</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_useful">Useful</h4>
<div class="paragraph">
<p><code>-fdefer-type-errors</code></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_fold_and_traverse">Fold and Traverse</h3>
<div class="sect3">
<h4 id="_introduction">Introduction</h4>
<div class="paragraph">
<p>Folding is the act of reducing a structure to a single value.</p>
</div>
<div class="paragraph">
<p>We can see them as consumers or <code>comonads</code>.<sup class="footnote">[<a id="_footnoteref_4" class="footnote" href="#_footnote_4" title="View footnote.">4</a>]</sup></p>
</div>
</div>
<div class="sect3">
<h4 id="_foldl_foldr">foldl/foldr</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-nf">foldr</span> <span class="tok-ow">::</span> <span class="tok-p">(</span><span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">b</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">b</span><span class="tok-p">)</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">b</span> <span class="tok-ow">-&gt;</span> <span class="tok-p">[</span><span class="tok-n">a</span><span class="tok-p">]</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">b</span>
<span class="tok-nf">foldr</span> <span class="tok-n">f</span> <span class="tok-n">v</span> <span class="tok-kt">[]</span> <span class="tok-ow">=</span> <span class="tok-n">v</span>
<span class="tok-nf">foldr</span> <span class="tok-n">f</span> <span class="tok-n">v</span> <span class="tok-p">(</span><span class="tok-n">x</span><span class="tok-kt">:</span><span class="tok-n">xs</span><span class="tok-p">)</span> <span class="tok-ow">=</span> <span class="tok-n">f</span> <span class="tok-n">x</span> <span class="tok-p">(</span><span class="tok-n">foldr</span> <span class="tok-n">f</span> <span class="tok-n">v</span> <span class="tok-n">xs</span><span class="tok-p">)</span>

<span class="tok-nf">foldl</span> <span class="tok-ow">::</span> <span class="tok-p">(</span><span class="tok-n">s</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">s</span><span class="tok-p">)</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">s</span> <span class="tok-ow">-&gt;</span> <span class="tok-p">[</span><span class="tok-n">a</span><span class="tok-p">]</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">s</span>
<span class="tok-nf">foldl</span>  <span class="tok-n">f</span> <span class="tok-n">v</span> <span class="tok-kt">[]</span>     <span class="tok-ow">=</span>  <span class="tok-n">v</span>
<span class="tok-nf">foldl</span>  <span class="tok-n">f</span> <span class="tok-n">v</span> <span class="tok-p">(</span><span class="tok-n">x</span><span class="tok-kt">:</span><span class="tok-n">xs</span><span class="tok-p">)</span> <span class="tok-ow">=</span>  <span class="tok-n">foldl</span> <span class="tok-n">f</span> <span class="tok-p">(</span><span class="tok-n">f</span> <span class="tok-n">v</span> <span class="tok-n">x</span><span class="tok-p">)</span> <span class="tok-n">xs</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Both functions take 3 arguments:
- a combining function 'f'
- a default value 'v'
- the data to be folded.</p>
</div>
<div class="paragraph">
<p>The default value 'v' deals with the empty element of the list <mark>[]</mark>. For non empty list, <code>foldl1/foldr1</code> is best suited.</p>
</div>
<div class="sect4">
<h5 id="_foldr">foldr</h5>
<div class="paragraph">
<p>You can think of <code>foldr</code> <strong>non-recursively</strong> as simultaneously replacing each (:) in a list by a given function, and [] by a given value:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-nf">foldr</span> <span class="tok-p">(</span><span class="tok-o">-</span><span class="tok-p">)</span> <span class="tok-mi">0</span> <span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-kt">:</span><span class="tok-mi">2</span><span class="tok-kt">:</span><span class="tok-mi">3</span><span class="tok-kt">:[]</span><span class="tok-p">)</span> <span class="tok-ow">=</span> <span class="tok-p">(</span><span class="tok-mi">1</span> <span class="tok-o">-</span> <span class="tok-p">(</span> <span class="tok-mi">2</span> <span class="tok-o">-</span> <span class="tok-p">(</span><span class="tok-mi">3</span> <span class="tok-o">-</span> <span class="tok-mi">0</span><span class="tok-p">)))</span> <span class="tok-ow">=</span> <span class="tok-p">(</span><span class="tok-mi">1</span> <span class="tok-o">-</span> <span class="tok-p">(</span><span class="tok-mi">2</span> <span class="tok-o">-</span> <span class="tok-mi">3</span><span class="tok-p">)</span> <span class="tok-ow">=</span> <span class="tok-p">(</span><span class="tok-mi">1</span> <span class="tok-o">-</span> <span class="tok-p">(</span> <span class="tok-o">-</span><span class="tok-mi">1</span> <span class="tok-p">)</span> <span class="tok-ow">=</span> <span class="tok-mi">2</span></code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="img/right-fold-transformation.png" alt="Foldr">
</div>
</div>
<div class="paragraph">
<p><code>Foldr</code> is handy if <code>f</code> is <strong>not</strong> strict in both arguments. That way we can rely on laziness to stop the recursion (or build an infinite list).
<code>Map</code> for instance has to use <code>foldr</code> to maintain its laziness capabilities:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-nf">map</span> <span class="tok-ow">=</span> <span class="tok-n">foldr</span> <span class="tok-p">(</span><span class="tok-nf">\</span><span class="tok-n">x</span> <span class="tok-n">ys</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">f</span> <span class="tok-n">x</span> <span class="tok-kt">:</span> <span class="tok-n">ys</span><span class="tok-p">)</span> <span class="tok-kt">[]</span>
<span class="tok-c1">-- or map&#39; = foldr ((:) . f) []</span>

<span class="tok-c1">-- of course it can also be defined with recursion only</span>
<span class="tok-nf">map&#39;</span> <span class="tok-ow">::</span> <span class="tok-p">(</span><span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">b</span><span class="tok-p">)</span> <span class="tok-ow">-&gt;</span> <span class="tok-p">[</span><span class="tok-n">a</span><span class="tok-p">]</span> <span class="tok-ow">-&gt;</span> <span class="tok-p">[</span><span class="tok-n">b</span><span class="tok-p">]</span>
<span class="tok-nf">map&#39;</span> <span class="tok-kr">_</span> <span class="tok-kt">[]</span> <span class="tok-ow">=</span> <span class="tok-kt">[]</span>
<span class="tok-nf">map&#39;</span> <span class="tok-n">f</span> <span class="tok-p">(</span><span class="tok-n">x</span><span class="tok-kt">:</span><span class="tok-n">xs</span><span class="tok-p">)</span> <span class="tok-ow">=</span> <span class="tok-n">f</span> <span class="tok-n">x</span> <span class="tok-kt">:</span> <span class="tok-p">(</span><span class="tok-n">map</span> <span class="tok-n">f</span> <span class="tok-n">xs</span><span class="tok-p">)</span>

<span class="tok-c1">-- ex</span>
<span class="tok-nf">takeWhile</span> <span class="tok-p">(</span><span class="tok-o">&lt;</span> <span class="tok-mi">12</span><span class="tok-p">)</span> <span class="tok-o">$</span> <span class="tok-n">map</span> <span class="tok-p">(</span><span class="tok-o">*</span><span class="tok-mi">2</span><span class="tok-p">)</span> <span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-o">..</span><span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_foldl">foldl</h5>
<div class="paragraph">
<p>On the other hand, when the whole list needs to be traversed (<code>sum</code> or <code>reverse</code> are two examples), <code>foldl'</code> is actually more efficient in term of memory space.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-nf">foldl</span> <span class="tok-p">(</span><span class="tok-o">-</span><span class="tok-p">)</span> <span class="tok-mi">0</span> <span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-kt">:</span><span class="tok-mi">2</span><span class="tok-kt">:</span><span class="tok-mi">3</span><span class="tok-kt">:[]</span><span class="tok-p">)</span> <span class="tok-ow">=</span> <span class="tok-p">(</span><span class="tok-mi">0</span> <span class="tok-o">-</span> <span class="tok-mi">1</span><span class="tok-p">)</span> <span class="tok-o">-</span> <span class="tok-mi">2</span> <span class="tok-o">-</span> <span class="tok-mi">3</span> <span class="tok-ow">=</span> <span class="tok-o">-</span><span class="tok-mi">6</span>

<span class="tok-nf">reverse</span> <span class="tok-ow">=</span> <span class="tok-n">foldl&#39;</span> <span class="tok-p">(</span><span class="tok-n">flip</span> <span class="tok-p">(</span><span class="tok-kt">:</span><span class="tok-p">))</span> <span class="tok-kt">[]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The strict version <code>List.foldl'</code> should always be used instead of the foldl from Prelude. The <code>Foldable</code> type class comes with <code>foldl</code> defined strictly.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="img/left-fold-transformation.png" alt="Foldl">
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_foldl_package">Foldl package</h4>
<div class="paragraph">
<p>To get a better representation for fold we need to transform the function into data.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-cm">{-# LANGUAGE ExistentialQuantification #-}</span>
<span class="tok-c1">-- existential datatype (note that `x` does not appear on the left side)</span>
<span class="tok-kr">data</span> <span class="tok-kt">Fold</span> <span class="tok-n">a</span> <span class="tok-n">b</span>
<span class="tok-c1">--                    step func      initial acc     extract func (done)</span>
 <span class="tok-ow">=</span> <span class="tok-n">forall</span> <span class="tok-n">x</span> <span class="tok-o">.</span> <span class="tok-kt">Fold</span>  <span class="tok-p">(</span><span class="tok-n">x</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">x</span><span class="tok-p">)</span>       <span class="tok-n">x</span>             <span class="tok-p">(</span><span class="tok-n">x</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">b</span><span class="tok-p">)</span>

<span class="tok-c1">-- expressed as a GADT it would be:</span>
<span class="tok-kr">data</span> <span class="tok-kt">Fold</span> <span class="tok-n">a</span> <span class="tok-n">b</span> <span class="tok-kr">where</span>
  <span class="tok-kt">Fold</span> <span class="tok-ow">::</span> <span class="tok-p">(</span><span class="tok-n">r</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">b</span><span class="tok-p">)</span> <span class="tok-ow">-&gt;</span> <span class="tok-p">(</span><span class="tok-n">r</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">r</span><span class="tok-p">)</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">r</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Fold</span> <span class="tok-n">a</span> <span class="tok-n">b</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Fold</code> is a functor, a monoid and an applicative.
It is  also a profunctor and a comonad.
It is actually isomorphic to a Moore machine (see <a href="https://www.fpcomplete.com/school/to-infinity-and-beyond/pick-of-the-week/part-2" class="bare">https://www.fpcomplete.com/school/to-infinity-and-beyond/pick-of-the-week/part-2</a>)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-c1">-- | Apply a strict left &#39;Fold&#39; to a &#39;Foldable&#39; container</span>
<span class="tok-nf">fold</span> <span class="tok-ow">::</span> <span class="tok-kt">Foldable</span> <span class="tok-n">f</span> <span class="tok-ow">=&gt;</span> <span class="tok-kt">Fold</span> <span class="tok-n">a</span> <span class="tok-n">b</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">f</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">b</span>
<span class="tok-nf">fold</span> <span class="tok-p">(</span><span class="tok-kt">Fold</span> <span class="tok-n">step</span> <span class="tok-n">begin</span> <span class="tok-n">done</span><span class="tok-p">)</span> <span class="tok-n">as</span> <span class="tok-ow">=</span> <span class="tok-kt">F</span><span class="tok-o">.</span><span class="tok-n">foldr</span> <span class="tok-n">cons</span> <span class="tok-n">done</span> <span class="tok-n">as</span> <span class="tok-n">begin</span>
  <span class="tok-kr">where</span>
    <span class="tok-n">cons</span> <span class="tok-n">a</span> <span class="tok-n">k</span> <span class="tok-n">x</span> <span class="tok-ow">=</span> <span class="tok-n">k</span> <span class="tok-o">$!</span> <span class="tok-n">step</span> <span class="tok-n">x</span> <span class="tok-n">a</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This makes it possible to define cleanly the function <code>average</code> without traversing twice the foldable container.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-nf">average</span> <span class="tok-ow">=</span> <span class="tok-p">(</span><span class="tok-o">/</span><span class="tok-p">)</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">sum</span> <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">genericLength</span>

<span class="tok-nf">sum</span> <span class="tok-ow">::</span> <span class="tok-kt">Num</span> <span class="tok-n">a</span> <span class="tok-ow">=&gt;</span> <span class="tok-kt">Fold</span> <span class="tok-n">a</span> <span class="tok-n">a</span>
<span class="tok-nf">sum</span> <span class="tok-ow">=</span> <span class="tok-kt">Fold</span> <span class="tok-p">(</span><span class="tok-o">+</span><span class="tok-p">)</span> <span class="tok-mi">0</span> <span class="tok-n">id</span>

<span class="tok-nf">genericLength</span> <span class="tok-ow">::</span> <span class="tok-kt">Num</span> <span class="tok-n">b</span> <span class="tok-ow">=&gt;</span> <span class="tok-kt">Fold</span> <span class="tok-n">a</span> <span class="tok-n">b</span>
<span class="tok-nf">genericLength</span> <span class="tok-ow">=</span> <span class="tok-kt">Fold</span> <span class="tok-p">(</span><span class="tok-nf">\</span><span class="tok-n">n</span> <span class="tok-kr">_</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">n</span> <span class="tok-o">+</span> <span class="tok-mi">1</span><span class="tok-p">)</span> <span class="tok-mi">0</span> <span class="tok-n">id</span>

<span class="tok-nf">λ</span><span class="tok-o">&gt;</span> <span class="tok-n">fold</span> <span class="tok-n">average</span> <span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-o">..</span><span class="tok-mi">10000000</span><span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>Fold</code> is also a profunctor and a comonad.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_alternative_monoid_definition">Alternative monoid definition</h5>
<div class="paragraph">
<p>As explained in <a href="https://github.com/Gabriel439/slides/blob/master/munihac/foldmap.md">Gabriel&#8217;s beautiful fold talk</a>, <mark>Fold</mark> can similarly be defined as</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-kr">data</span> <span class="tok-kt">Fold</span> <span class="tok-n">i</span> <span class="tok-n">o</span> <span class="tok-ow">=</span> <span class="tok-n">forall</span> <span class="tok-n">m</span> <span class="tok-o">.</span> <span class="tok-kt">Monoid</span> <span class="tok-n">m</span> <span class="tok-ow">=&gt;</span> <span class="tok-kt">Fold</span> <span class="tok-p">(</span><span class="tok-n">i</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">m</span><span class="tok-p">)</span> <span class="tok-p">(</span><span class="tok-n">m</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">o</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This approach can express parallel computation but it won&#8217;t encode stateful folds.</p>
</div>
</div>
<div class="sect4">
<h5 id="_foldm">FoldM</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-kr">data</span> <span class="tok-kt">FoldM</span> <span class="tok-n">m</span> <span class="tok-n">a</span> <span class="tok-n">b</span> <span class="tok-ow">=</span>
  <span class="tok-c1">-- | @FoldM @ @ step @ @ initial @ @ extract@</span>
  <span class="tok-n">forall</span> <span class="tok-n">x</span> <span class="tok-o">.</span> <span class="tok-kt">FoldM</span> <span class="tok-p">(</span><span class="tok-n">x</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">m</span> <span class="tok-n">x</span><span class="tok-p">)</span> <span class="tok-p">(</span><span class="tok-n">m</span> <span class="tok-n">x</span><span class="tok-p">)</span> <span class="tok-p">(</span><span class="tok-n">x</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">m</span> <span class="tok-n">b</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Fold</code> is equivalent to <code>FoldM Identity</code>.
You use <code>generalize</code> (with no performance penalty) to get a <code>FoldM</code> from a <code>Fold</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-nf">generalize</span> <span class="tok-ow">::</span> <span class="tok-kt">Monad</span> <span class="tok-n">m</span> <span class="tok-ow">=&gt;</span> <span class="tok-kt">Fold</span> <span class="tok-n">a</span> <span class="tok-n">b</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">FoldM</span> <span class="tok-n">m</span> <span class="tok-n">a</span> <span class="tok-n">b</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In the <code>turtle</code> library, <code>FoldM</code> plays the role of a consumer and <code>Shell</code> the role of a Producer. <code>fold</code> is how you connect them together.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_foldable_traversable">Foldable/Traversable</h4>
<div class="dlist">
<dl>
<dt class="hdlist1">Fold</dt>
<dd>
<p><code>fold</code> from the <code>foldl</code> take as an argument any <code>Foldable</code> structure. <code>Foldable</code> are structures that we can <strong>reduce</strong> into a single result.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-kr">class</span> <span class="tok-kt">Foldable</span> <span class="tok-n">t</span> <span class="tok-kr">where</span>
  <span class="tok-n">fold</span>    <span class="tok-ow">::</span> <span class="tok-kt">Monoid</span> <span class="tok-n">m</span> <span class="tok-ow">=&gt;</span> <span class="tok-n">t</span> <span class="tok-n">m</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">m</span>
  <span class="tok-n">foldMap</span> <span class="tok-ow">::</span> <span class="tok-kt">Monoid</span> <span class="tok-n">m</span> <span class="tok-ow">=&gt;</span> <span class="tok-p">(</span><span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">m</span><span class="tok-p">)</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">t</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">m</span>
  <span class="tok-n">foldMap</span> <span class="tok-n">g</span> <span class="tok-ow">=</span> <span class="tok-n">mconcat</span> <span class="tok-o">.</span> <span class="tok-n">map</span> <span class="tok-n">g</span>

<span class="tok-nf">λ</span><span class="tok-o">&gt;</span> <span class="tok-n">foldMap</span> <span class="tok-kt">Sum</span> <span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">,</span><span class="tok-mi">2</span><span class="tok-p">,</span><span class="tok-mi">3</span><span class="tok-p">,</span><span class="tok-mi">4</span><span class="tok-p">]</span>
<span class="tok-kt">Sum</span> <span class="tok-p">{</span><span class="tok-n">getSum</span> <span class="tok-ow">=</span> <span class="tok-mi">10</span><span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>fold</code> and <code>foldMap</code> require the elements of the Foldable to be monoids.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In Data.Foldable, mapM is defined with foldr (which is kind of mind blowing)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-nf">mapM_</span> <span class="tok-ow">::</span> <span class="tok-p">(</span><span class="tok-kt">Foldable</span> <span class="tok-n">t</span><span class="tok-p">,</span> <span class="tok-kt">Monad</span> <span class="tok-n">m</span><span class="tok-p">)</span> <span class="tok-ow">=&gt;</span> <span class="tok-p">(</span><span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">m</span> <span class="tok-n">b</span><span class="tok-p">)</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">t</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">m</span> <span class="tok-nb">()</span>
<span class="tok-nf">mapM_</span> <span class="tok-n">f</span> <span class="tok-ow">=</span> <span class="tok-n">foldr</span> <span class="tok-p">((</span><span class="tok-o">&gt;&gt;</span><span class="tok-p">)</span> <span class="tok-o">.</span> <span class="tok-n">f</span><span class="tok-p">)</span> <span class="tok-p">(</span><span class="tok-n">return</span> <span class="tok-nb">()</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Traversable</dt>
<dd>
<p>When you traverse a structure you actually want to keep it intact.
The function <code>traverse</code> is exactly <code>mapM</code> generalized for all <code>Foldable`s</code>. Traversable applies any applicative effect; traverse is an "effectful" fmap.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-kr">class</span> <span class="tok-p">(</span><span class="tok-kt">Functor</span> <span class="tok-n">t</span><span class="tok-p">,</span> <span class="tok-kt">Foldable</span> <span class="tok-n">t</span><span class="tok-p">)</span> <span class="tok-ow">=&gt;</span> <span class="tok-kt">Traversable</span> <span class="tok-n">t</span> <span class="tok-kr">where</span>
  <span class="tok-n">traverse</span>  <span class="tok-ow">::</span> <span class="tok-kt">Applicative</span> <span class="tok-n">f</span> <span class="tok-ow">=&gt;</span> <span class="tok-p">(</span><span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">f</span> <span class="tok-n">b</span><span class="tok-p">)</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">t</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">f</span> <span class="tok-p">(</span><span class="tok-n">t</span> <span class="tok-n">b</span><span class="tok-p">)</span>
  <span class="tok-n">traverse</span> <span class="tok-n">f</span> <span class="tok-ow">=</span> <span class="tok-n">sequenceA</span> <span class="tok-o">.</span> <span class="tok-n">fmap</span> <span class="tok-n">f</span>
  <span class="tok-n">mapM</span> <span class="tok-ow">=</span> <span class="tok-n">traverse</span>
  <span class="tok-n">sequenceA</span> <span class="tok-ow">::</span> <span class="tok-kt">Applicative</span> <span class="tok-n">f</span> <span class="tok-ow">=&gt;</span> <span class="tok-n">t</span> <span class="tok-p">(</span><span class="tok-n">f</span> <span class="tok-n">a</span><span class="tok-p">)</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">f</span> <span class="tok-p">(</span><span class="tok-n">t</span> <span class="tok-n">a</span><span class="tok-p">)</span>
  <span class="tok-n">sequenceA</span> <span class="tok-ow">=</span> <span class="tok-n">traverse</span> <span class="tok-n">id</span>

<span class="tok-nf">for</span> <span class="tok-ow">=</span> <span class="tok-n">flip</span> <span class="tok-n">traverse</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_lenses">Lenses</h3>
<div class="sect3">
<h4 id="_usage">Usage</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-cm">{-# LANGUAGE TemplateHaskell #-}</span>

<span class="tok-kr">data</span> <span class="tok-kt">Person</span> <span class="tok-ow">=</span> <span class="tok-kt">Person</span>
  <span class="tok-p">{</span> <span class="tok-n">_firstname</span> <span class="tok-ow">::</span> <span class="tok-kt">String</span>
  <span class="tok-p">,</span> <span class="tok-n">_surname</span>   <span class="tok-ow">::</span> <span class="tok-kt">String</span>
  <span class="tok-p">}</span>
<span class="tok-c1">-- building lenses for _firstname and _surname</span>
<span class="tok-nf">makeLenses</span> <span class="tok-kt">&#39;&#39;Person</span>
<span class="tok-c1">-- create an HasPerson class with the `firstname` and `surname` optics</span>
<span class="tok-nf">makeClassy</span> <span class="tok-kt">&#39;&#39;Person</span>
<span class="tok-c1">-- create an HasFirstname and HasSurname class</span>
<span class="tok-kr">data</span> <span class="tok-kt">Person</span> <span class="tok-ow">=</span> <span class="tok-kt">Person</span>
  <span class="tok-p">{</span> <span class="tok-n">_PersonFirstname</span> <span class="tok-ow">::</span> <span class="tok-kt">String</span>
  <span class="tok-p">,</span> <span class="tok-n">_PersonSurname</span>   <span class="tok-ow">::</span> <span class="tok-kt">String</span>
  <span class="tok-p">}</span>
<span class="tok-nf">makeField</span> <span class="tok-kt">&#39;&#39;Person</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_lens">Lens</h4>
<div class="paragraph">
<p>A lens is a first-class reference to a subpart of some data type.</p>
</div>
<div class="paragraph">
<p><code>Lens' s a</code> operates on a container <code>s</code> and put the focus on 'a'.
<code>Lens' s t a b</code> when you replace <code>a</code> in <code>s</code> with <code>b</code>, its type changes to <code>t</code>.</p>
</div>
<div class="paragraph">
<p>Note that lenses are not <code>accessors</code> but <code>focusers</code>. It focus on a particular location of a structure. These are the types we want for <code>view</code>, <code>set</code> and <code>over/update</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-nf">view</span> <span class="tok-ow">::</span> <span class="tok-kt">Lens&#39;</span> <span class="tok-n">s</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">s</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">a</span>
<span class="tok-nf">set</span> <span class="tok-ow">::</span> <span class="tok-kt">Lens&#39;</span> <span class="tok-n">s</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">s</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">s</span>
<span class="tok-nf">over</span> <span class="tok-ow">::</span> <span class="tok-kt">Lens&#39;</span> <span class="tok-n">s</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-p">(</span><span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">a</span><span class="tok-p">)</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">s</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">s</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The big insight is the fact that the <code>Lens'</code> type can be implemented as an unique type that works for all 3 methods (given we add a functor constraint). It is actually a type synonym for:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-kr">type</span> <span class="tok-kt">Lens&#39;</span> <span class="tok-n">s</span> <span class="tok-n">a</span> <span class="tok-ow">=</span> <span class="tok-n">forall</span> <span class="tok-n">f</span><span class="tok-o">.</span> <span class="tok-kt">Functor</span> <span class="tok-n">f</span> <span class="tok-ow">=&gt;</span> <span class="tok-p">(</span><span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">f</span> <span class="tok-n">a</span><span class="tok-p">)</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">s</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">f</span> <span class="tok-n">s</span> <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is a kind of a lifting from the element <code>(a &#8594; f a)</code> to the container <code>(s &#8594; f s)</code></td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Lenses form a category where <code>.</code> is composition and <code>id</code> is the identity.
</td>
</tr>
</table>
</div>
<div class="literalblock">
<div class="title">Examples</div>
<div class="content">
<pre>&gt; over _1 (++ "!!!") ("goal", "the crowd goes wild")
&gt; ("goal", "the crowd goes wild") &amp; _1 %~ (++ "!!!") <i class="conum" data-value="1"></i><b>(1)</b>
("goal!!!", "the crowd goes wild")

&gt; ("world", "world") &amp; _1 .~ "hello" &amp; _2 .~ "hello" <i class="conum" data-value="1"></i><b>(1)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>&amp;</code> allows to start the expression from <code>s</code> and then compose.
It is defined as the reverse of <code>$</code> operator.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_common_operators">Common operators</h4>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">^.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">view</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">^?</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">preview</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">^..</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">toListOf</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">.~</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">set</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">%~</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">over</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">.=</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">state monad view</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_traverse">Traverse</h4>
<div class="paragraph">
<p>Traversals are Lenses which focus on multiple targets simultaneously. We actually don&#8217;t know how many targets they might be focusing on: it could be exactly 1 (like a Lens) or maybe 0 (like a Prism) or several. In that regard, a traversal is a like a Lens' except weaker (more general):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-kr">type</span> <span class="tok-kt">Traversal&#39;</span> <span class="tok-n">a</span> <span class="tok-n">b</span> <span class="tok-ow">=</span>
    <span class="tok-n">forall</span> <span class="tok-n">f</span> <span class="tok-o">.</span> <span class="tok-p">(</span><span class="tok-kt">Applicative</span> <span class="tok-n">f</span><span class="tok-p">)</span> <span class="tok-ow">=&gt;</span> <span class="tok-p">(</span><span class="tok-n">b</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">f</span> <span class="tok-n">b</span><span class="tok-p">)</span> <span class="tok-ow">-&gt;</span> <span class="tok-p">(</span><span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">f</span> <span class="tok-n">a</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-nf">firstOf</span><span class="tok-o">/</span><span class="tok-n">lastOf</span> <span class="tok-n">traverse</span> <span class="tok-ow">::</span> <span class="tok-kt">Traversable</span> <span class="tok-n">t</span> <span class="tok-ow">=&gt;</span> <span class="tok-n">t</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Maybe</span> <span class="tok-n">a</span>

<span class="tok-o">&gt;</span> <span class="tok-n">firstOf</span> <span class="tok-n">traverse</span> <span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">,</span><span class="tok-mi">2</span><span class="tok-p">,</span><span class="tok-mi">3</span><span class="tok-p">]</span>
<span class="tok-mi">1</span>
<span class="tok-o">&gt;</span> <span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-o">..</span><span class="tok-mi">8</span><span class="tok-p">]</span> <span class="tok-o">&amp;</span> <span class="tok-n">lastOf</span> <span class="tok-n">traverse</span>
<span class="tok-mi">8</span></code></pre>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1"><code>toListOf (^..)</code> </dt>
<dd>
<p>view list of targets</p>
</dd>
<dt class="hdlist1"><code>preview (^?)</code> </dt>
<dd>
<p>like <code>view</code> for Prism&#8217;s or Traversal&#8217;s. It handles access that focuses on either 0 or 1 targets.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_prims">Prims</h4>
<div class="paragraph">
<p>Prisms are kind of like Lenses that can fail or miss.</p>
</div>
<div class="paragraph">
<p>Note how the monoid instance of String allows us to get a native String from this expression:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&gt; s = (Left "hello", 5)
&gt; s ^. _1._Left
"hello"
&gt; s ^. _1._Right
""</pre>
</div>
</div>
<div class="paragraph">
<p>But without a monoid instance it cannot work and the <code>(^?)</code> is necessary:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="shell"><span></span>&gt; s = (Left 5, 5)
&gt; s ^? _1._Left
Just 5
&gt; s ^? _1._Right
Nothing
&gt; :t preview _Right (Right 1)
Num b =&gt; Maybe b</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_utils">Utils</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-c1">-- create the nested Map when it is missing:</span>
<span class="tok-kt">Map</span><span class="tok-o">.</span><span class="tok-n">empty</span> <span class="tok-o">&amp;</span> <span class="tok-n">at</span> <span class="tok-s">&quot;hello&quot;</span> <span class="tok-o">.</span> <span class="tok-n">non</span> <span class="tok-kt">Map</span><span class="tok-o">.</span><span class="tok-n">empty</span> <span class="tok-o">.</span> <span class="tok-n">at</span> <span class="tok-s">&quot;world&quot;</span> <span class="tok-o">?~</span> <span class="tok-s">&quot;!!!&quot;</span>
<span class="tok-c1">-- &gt; fromList [(&quot;hello&quot;,fromList [(&quot;world&quot;,&quot;!!!&quot;)])]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_monads">Monads</h3>
<div class="sect3">
<h4 id="_reader">Reader</h4>

</div>
<div class="sect3">
<h4 id="_state">State</h4>
<div class="paragraph">
<p>The State monad is just an abstraction for a function that takes a state and returns an intermediate value and some new state value:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-kr">newtype</span> <span class="tok-kt">State</span> <span class="tok-n">s</span> <span class="tok-n">a</span> <span class="tok-ow">=</span> <span class="tok-kt">State</span> <span class="tok-p">{</span> <span class="tok-n">runState</span> <span class="tok-ow">::</span> <span class="tok-n">s</span> <span class="tok-ow">-&gt;</span> <span class="tok-p">(</span><span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-n">s</span><span class="tok-p">)</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It is commonly used when needing state in a single thread of control. It doesn&#8217;t actually use mutable state and so does not necessary operate in IO.</p>
</div>
</div>
<div class="sect3">
<h4 id="_st">ST</h4>
<div class="paragraph">
<p>The ST<sup class="footnote">[<a id="_footnoteref_5" class="footnote" href="#_footnote_5" title="View footnote.">5</a>]</sup> monad lets you use update-in-place, but unlike IO it is escapable.
This means it uses system trickery to ensure that mutable data can&#8217;t escape the monad; that is, when you run an ST computation you get a pure result.</p>
</div>
<div class="paragraph">
<p>ST actions have the form:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-c1">-- an ST action returning a value of type a in state t</span>
<span class="tok-kr">newtype</span> <span class="tok-kt">ST</span> <span class="tok-n">s</span> <span class="tok-n">a</span> <span class="tok-ow">=</span> <span class="tok-kt">ST</span> <span class="tok-p">(</span><span class="tok-kt">Store</span> <span class="tok-n">s</span> <span class="tok-ow">-&gt;</span> <span class="tok-p">(</span><span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-kt">Store</span> <span class="tok-n">s</span><span class="tok-p">))</span>
 <span class="tok-c1">-- a mutable variable in thread s</span>
<span class="tok-kr">data</span> <span class="tok-kt">STRef</span> <span class="tok-n">s</span> <span class="tok-n">a</span> <span class="tok-ow">=</span> <span class="tok-kt">STRef</span> <span class="tok-p">(</span><span class="tok-kt">MutVar</span><span class="tok-o">#</span> <span class="tok-n">s</span> <span class="tok-n">a</span><span class="tok-p">)</span>

<span class="tok-nf">newSTRef</span> <span class="tok-ow">::</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">ST</span> <span class="tok-n">s</span> <span class="tok-p">(</span><span class="tok-kt">STRef</span> <span class="tok-n">s</span> <span class="tok-n">a</span><span class="tok-p">)</span>
<span class="tok-nf">readSTRef</span> <span class="tok-ow">::</span> <span class="tok-kt">STRef</span> <span class="tok-n">s</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">ST</span> <span class="tok-n">s</span> <span class="tok-n">a</span>
<span class="tok-nf">writeSTRef</span> <span class="tok-ow">::</span> <span class="tok-kt">STRef</span> <span class="tok-n">s</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">ST</span> <span class="tok-n">s</span> <span class="tok-nb">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The reason <mark>ST</mark> is interesting is that it&#8217;s a primitive monad like IO, allowing computations to perform low-level manipulations on bytearrays and pointers.
This means that ST can provide a pure interface while using low-level operations on mutable data, meaning it&#8217;s very fast. From the perspective of the program, it&#8217;s as if the ST computation runs in a separate thread with thread-local storage.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_exceptions">Exceptions</h3>
<div class="sect3">
<h4 id="_types">Types</h4>
<div class="dlist">
<dl>
<dt class="hdlist1">Synchronous exceptions</dt>
<dd>
<p>Generated as a result of a failing action in IO (same thread). Usually thrown using <code>throwIO</code>.</p>
</dd>
<dt class="hdlist1">Impure exceptions</dt>
<dd>
<p>Thrown in pure code by partial function. Ideally, we would not use such functions, a better practice is to return an <code>Either</code> type in this situation.</p>
</dd>
<dt class="hdlist1">Asynchronous exceptions</dt>
<dd>
<p>Can occur anywhere, including in pure code. Generated when another thread or the runtime system is trying to kill the current thread (via throwTo) or report an “unrecoverable” situation like a StackOverflow.</p>
</dd>
<dt class="hdlist1">Interruptible actions</dt>
<dd>
<p>Some operations are <a href="https://www.stackage.org/haddock/nightly-2016-07-17/base-4.9.0.0/Control-Exception.html#g:13">interruptible</a> by async exceptions even within a mask. This is the case for blocking functions such as <code>takeMVar</code> but also for most I/O operations dealing with the outside world.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_primitives">Primitives</h4>
<div class="listingblock">
<div class="title">Throwing</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-nf">throwIO</span> <span class="tok-ow">::</span> <span class="tok-kt">Exception</span> <span class="tok-n">e</span> <span class="tok-ow">=&gt;</span> <span class="tok-n">e</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">IO</span> <span class="tok-n">a</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Catching</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-nf">try</span> <span class="tok-ow">::</span> <span class="tok-kt">Exception</span> <span class="tok-n">e</span> <span class="tok-ow">=&gt;</span> <span class="tok-kt">IO</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">IO</span> <span class="tok-p">(</span><span class="tok-kt">Either</span> <span class="tok-n">e</span> <span class="tok-n">a</span><span class="tok-p">)</span>

<span class="tok-nf">catch</span>  <span class="tok-ow">::</span> <span class="tok-kt">Exception</span> <span class="tok-n">e</span>
        <span class="tok-ow">=&gt;</span> <span class="tok-kt">IO</span> <span class="tok-n">a</span>        <span class="tok-c1">-- ^ computation</span>
        <span class="tok-ow">-&gt;</span> <span class="tok-p">(</span><span class="tok-n">e</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">IO</span> <span class="tok-n">a</span><span class="tok-p">)</span> <span class="tok-c1">-- ^ handler</span>
        <span class="tok-ow">-&gt;</span> <span class="tok-kt">IO</span> <span class="tok-n">a</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p><mark>catch</mark> has an implicit <code>mask</code> around the handler.</p>
</li>
<li>
<p><mark>try</mark> does not have a similar default. Don&#8217;t use it for recovering from an async exception.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Cleanup</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-nf">finally</span>
        <span class="tok-ow">::</span> <span class="tok-kt">IO</span> <span class="tok-n">a</span> <span class="tok-c1">-- ^ computation</span>
        <span class="tok-ow">-&gt;</span> <span class="tok-kt">IO</span> <span class="tok-n">b</span> <span class="tok-c1">-- ^ computation to run afterward even if an exception was raised</span>
        <span class="tok-ow">-&gt;</span> <span class="tok-kt">IO</span> <span class="tok-n">a</span>
<span class="tok-nf">a</span> <span class="tok-p">`</span><span class="tok-n">finally</span><span class="tok-p">`</span> <span class="tok-n">sequel</span> <span class="tok-ow">=</span>
  <span class="tok-n">mask</span> <span class="tok-o">$</span> <span class="tok-nf">\</span><span class="tok-n">restore</span> <span class="tok-ow">-&gt;</span> <span class="tok-kr">do</span>
    <span class="tok-n">r</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">restore</span> <span class="tok-n">a</span> <span class="tok-p">`</span><span class="tok-n">onException</span><span class="tok-p">`</span> <span class="tok-n">sequel</span>
    <span class="tok-kr">_</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">sequel</span>
    <span class="tok-n">return</span> <span class="tok-n">r</span>

<span class="tok-c1">-- | Like &#39;finally&#39;, but only performs the final action if there was an</span>
<span class="tok-c1">-- exception raised by the computation.</span>
<span class="tok-nf">onException</span> <span class="tok-ow">::</span> <span class="tok-kt">IO</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">IO</span> <span class="tok-n">b</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">IO</span> <span class="tok-n">a</span>
<span class="tok-nf">onException</span> <span class="tok-n">io</span> <span class="tok-n">what</span> <span class="tok-ow">=</span>
  <span class="tok-n">io</span> <span class="tok-p">`</span><span class="tok-n">catch</span><span class="tok-p">`</span> <span class="tok-nf">\</span><span class="tok-n">e</span> <span class="tok-ow">-&gt;</span> <span class="tok-kr">do</span> <span class="tok-kr">_</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">what</span>
                        <span class="tok-n">throwIO</span> <span class="tok-p">(</span><span class="tok-n">e</span> <span class="tok-ow">::</span> <span class="tok-kt">SomeException</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Acquiring</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-nf">bracket</span>
        <span class="tok-ow">::</span> <span class="tok-kt">IO</span> <span class="tok-n">a</span>        <span class="tok-c1">-- ^ acquire resource</span>
        <span class="tok-ow">-&gt;</span> <span class="tok-p">(</span><span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">IO</span> <span class="tok-n">b</span><span class="tok-p">)</span> <span class="tok-c1">-- ^ release resource</span>
        <span class="tok-ow">-&gt;</span> <span class="tok-p">(</span><span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">IO</span> <span class="tok-n">c</span><span class="tok-p">)</span> <span class="tok-c1">-- ^ use resource</span>
        <span class="tok-ow">-&gt;</span> <span class="tok-kt">IO</span> <span class="tok-n">c</span>
<span class="tok-nf">bracket</span> <span class="tok-n">before</span> <span class="tok-n">after</span> <span class="tok-n">use</span> <span class="tok-ow">=</span>
  <span class="tok-n">mask</span> <span class="tok-o">$</span> <span class="tok-nf">\</span><span class="tok-n">restore</span> <span class="tok-ow">-&gt;</span> <span class="tok-kr">do</span>
    <span class="tok-n">a</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">before</span>
    <span class="tok-n">r</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">restore</span> <span class="tok-p">(</span><span class="tok-n">use</span> <span class="tok-n">a</span><span class="tok-p">)</span> <span class="tok-p">`</span><span class="tok-n">onException</span><span class="tok-p">`</span> <span class="tok-n">after</span> <span class="tok-n">a</span>
    <span class="tok-kr">_</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">after</span> <span class="tok-n">a</span>
    <span class="tok-n">return</span> <span class="tok-n">r</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_monad_primitives">Monad primitives</h4>
<div class="paragraph">
<p>The <code>exceptions</code> package defines <code>Control.Monad.Catch</code> with</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">MonadThrow</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-kr">class</span> <span class="tok-kt">Monad</span> <span class="tok-n">m</span> <span class="tok-ow">=&gt;</span> <span class="tok-kt">MonadThrow</span> <span class="tok-n">m</span> <span class="tok-kr">where</span>
  <span class="tok-n">throwM</span> <span class="tok-ow">::</span> <span class="tok-kt">Exception</span> <span class="tok-n">e</span> <span class="tok-ow">=&gt;</span> <span class="tok-n">e</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">m</span> <span class="tok-n">a</span></code></pre>
</div>
</div>
</dd>
<dt class="hdlist1">MonadCatch</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-kr">class</span> <span class="tok-kt">MonadThrow</span> <span class="tok-n">m</span> <span class="tok-ow">=&gt;</span> <span class="tok-kt">MonadCatch</span> <span class="tok-n">m</span> <span class="tok-kr">where</span>
  <span class="tok-n">catch</span> <span class="tok-ow">::</span> <span class="tok-kt">Exception</span> <span class="tok-n">e</span> <span class="tok-ow">=&gt;</span> <span class="tok-n">m</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-p">(</span><span class="tok-n">e</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">m</span> <span class="tok-n">a</span><span class="tok-p">)</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">m</span> <span class="tok-n">a</span></code></pre>
</div>
</div>
</dd>
<dt class="hdlist1">MonadMask</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-kr">class</span> <span class="tok-kt">MonadCatch</span> <span class="tok-n">m</span> <span class="tok-ow">=&gt;</span> <span class="tok-kt">MonadMask</span> <span class="tok-n">m</span> <span class="tok-kr">where</span>
  <span class="tok-n">mask</span> <span class="tok-ow">::</span> <span class="tok-p">((</span><span class="tok-n">forall</span> <span class="tok-n">a</span><span class="tok-o">.</span> <span class="tok-n">m</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">m</span> <span class="tok-n">a</span><span class="tok-p">)</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">m</span> <span class="tok-n">b</span><span class="tok-p">)</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">m</span> <span class="tok-n">b</span>
  <span class="tok-n">uninterruptibleMask</span> <span class="tok-ow">::</span> <span class="tok-p">((</span><span class="tok-n">forall</span> <span class="tok-n">a</span><span class="tok-o">.</span> <span class="tok-n">m</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">m</span> <span class="tok-n">a</span><span class="tok-p">)</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">m</span> <span class="tok-n">b</span><span class="tok-p">)</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">m</span> <span class="tok-n">b</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>Instances should ensure that, in the following code <code>f ‘finally’ g</code>, the action <code>g</code> is called regardless of what occurs within <code>f</code>, including async exceptions.</p>
</li>
<li>
<p><code>ExceptT</code> is not an instance of <mark>MonadMask</mark>. See <a href="https://www.fpcomplete.com/blog/2017/02/monadmask-vs-monadbracket">MonadMask vs MonadBracket</a></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_shake">Shake</h3>
<div class="sect3">
<h4 id="_example">Example</h4>
<div class="paragraph">
<p><code>shake</code> avoids rebuilding when it is not necessary. To achieve this goal, it needs to know about files  dependencies.
Let&#8217;s take as an example, the task of running a test suite.</p>
</div>
<div class="paragraph">
<p>In the following example you will need to define dependencies in steps as such:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>You need to display a test report, let&#8217;s call it 'build.last'</p>
</li>
<li>
<p>Building <code>build.last</code> requires calling an external command for each nodes.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-nf">buildDir</span> <span class="tok-ow">=</span> <span class="tok-s">&quot;_build&quot;</span>

<span class="tok-nf">main</span> <span class="tok-ow">=</span> <span class="tok-n">shakeArgs</span> <span class="tok-n">shakeOptions</span><span class="tok-p">{</span><span class="tok-n">shakeFiles</span><span class="tok-ow">=</span><span class="tok-n">buildDir</span> <span class="tok-o">&lt;/&gt;</span> <span class="tok-s">&quot;_shake&quot;</span><span class="tok-p">}</span> <span class="tok-o">$</span> <span class="tok-kr">do</span>

  <span class="tok-n">daemon</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">liftIO</span> <span class="tok-o">$</span> <span class="tok-n">initDaemon</span> <span class="tok-n">pref</span> <i class="conum" data-value="1"></i><b>(1)</b>

  <span class="tok-s">&quot;test&quot;</span> <span class="tok-o">~&gt;</span> <span class="tok-kr">do</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-n">content</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">readFile&#39;</span> <span class="tok-p">(</span><span class="tok-n">buildDir</span> <span class="tok-o">&lt;&gt;</span> <span class="tok-s">&quot;/build.last&quot;</span><span class="tok-p">)</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-n">putNormal</span> <span class="tok-n">content</span>
    <span class="tok-kr">let</span> <span class="tok-n">hasFailure</span> <span class="tok-ow">=</span> <span class="tok-n">any</span> <span class="tok-p">(</span><span class="tok-nf">\</span><span class="tok-n">i</span> <span class="tok-ow">-&gt;</span> <span class="tok-s">&quot;x&quot;</span> <span class="tok-p">`</span><span class="tok-n">isPrefixOf</span><span class="tok-p">`</span> <span class="tok-n">i</span><span class="tok-p">)</span> <span class="tok-p">(</span><span class="tok-n">lines</span> <span class="tok-n">content</span><span class="tok-p">)</span>
    <span class="tok-kr">if</span> <span class="tok-n">hasFailure</span>
      <span class="tok-kr">then</span> <span class="tok-n">fail</span> <span class="tok-s">&quot;The build has failed !&quot;</span>
      <span class="tok-kr">else</span> <span class="tok-n">liftIO</span> <span class="tok-o">$</span> <span class="tok-n">putDoc</span> <span class="tok-p">(</span><span class="tok-n">dullgreen</span> <span class="tok-s">&quot;All green.&quot;</span> <span class="tok-o">&lt;&gt;</span> <span class="tok-n">line</span><span class="tok-p">)</span>

  <span class="tok-n">buildDir</span> <span class="tok-o">&lt;&gt;</span> <span class="tok-s">&quot;/build.last&quot;</span> <span class="tok-o">%&gt;</span> <span class="tok-nf">\</span><span class="tok-n">out</span> <span class="tok-ow">-&gt;</span> <span class="tok-kr">do</span>
    <span class="tok-kt">Right</span> <span class="tok-n">nx</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">liftIO</span> <span class="tok-o">$</span> <span class="tok-n">runExceptT</span> <span class="tok-o">$</span> <span class="tok-n">getNodes</span> <span class="tok-n">pdbapi</span> <span class="tok-kt">QEmpty</span>
    <span class="tok-kr">let</span> <span class="tok-n">deps</span> <span class="tok-ow">=</span> <span class="tok-p">[</span> <span class="tok-n">buildDir</span> <span class="tok-o">&lt;&gt;</span> <span class="tok-s">&quot;/&quot;</span> <span class="tok-o">&lt;&gt;</span> <span class="tok-kt">Text</span><span class="tok-o">.</span><span class="tok-n">unpack</span> <span class="tok-n">n</span> <span class="tok-o">&lt;&gt;</span> <span class="tok-s">&quot;.node&quot;</span> <span class="tok-o">|</span> <span class="tok-n">n</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">nx</span> <span class="tok-o">^..</span> <span class="tok-n">traverse</span><span class="tok-o">.</span><span class="tok-n">nodeInfoName</span><span class="tok-p">]</span>
    <span class="tok-n">need</span> <span class="tok-n">deps</span>
    <span class="tok-kt">Stdout</span> <span class="tok-n">stdout</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">quietly</span> <span class="tok-o">$</span> <span class="tok-n">cmd</span> <span class="tok-p">(</span><span class="tok-s">&quot;cat&quot;</span><span class="tok-ow">::</span><span class="tok-kt">String</span><span class="tok-p">)</span> <span class="tok-n">deps</span>
    <span class="tok-n">writeFileChanged</span> <span class="tok-n">out</span> <span class="tok-n">stdout</span>

  <span class="tok-n">buildDir</span> <span class="tok-o">&lt;&gt;</span> <span class="tok-s">&quot;//*.node&quot;</span> <span class="tok-o">%&gt;</span> <span class="tok-nf">\</span><span class="tok-n">out</span> <span class="tok-ow">-&gt;</span> <span class="tok-kr">do</span>
    <span class="tok-kr">let</span> <span class="tok-n">node</span> <span class="tok-ow">=</span> <span class="tok-n">dropDirectory1</span> <span class="tok-p">(</span><span class="tok-n">dropExtension</span> <span class="tok-n">out</span><span class="tok-p">)</span>
    <span class="tok-n">facts</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">liftIO</span> <span class="tok-o">$</span> <span class="tok-n">mergeFacts</span> <span class="tok-p">(</span><span class="tok-n">pref</span> <span class="tok-o">^.</span> <span class="tok-n">prefFactsDefault</span><span class="tok-p">)</span> <span class="tok-p">(</span><span class="tok-n">pref</span> <span class="tok-o">^.</span> <span class="tok-n">prefFactsOverride</span><span class="tok-p">)</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-kt">F</span><span class="tok-o">.</span><span class="tok-n">puppetDBFacts</span> <span class="tok-p">(</span><span class="tok-kt">Text</span><span class="tok-o">.</span><span class="tok-n">pack</span> <span class="tok-n">node</span><span class="tok-p">)</span> <span class="tok-n">pdbapi</span>
    <span class="tok-n">r</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">liftIO</span> <span class="tok-o">$</span> <span class="tok-n">getCatalog</span> <span class="tok-n">daemon</span> <span class="tok-p">(</span><span class="tok-kt">Text</span><span class="tok-o">.</span><span class="tok-n">pack</span> <span class="tok-n">node</span><span class="tok-p">)</span> <span class="tok-n">facts</span>
    <span class="tok-n">deps</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">liftIO</span> <span class="tok-o">$</span> <span class="tok-kt">Set</span><span class="tok-o">.</span><span class="tok-n">fromList</span> <span class="tok-o">.</span><span class="tok-kt">HM</span><span class="tok-o">.</span><span class="tok-n">keys</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">getStats</span> <span class="tok-p">(</span><span class="tok-n">parserStats</span> <span class="tok-n">daemon</span><span class="tok-p">)</span>
    <span class="tok-n">need</span> <span class="tok-o">$</span> <span class="tok-kt">Text</span><span class="tok-o">.</span><span class="tok-n">unpack</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-kt">Set</span><span class="tok-o">.</span><span class="tok-n">toList</span> <span class="tok-n">deps</span>
    <span class="tok-kr">case</span> <span class="tok-n">r</span> <span class="tok-kr">of</span>
      <span class="tok-kt">S</span><span class="tok-o">.</span><span class="tok-kt">Right</span> <span class="tok-kr">_</span> <span class="tok-ow">-&gt;</span>
        <span class="tok-n">liftIO</span> <span class="tok-o">$</span> <span class="tok-n">withFile</span> <span class="tok-n">out</span> <span class="tok-kt">WriteMode</span> <span class="tok-p">(</span><span class="tok-nf">\</span><span class="tok-n">h</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">hPutDoc</span> <span class="tok-n">h</span> <span class="tok-p">(</span> <span class="tok-n">dullgreen</span> <span class="tok-s">&quot;✓&quot;</span> <span class="tok-o">&lt;+&gt;</span> <span class="tok-n">text</span> <span class="tok-n">node</span> <span class="tok-o">&lt;&gt;</span> <span class="tok-n">line</span><span class="tok-p">))</span>
      <span class="tok-kt">S</span><span class="tok-o">.</span><span class="tok-kt">Left</span> <span class="tok-n">msg</span> <span class="tok-ow">-&gt;</span>
        <span class="tok-n">liftIO</span> <span class="tok-o">$</span> <span class="tok-n">withFile</span> <span class="tok-n">out</span> <span class="tok-kt">WriteMode</span> <span class="tok-p">(</span><span class="tok-nf">\</span><span class="tok-n">h</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">hPutDoc</span> <span class="tok-n">h</span> <span class="tok-p">(</span> <span class="tok-n">char</span> <span class="tok-sc">&#39;x&#39;</span> <span class="tok-o">&lt;&gt;</span> <span class="tok-n">space</span> <span class="tok-o">&lt;&gt;</span> <span class="tok-n">red</span> <span class="tok-p">(</span><span class="tok-n">text</span> <span class="tok-n">node</span><span class="tok-p">)</span> <span class="tok-o">&lt;&gt;</span> <span class="tok-n">line</span> <span class="tok-o">&lt;&gt;</span> <span class="tok-n">indent</span> <span class="tok-mi">2</span> <span class="tok-p">(</span><span class="tok-n">getError</span> <span class="tok-n">msg</span><span class="tok-p">)</span> <span class="tok-o">&lt;&gt;</span> <span class="tok-n">line</span><span class="tok-p">))</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Each build would execute this line TODO: Is there a way to avoid this ?</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>One of the top target. It is a phony rule because it does not produce anything.
&lt;3&gt;</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_turtle">Turtle</h3>
<div class="sect3">
<h4 id="_streams">Streams</h4>
<div class="paragraph">
<p>The <mark>Shell</mark> type represents a stream of values. You can think of Shell as <code>[] + IO + Managed</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-kr">newtype</span> <span class="tok-kt">Shell</span> <span class="tok-n">a</span> <span class="tok-ow">=</span> <span class="tok-kt">Shell</span> <span class="tok-p">{</span> <span class="tok-n">_foldIO</span> <span class="tok-ow">::</span> <span class="tok-n">forall</span> <span class="tok-n">r</span> <span class="tok-o">.</span> <span class="tok-kt">FoldM</span> <span class="tok-kt">IO</span> <span class="tok-n">a</span> <span class="tok-n">r</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">IO</span> <span class="tok-n">r</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You invoke any external shell commands using <mark>proc</mark> or <mark>shell</mark>. If you don&#8217;t care about throwing an error instead of returning the error code you would use <code>procs</code> and <code>shells</code>; <code>proc(s)</code> is more secure but it won&#8217;t do any shell string interpolation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-nf">shell</span>
    <span class="tok-ow">::</span> <span class="tok-kt">Text</span>        <span class="tok-c1">-- Command line</span>
    <span class="tok-ow">-&gt;</span> <span class="tok-kt">Shell</span> <span class="tok-kt">Line</span>  <span class="tok-c1">-- Lines of standard input to feed to program</span>
    <span class="tok-ow">-&gt;</span> <span class="tok-n">io</span> <span class="tok-kt">ExitCode</span>

<span class="tok-nf">shells</span> <span class="tok-ow">::</span> <span class="tok-kt">Text</span><span class="tok-ow">-&gt;</span> <span class="tok-kt">Shell</span> <span class="tok-kt">Line</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">io</span> <span class="tok-nb">()</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-nf">select</span> <span class="tok-ow">::</span>        <span class="tok-p">[</span><span class="tok-n">a</span><span class="tok-p">]</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Shell</span> <span class="tok-n">a</span>
<span class="tok-nf">liftIO</span> <span class="tok-ow">::</span>      <span class="tok-kt">IO</span> <span class="tok-n">a</span>  <span class="tok-ow">-&gt;</span> <span class="tok-kt">Shell</span> <span class="tok-n">a</span>
<span class="tok-nf">using</span>  <span class="tok-ow">::</span> <span class="tok-kt">Managed</span> <span class="tok-n">a</span>  <span class="tok-ow">-&gt;</span> <span class="tok-kt">Shell</span> <span class="tok-n">a</span>

<span class="tok-c1">-- usual construction primitive</span>
<span class="tok-nf">empty</span> <span class="tok-ow">::</span> <span class="tok-kt">Shell</span> <span class="tok-n">a</span>

<span class="tok-c1">-- consume the stream by printing it to stdout</span>
<span class="tok-nf">view</span>   <span class="tok-ow">::</span> <span class="tok-kt">Show</span> <span class="tok-n">a</span> <span class="tok-ow">=&gt;</span> <span class="tok-kt">Shell</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">IO</span> <span class="tok-nb">()</span>
<span class="tok-nf">stdout</span> <span class="tok-ow">::</span> <span class="tok-kt">Shell</span> <span class="tok-kt">Text</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">IO</span> <span class="tok-nb">()</span>

<span class="tok-c1">-- consume the (side-effect) stream, discarding any unused values</span>
<span class="tok-nf">sh</span> <span class="tok-ow">::</span> <span class="tok-kt">MonadIO</span> <span class="tok-n">io</span> <span class="tok-ow">=&gt;</span> <span class="tok-kt">Shell</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">io</span> <span class="tok-nb">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can simulate piping the result of a command with <code>inshell</code> or <code>inproc</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-nf">inshell</span> <span class="tok-ow">::</span> <span class="tok-kt">Text</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Shell</span> <span class="tok-kt">Line</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Shell</span> <span class="tok-kt">Line</span>

<span class="tok-nf">inproc</span> <span class="tok-s">&quot;curl&quot;</span> <span class="tok-p">[</span><span class="tok-s">&quot;-s&quot;</span>
              <span class="tok-p">,</span> <span class="tok-s">&quot;http://&quot;</span>
              <span class="tok-p">]</span> <span class="tok-n">empty</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-o">&amp;</span> <span class="tok-n">output</span> <span class="tok-s">&quot;filename.ext&quot;</span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>keep the result of a command as a stream</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>pipe and copy</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
When using <mark>inshell</mark> you lose the ability to care about the exit code of the command that produces the stream.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>Shell</code> is also an instance of <code>MonadPlus</code> (and thus Alternative).
So you can concatenate two Shell streams using <code>&lt;|&gt;</code>.</p>
</div>
<div class="sect4">
<h5 id="_folding">Folding</h5>
<div class="paragraph">
<p>Whenever you peek into the value of a shell stream using <code>&#8592;</code> you are effectively looping over all values (as the list monad does). For instance this code is bogus :</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">bogus</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-kr">do</span>
  <span class="tok-n">found</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">testpath</span> <span class="tok-o">=&lt;&lt;</span> <span class="tok-n">find</span> <span class="tok-p">(</span><span class="tok-n">prefix</span> <span class="tok-p">(</span><span class="tok-n">text</span> <span class="tok-s">&quot;/home/vagrant/zsh&quot;</span><span class="tok-p">))</span> <span class="tok-s">&quot;/home/vagrant&quot;</span>
  <span class="tok-n">unless</span> <span class="tok-n">found</span> <span class="tok-o">$</span> <span class="tok-o">...</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You will need to consume the stream and one good way to do so is using <mark>fold</mark> from the <code>foldl</code> package:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-kr">import</span> <span class="tok-k">qualified</span> <span class="tok-nn">Control.Foldl</span> <span class="tok-k">as</span> <span class="tok-n">Fold</span>

<span class="tok-nf">main</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
  <span class="tok-n">not_found</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">fold</span> <span class="tok-p">(</span><span class="tok-n">find</span> <span class="tok-p">(</span><span class="tok-n">prefix</span> <span class="tok-p">(</span><span class="tok-n">text</span> <span class="tok-s">&quot;/home/vagrant/zsh&quot;</span><span class="tok-p">))</span> <span class="tok-s">&quot;/home/vagrant&quot;</span><span class="tok-p">)</span> <span class="tok-kt">Fold</span><span class="tok-o">.</span><span class="tok-n">null</span>
  <span class="tok-n">when</span> <span class="tok-p">(</span><span class="tok-n">not_found</span><span class="tok-p">)</span> <span class="tok-o">$</span> <span class="tok-kr">do</span> <span class="tok-o">...</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_filepath">FilePath</h4>
<div class="paragraph">
<p><code>Turtle</code> is using the deprecated <code>system-filepath package</code> to handle filepaths in a more secure way<sup class="footnote">[<a id="_footnoteref_6" class="footnote" href="#_footnote_6" title="View footnote.">6</a>]</sup>. Watch out as it is at time a bit surprising:</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">common traps</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-kr">let</span> <span class="tok-n">first</span> <span class="tok-ow">=</span> <span class="tok-s">&quot;/home/vagrant&quot;</span> <span class="tok-ow">::</span> <span class="tok-kt">FilePath</span>
     <span class="tok-n">second</span> <span class="tok-ow">=</span> <span class="tok-s">&quot;/plugin&quot;</span> <i class="conum" data-value="1"></i><b>(1)</b>
     <span class="tok-n">test</span> <span class="tok-ow">=</span> <span class="tok-n">first</span> <span class="tok-o">&lt;&gt;</span> <span class="tok-n">second</span> <span class="tok-c1">-- &quot;/plugin&quot;</span>

<span class="tok-nf">eclipseVersion</span> <span class="tok-ow">=</span> <span class="tok-s">&quot;4.5&quot;</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-kr">let</span> <span class="tok-n">fp</span> <span class="tok-ow">=</span> <span class="tok-s">&quot;foo&quot;</span> <span class="tok-o">&lt;/&gt;</span> <span class="tok-s">&quot;bar_&quot;</span> <span class="tok-o">&lt;&gt;</span> <span class="tok-n">eclipseVersion</span> <span class="tok-o">&lt;/&gt;</span> <span class="tok-s">&quot;plugin&quot;</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">foo</span><span class="tok-o">/</span><span class="tok-n">bar_</span><span class="tok-o">/</span><span class="tok-mf">4.5</span><span class="tok-o">/</span><span class="tok-n">plugin</span> <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>don&#8217;t start with a <code>/</code> as it means you want to concatenate an absolute path</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>give you an filepath type automatically thanks to the <code>IsString</code> instance</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>in system-filepath <code>&lt;&gt;</code> and <code>&lt;/&gt;</code> are both alias for <code>append</code> <span class="icon"><i class="fa fa-frown-o"></i></span></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When appending <code>filepath</code> and <code>text</code> the best strategy is probably to keep the filepath encoding and then convert to text if necessary:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-kr">let</span> <span class="tok-n">path</span> <span class="tok-ow">=</span> <span class="tok-s">&quot;foo&quot;</span> <span class="tok-o">&lt;/&gt;</span> <span class="tok-n">fromText</span> <span class="tok-n">eclipseVersion</span> <span class="tok-o">&lt;/&gt;</span> <span class="tok-s">&quot;plugin&quot;</span>
    <span class="tok-n">_path</span> <span class="tok-ow">=</span> <span class="tok-n">format</span> <span class="tok-n">fp</span> <span class="tok-n">path</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Use <code>&lt;/&gt;</code> for appending filepaths, use <code>&lt;&gt;</code> for appending text.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_command_line_options">Command line options</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-kr">data</span> <span class="tok-kt">Command</span>
  <span class="tok-ow">=</span> <span class="tok-kt">Console</span>
  <span class="tok-o">|</span> <span class="tok-kt">Stack</span> <span class="tok-p">(</span><span class="tok-kt">Maybe</span> <span class="tok-kt">StackName</span><span class="tok-p">,</span> <span class="tok-kt">StackCommand</span><span class="tok-p">)</span>
  <span class="tok-kr">deriving</span> <span class="tok-p">(</span><span class="tok-kt">Show</span><span class="tok-p">)</span>

<span class="tok-nf">commandParser</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">Command</span>
<span class="tok-nf">commandParser</span> <span class="tok-ow">=</span>
      <span class="tok-kt">Console</span> <span class="tok-o">&lt;$</span>  <span class="tok-n">subcommand</span> <span class="tok-s">&quot;console&quot;</span> <span class="tok-s">&quot;Help msg&quot;</span> <span class="tok-p">(</span><span class="tok-n">pure</span> <span class="tok-nb">()</span><span class="tok-p">)</span>
  <span class="tok-o">&lt;|&gt;</span> <span class="tok-kt">Stack</span>   <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">subcommand</span> <span class="tok-s">&quot;stack&quot;</span> <span class="tok-s">&quot;Help msg&quot;</span> <span class="tok-n">stackParser</span> <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>remaining parser (after 'stack')</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When using a group you will need a single datatype to extract the value of the rest of the command.
Don&#8217;t do this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-kr">data</span> <span class="tok-kt">Command</span> <span class="tok-ow">=</span> <span class="tok-kt">Stack</span> <span class="tok-kt">Int</span> <span class="tok-kt">Text</span>

<span class="tok-nf">commandParser</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">Command</span>
<span class="tok-nf">commandParser</span> <span class="tok-ow">=</span> <span class="tok-kt">Stack</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">subcommand</span> <span class="tok-s">&quot;stack&quot;</span> <span class="tok-s">&quot;Help&quot;</span> <span class="tok-n">intParser</span> <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">textParser</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_pipes">Pipes</h3>
<div class="sect3">
<h4 id="_primitives_2">Primitives</h4>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="title">StateT</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-kr">newtype</span> <span class="tok-kt">StateT</span> <span class="tok-n">s</span> <span class="tok-n">m</span> <span class="tok-n">a</span> <span class="tok-ow">=</span> <span class="tok-kt">StateT</span> <span class="tok-p">{</span>
    <span class="tok-n">runStateT</span> <span class="tok-ow">::</span> <span class="tok-n">s</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">m</span> <span class="tok-p">(</span><span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-n">s</span><span class="tok-p">)</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Free Monad</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-kr">data</span> <span class="tok-kt">Free</span> <span class="tok-n">f</span> <span class="tok-n">a</span> <span class="tok-ow">=</span> <span class="tok-kt">Free</span> <span class="tok-p">(</span><span class="tok-n">f</span> <span class="tok-p">(</span><span class="tok-kt">Free</span> <span class="tok-n">f</span> <span class="tok-n">a</span><span class="tok-p">))</span> <span class="tok-o">|</span> <span class="tok-kt">Pure</span> <span class="tok-n">a</span>

<span class="tok-nf">liftF</span> <span class="tok-ow">::</span> <span class="tok-kt">Functor</span> <span class="tok-n">f</span> <span class="tok-ow">=&gt;</span> <span class="tok-n">f</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Free</span> <span class="tok-n">f</span> <span class="tok-n">a</span></code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Void</div>
<p>is the inhabited type and denote a closed <strong>output</strong></p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_proxy">Proxy</h5>
<div class="paragraph">
<p>Pipes defines a single type <code>Proxy</code> which is a monad transformer:</p>
</div>
<div class="literalblock">
<div class="content">
<pre> (Proxy p) =&gt; p a' a b' b m r

  Upstream | Downstream
     +---------+
     |         |
 a' &lt;==       &lt;== b'
     |  Proxy  |
 a  ==&gt;   m   ==&gt; b
     |         |
     +----|----+
          r</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-kr">type</span> <span class="tok-kt">Effect</span> <span class="tok-ow">=</span> <span class="tok-kt">Proxy</span> <span class="tok-kt">X</span> <span class="tok-nb">()</span> <span class="tok-nb">()</span> <span class="tok-kt">X</span>
<span class="tok-nf">runEffect</span> <span class="tok-ow">::</span> <span class="tok-p">(</span><span class="tok-kt">Monad</span> <span class="tok-n">m</span><span class="tok-p">)</span> <span class="tok-ow">=&gt;</span> <span class="tok-kt">Effect</span> <span class="tok-n">m</span> <span class="tok-n">r</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">m</span> <span class="tok-n">r</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Effect is a proxy that never yield or wait.
The default API exposes a pull-based unidirectional flow.</p>
</div>
</div>
<div class="sect4">
<h5 id="_producer">Producer</h5>
<div class="paragraph">
<p>A Producer is a monad transformer that extends any base monad with a yield command. <code>yield</code> emits a value, suspending the current Producer until the value is consumed. If nobody consumes the value (which is possible) then yield never returns.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>type Producer b m r = Proxy X () () b m r
     +---------+
     |         |
Void &lt;==       &lt;== ()
     |  Proxy  |
 ()  ==&gt;       ==&gt; b
     |         |
     +---------+</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-nf">yield</span> <span class="tok-ow">::</span> <span class="tok-p">(</span><span class="tok-kt">Monad</span> <span class="tok-n">m</span><span class="tok-p">)</span> <span class="tok-ow">=&gt;</span> <span class="tok-n">b</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Producer&#39;</span> <span class="tok-n">b</span> <span class="tok-n">m</span> <span class="tok-nb">()</span>

<span class="tok-nf">for</span> <span class="tok-ow">::</span> <span class="tok-p">(</span><span class="tok-kt">Monad</span> <span class="tok-n">m</span><span class="tok-p">)</span>
    <span class="tok-ow">=&gt;</span>       <span class="tok-kt">Proxy</span> <span class="tok-n">x&#39;</span> <span class="tok-n">x</span> <span class="tok-n">b&#39;</span> <span class="tok-n">b</span> <span class="tok-n">m</span> <span class="tok-n">a&#39;</span>
    <span class="tok-ow">-&gt;</span> <span class="tok-p">(</span><span class="tok-n">b</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Proxy</span> <span class="tok-n">x&#39;</span> <span class="tok-n">x</span> <span class="tok-n">c&#39;</span> <span class="tok-n">c</span> <span class="tok-n">m</span> <span class="tok-n">b&#39;</span><span class="tok-p">)</span>
    <span class="tok-ow">-&gt;</span>       <span class="tok-kt">Proxy</span> <span class="tok-n">x&#39;</span> <span class="tok-n">x</span> <span class="tok-n">c&#39;</span> <span class="tok-n">c</span> <span class="tok-n">m</span> <span class="tok-n">a&#39;</span>


<span class="tok-c1">-- &quot;into&quot; compose the bodies of `for`</span>
<span class="tok-p">(</span><span class="tok-o">~&gt;</span><span class="tok-p">)</span> <span class="tok-ow">::</span> <span class="tok-p">(</span><span class="tok-kt">Monad</span> <span class="tok-n">m</span><span class="tok-p">)</span>
     <span class="tok-ow">=&gt;</span> <span class="tok-p">(</span><span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Producer</span> <span class="tok-n">b</span> <span class="tok-n">m</span> <span class="tok-n">r</span><span class="tok-p">)</span>
     <span class="tok-ow">-&gt;</span> <span class="tok-p">(</span><span class="tok-n">b</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Producer</span> <span class="tok-n">c</span> <span class="tok-n">m</span> <span class="tok-n">r</span><span class="tok-p">)</span>
     <span class="tok-ow">-&gt;</span> <span class="tok-p">(</span><span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Producer</span> <span class="tok-n">c</span> <span class="tok-n">m</span> <span class="tok-n">r</span><span class="tok-p">)</span>
<span class="tok-p">(</span><span class="tok-n">f</span> <span class="tok-o">~&gt;</span> <span class="tok-n">g</span><span class="tok-p">)</span> <span class="tok-n">x</span> <span class="tok-ow">=</span> <span class="tok-n">for</span> <span class="tok-p">(</span><span class="tok-n">f</span> <span class="tok-n">x</span><span class="tok-p">)</span> <span class="tok-n">g</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>~&gt;</code> and yield form a Category ("Generator") where <code>yield</code> is the identity.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>With <code>for</code> you consume every element of a <code>Producer</code> the exact same way. If this is not suitable, use <code>next</code> or a <code>Consumer</code>.</p>
</div>
<div class="paragraph">
<p>Think of <code>next</code> as pattern matching on the head of the Producer. This Either returns a Left if the Producer is done or it returns a Right containing the next value, a, along with the remainder of the Producer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-nf">next</span> <span class="tok-ow">::</span> <span class="tok-kt">Monad</span> <span class="tok-n">m</span> <span class="tok-ow">=&gt;</span> <span class="tok-kt">Producer</span> <span class="tok-n">a</span> <span class="tok-n">m</span> <span class="tok-n">r</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">m</span> <span class="tok-p">(</span><span class="tok-kt">Either</span> <span class="tok-n">r</span> <span class="tok-p">(</span><span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-kt">Producer</span> <span class="tok-n">a</span> <span class="tok-n">m</span> <span class="tok-n">r</span><span class="tok-p">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>##= Consumer</p>
</div>
<div class="paragraph">
<p>A consumer represents an "exhaustible" (it may refuse to accept new values) and possibly effectful sink of values. An example of an exhaustible sink is <code>toOutput</code> from <code>pipes-concurrency</code>, which will terminate if the <code>Output</code> it writes to has been sealed.</p>
</div>
<div class="paragraph">
<p><code>await</code> blocks waiting for a new value. If nobody provides it (which is possible) then await never returns.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>type Consumer a = Proxy () a () X
     +---------+
     |         |
 () &lt;==       &lt;== ()
     |  Proxy  |
 a  ==&gt;       ==&gt; Void
     |         |
     +---------+</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-nf">await</span> <span class="tok-ow">::</span> <span class="tok-kt">Monad</span> <span class="tok-n">m</span> <span class="tok-ow">=&gt;</span> <span class="tok-kt">Consumer&#39;</span> <span class="tok-n">a</span> <span class="tok-n">m</span> <span class="tok-n">a</span></code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">(&gt;~)</div>
<p>Repeatedly feeds <code>await</code> in the consumer with the action passed as the first parameter.
This allows consumer composition</p>
</div>
<div class="listingblock">
<div class="title">Examples</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-nf">runEffect</span> <span class="tok-o">$</span> <span class="tok-n">lift</span> <span class="tok-n">getLine</span> <span class="tok-o">&gt;~</span> <span class="tok-n">stdoutLn</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>        +- Feed             +- Consumer to      +- Returns new
        |  action           |  feed             |  Effect
        v                   v                   v</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-p">(</span><span class="tok-o">&gt;~</span><span class="tok-p">)</span> <span class="tok-ow">::</span> <span class="tok-kt">Effect</span> <span class="tok-n">m</span> <span class="tok-n">b</span>       <span class="tok-ow">-&gt;</span> <span class="tok-kt">Consumer</span> <span class="tok-n">b</span> <span class="tok-n">m</span> <span class="tok-n">c</span>   <span class="tok-ow">-&gt;</span> <span class="tok-kt">Effect</span> <span class="tok-n">m</span> <span class="tok-n">c</span>
<span class="tok-p">(</span><span class="tok-o">&gt;~</span><span class="tok-p">)</span> <span class="tok-ow">::</span> <span class="tok-kt">Consumer</span> <span class="tok-n">a</span> <span class="tok-n">m</span> <span class="tok-n">b</span>   <span class="tok-ow">-&gt;</span> <span class="tok-kt">Consumer</span> <span class="tok-n">b</span> <span class="tok-n">m</span> <span class="tok-n">c</span>   <span class="tok-ow">-&gt;</span> <span class="tok-kt">Consumer</span> <span class="tok-n">a</span> <span class="tok-n">m</span> <span class="tok-n">c</span>
<span class="tok-p">(</span><span class="tok-o">&gt;~</span><span class="tok-p">)</span> <span class="tok-ow">::</span> <span class="tok-kt">Producer</span> <span class="tok-n">y</span> <span class="tok-n">m</span> <span class="tok-n">b</span>   <span class="tok-ow">-&gt;</span> <span class="tok-kt">Pipe</span>     <span class="tok-n">b</span> <span class="tok-n">y</span> <span class="tok-n">m</span> <span class="tok-n">c</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Producer</span>   <span class="tok-n">y</span> <span class="tok-n">m</span> <span class="tok-n">c</span>
<span class="tok-p">(</span><span class="tok-o">&gt;~</span><span class="tok-p">)</span> <span class="tok-ow">::</span> <span class="tok-kt">Pipe</span>     <span class="tok-n">a</span> <span class="tok-n">y</span> <span class="tok-n">m</span> <span class="tok-n">b</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Pipe</span>     <span class="tok-n">b</span> <span class="tok-n">y</span> <span class="tok-n">m</span> <span class="tok-n">c</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Pipe</span>     <span class="tok-n">a</span> <span class="tok-n">y</span> <span class="tok-n">m</span> <span class="tok-n">c</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>(&gt;~)</code> and <code>await</code> form a Category  where <code>await</code> is the identity.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_pipe">Pipe</h5>
<div class="literalblock">
<div class="content">
<pre>type Pipe a b = Proxy () a () b
     +---------+
     |         |
 () &lt;==       &lt;== ()
     |  Proxy  |
 a  ==&gt;       ==&gt; b
     |         |
     +---------+</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-p">(</span><span class="tok-o">&gt;-&gt;</span><span class="tok-p">)</span> <span class="tok-ow">::</span> <span class="tok-kt">Monad</span> <span class="tok-n">m</span> <span class="tok-ow">=&gt;</span> <span class="tok-kt">Producer</span> <span class="tok-n">a</span> <span class="tok-n">m</span> <span class="tok-n">r</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Consumer</span> <span class="tok-n">a</span> <span class="tok-n">m</span> <span class="tok-n">r</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Effect</span> <span class="tok-n">m</span> <span class="tok-n">r</span>
<span class="tok-p">(</span><span class="tok-o">&gt;-&gt;</span><span class="tok-p">)</span> <span class="tok-ow">::</span> <span class="tok-kt">Monad</span> <span class="tok-n">m</span> <span class="tok-ow">=&gt;</span> <span class="tok-kt">Producer</span> <span class="tok-n">a</span> <span class="tok-n">m</span> <span class="tok-n">r</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Pipe</span>   <span class="tok-n">a</span> <span class="tok-n">b</span> <span class="tok-n">m</span> <span class="tok-n">r</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Producer</span> <span class="tok-n">b</span> <span class="tok-n">m</span> <span class="tok-n">r</span>
<span class="tok-p">(</span><span class="tok-o">&gt;-&gt;</span><span class="tok-p">)</span> <span class="tok-ow">::</span> <span class="tok-kt">Monad</span> <span class="tok-n">m</span> <span class="tok-ow">=&gt;</span> <span class="tok-kt">Pipe</span>   <span class="tok-n">a</span> <span class="tok-n">b</span> <span class="tok-n">m</span> <span class="tok-n">r</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Consumer</span> <span class="tok-n">b</span> <span class="tok-n">m</span> <span class="tok-n">r</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Consumer</span> <span class="tok-n">a</span> <span class="tok-n">m</span> <span class="tok-n">r</span>
<span class="tok-p">(</span><span class="tok-o">&gt;-&gt;</span><span class="tok-p">)</span> <span class="tok-ow">::</span> <span class="tok-kt">Monad</span> <span class="tok-n">m</span> <span class="tok-ow">=&gt;</span> <span class="tok-kt">Pipe</span>   <span class="tok-n">a</span> <span class="tok-n">b</span> <span class="tok-n">m</span> <span class="tok-n">r</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Pipe</span>   <span class="tok-n">b</span> <span class="tok-n">c</span> <span class="tok-n">m</span> <span class="tok-n">r</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Pipe</span>   <span class="tok-n">a</span> <span class="tok-n">c</span> <span class="tok-n">m</span> <span class="tok-n">r</span>

<span class="tok-nf">cat</span> <span class="tok-ow">::</span> <span class="tok-p">(</span><span class="tok-kt">Monad</span> <span class="tok-n">m</span><span class="tok-p">)</span> <span class="tok-ow">=&gt;</span> <span class="tok-kt">Pipe</span> <span class="tok-n">a</span> <span class="tok-n">a</span> <span class="tok-n">m</span> <span class="tok-n">r</span>
<span class="tok-nf">cat</span> <span class="tok-ow">=</span> <span class="tok-n">forever</span> <span class="tok-o">$</span> <span class="tok-kr">do</span>
    <span class="tok-n">x</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">await</span>
    <span class="tok-n">yield</span> <span class="tok-n">x</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>(&gt;&#8594;)</code> and <code>cat</code> form a Category where <code>cat</code> is the identity.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_bidirectional_api">Bidirectional API</h5>
<div class="listingblock">
<div class="title">The response category</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-nf">yield</span> <span class="tok-ow">=</span> <span class="tok-n">respond</span>
<span class="tok-nf">for</span> <span class="tok-ow">=</span> <span class="tok-p">(</span><span class="tok-o">//&gt;</span><span class="tok-p">)</span>
<span class="tok-p">(</span><span class="tok-o">~&gt;</span><span class="tok-p">)</span> <span class="tok-ow">=</span> <span class="tok-p">(</span><span class="tok-o">/&gt;/</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">The reply category</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-nf">await</span> <span class="tok-ow">=</span> <span class="tok-n">request</span> <span class="tok-nb">()</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_lift">Lift</h4>
<div class="paragraph">
<div class="title">StateP</div>
<p>Run <code>StateT</code> in the base monad of the Proxy passed as a second argument.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-nf">runStateP</span>
    <span class="tok-ow">::</span> <span class="tok-p">(</span><span class="tok-kt">Monad</span> <span class="tok-n">m</span><span class="tok-p">)</span>
    <span class="tok-ow">=&gt;</span> <span class="tok-n">s</span> <span class="tok-c1">-- state (usually of type proxy)</span>
    <span class="tok-ow">-&gt;</span> <span class="tok-kt">Proxy</span> <span class="tok-n">a&#39;</span> <span class="tok-n">a</span> <span class="tok-n">b&#39;</span> <span class="tok-n">b</span> <span class="tok-p">(</span><span class="tok-kt">S</span><span class="tok-o">.</span><span class="tok-kt">StateT</span> <span class="tok-n">s</span> <span class="tok-n">m</span><span class="tok-p">)</span> <span class="tok-n">r</span>
    <span class="tok-ow">-&gt;</span> <span class="tok-kt">Proxy</span> <span class="tok-n">a&#39;</span> <span class="tok-n">a</span> <span class="tok-n">b&#39;</span> <span class="tok-n">b</span> <span class="tok-n">m</span> <span class="tok-p">(</span><span class="tok-n">r</span><span class="tok-p">,</span> <span class="tok-n">s</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-c1">-- !! this return a Producer a m (Maybe r, Producer a m r) !!</span>
<span class="tok-c1">-- This makes sense you are actually running the StateT monad from Producer a (StateT (Producer a m r) m r) r</span>
<span class="tok-c1">-- r is either Just which means the original Producer is empty or Nothing which mean you should go on drawing from the original Producer</span>
<span class="tok-c1">-- The top producer accumulates your split, then you have a pair of a Maybe r and your original Producer</span>

<span class="tok-nf">runStateP</span> <span class="tok-n">p</span> <span class="tok-o">$</span> <span class="tok-kr">do</span> <span class="tok-c1">-- p will be used to feed the underlying proxy</span>
    <span class="tok-c1">-- entering a monad of the form: (Proxy (&lt;- StateT monad &lt;- Proxy))</span>
    <span class="tok-c1">-- All computation happens inside the underlying monad that is initially fed up by the param p</span>
    <span class="tok-n">x</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">lift</span> <span class="tok-n">draw</span> <span class="tok-c1">-- lift the next value of the underlying proxy</span>
    <span class="tok-kr">case</span> <span class="tok-n">x</span> <span class="tok-kr">of</span> <span class="tok-c1">-- Left if the underlying proxy is empty or Right with the drawn element</span>
        <span class="tok-kt">Left</span>  <span class="tok-n">r</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">return</span> <span class="tok-p">(</span><span class="tok-kt">Just</span> <span class="tok-n">r</span><span class="tok-p">)</span>
        <span class="tok-kt">Right</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kr">do</span>
            <span class="tok-n">yield</span> <span class="tok-n">a</span> <span class="tok-c1">-- push `a onto the top proxy</span>
            <span class="tok-p">(</span><span class="tok-kt">Just</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">input</span><span class="tok-p">)</span> <span class="tok-o">&gt;-&gt;</span> <span class="tok-p">(</span><span class="tok-kt">Nothing</span> <span class="tok-o">&lt;$</span> <span class="tok-n">takeWhile</span> <span class="tok-p">(</span><span class="tok-o">==</span> <span class="tok-n">a</span><span class="tok-p">))</span>  <span class="tok-c1">-- start streaming values from the underlying proxy</span>
                                                                <span class="tok-c1">--</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_concurrent_api">Concurrent API</h4>
<div class="paragraph">
<p>You have got a mailbox !</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-p">(</span><span class="tok-n">output</span><span class="tok-p">,</span> <span class="tok-n">input</span><span class="tok-p">)</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">spawn</span> <span class="tok-kt">Unbounded</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>producer &gt;-&gt; (consumer) output &gt;...&gt; input (producer) &gt;-&gt; consumer</pre>
</div>
</div>
<div class="paragraph">
<p>Send to the mailbox using <code>toOutput output</code> (output is able to sent mail). So <code>toOutput</code> transforms the output into a consumer.
Read from the mailbox using <code>fromInput input</code> (input is able to receive mail). So <code>fromInput</code> transforms the input into a producer.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-kr">newtype</span> <span class="tok-kt">Input</span> <span class="tok-n">a</span> <span class="tok-ow">=</span> <span class="tok-kt">Input</span> <span class="tok-p">{</span> <span class="tok-n">recv</span> <span class="tok-ow">::</span> <span class="tok-kt">S</span><span class="tok-o">.</span><span class="tok-kt">STM</span> <span class="tok-p">(</span><span class="tok-kt">Maybe</span> <span class="tok-n">a</span><span class="tok-p">)</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_pipes_handle">Pipes-Handle</h4>
<div class="paragraph">
<p>Pipes-handle models the input/output stream analogy. An output stream accepts bytes (you write into it) whereas you read from an inputstream. The proxy that can "read from" in the pipes ecosystem is the consumer.
By analogy, an output stream accepts output bytes and sends them to some sink. So you write into an output stream.</p>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="http://docs.pi3r.be/stream.png"><img src="img/stream.png" alt="Stream"></a>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_pipes_parse">Pipes-Parse</h4>
<div class="paragraph">
<div class="title">Parser</div>
<p>Parser is like Consumers but with the ability to keep the leftover</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-kr">type</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-n">m</span> <span class="tok-n">r</span> <span class="tok-ow">=</span> <span class="tok-n">forall</span> <span class="tok-n">x</span> <span class="tok-o">.</span> <span class="tok-kt">StateT</span> <span class="tok-p">(</span><span class="tok-kt">Producer</span> <span class="tok-n">a</span> <span class="tok-n">m</span> <span class="tok-n">x</span><span class="tok-p">)</span> <span class="tok-n">m</span> <span class="tok-n">r</span>

<span class="tok-nf">draw</span> <span class="tok-ow">::</span> <span class="tok-p">(</span><span class="tok-kt">Monad</span> <span class="tok-n">m</span><span class="tok-p">)</span> <span class="tok-ow">=&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-n">m</span> <span class="tok-p">(</span><span class="tok-kt">Maybe</span> <span class="tok-n">a</span><span class="tok-p">)</span>

<span class="tok-nf">runStateT</span>  <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-n">m</span> <span class="tok-n">r</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Producer</span> <span class="tok-n">a</span> <span class="tok-n">m</span> <span class="tok-n">x</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">m</span> <span class="tok-p">(</span><span class="tok-n">r</span><span class="tok-p">,</span> <span class="tok-kt">Producer</span> <span class="tok-n">a</span> <span class="tok-n">m</span> <span class="tok-n">x</span><span class="tok-p">)</span>
<span class="tok-nf">evalStateT</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-n">m</span> <span class="tok-n">r</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Producer</span> <span class="tok-n">a</span> <span class="tok-n">m</span> <span class="tok-n">x</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">m</span>  <span class="tok-n">r</span>
<span class="tok-nf">execStateT</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-n">m</span> <span class="tok-n">r</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Producer</span> <span class="tok-n">a</span> <span class="tok-n">m</span> <span class="tok-n">x</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">m</span> <span class="tok-p">(</span>   <span class="tok-kt">Producer</span> <span class="tok-n">a</span> <span class="tok-n">m</span> <span class="tok-n">x</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Lenses</div>
<p>Lenses served as transformation in both directions.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-nf">splitAt</span>
    <span class="tok-ow">::</span> <span class="tok-kt">Monad</span> <span class="tok-n">m</span>
    <span class="tok-ow">=&gt;</span> <span class="tok-kt">Int</span>
    <span class="tok-ow">-&gt;</span> <span class="tok-kt">Lens&#39;</span> <span class="tok-p">(</span><span class="tok-kt">Producer</span> <span class="tok-n">a</span> <span class="tok-n">m</span> <span class="tok-n">x</span><span class="tok-p">)</span> <span class="tok-p">(</span><span class="tok-kt">Producer</span> <span class="tok-n">a</span> <span class="tok-n">m</span> <span class="tok-p">(</span><span class="tok-kt">Producer</span> <span class="tok-n">a</span> <span class="tok-n">m</span> <span class="tok-n">x</span><span class="tok-p">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">zoom</div>
<p>Connect lenses to Parsers</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-nf">zoom</span>
    <span class="tok-ow">::</span> <span class="tok-kt">Lens&#39;</span> <span class="tok-p">(</span><span class="tok-kt">Producer</span> <span class="tok-n">a</span> <span class="tok-n">m</span> <span class="tok-n">x</span><span class="tok-p">)</span> <span class="tok-p">(</span><span class="tok-kt">Producer</span> <span class="tok-n">b</span> <span class="tok-n">m</span> <span class="tok-n">y</span><span class="tok-p">)</span>
    <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">b</span> <span class="tok-n">m</span> <span class="tok-n">r</span>
    <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-n">m</span> <span class="tok-n">r</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Iso'</code>: don&#8217;t provide them if there is error messages involved in encoding and decoding. Stick to <code>Lens'</code></p>
</div>
</div>
<div class="sect3">
<h4 id="_pipes_group">Pipes-Group</h4>
<div class="paragraph">
<p>FreeT nests each subsequent Producer within the return value of the previous Producer so that you cannot access the next Producer until you completely drain the current Producer.</p>
</div>
<div class="paragraph">
<p>split / transform / join paradigm</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-c1">-- A &quot;splitter&quot; such as `groupBy`, `chunksOf` or `splitOn`</span>
<span class="tok-kt">Producer</span> <span class="tok-n">a</span> <span class="tok-n">m</span> <span class="tok-nb">()</span>           <span class="tok-ow">-&gt;</span> <span class="tok-kt">FreeT</span> <span class="tok-p">(</span><span class="tok-kt">Producer</span> <span class="tok-n">a</span> <span class="tok-n">m</span><span class="tok-p">)</span> <span class="tok-n">m</span> <span class="tok-nb">()</span>  <span class="tok-o">~</span>   <span class="tok-p">[</span><span class="tok-n">a</span><span class="tok-p">]</span>  <span class="tok-ow">-&gt;</span> <span class="tok-p">[[</span><span class="tok-n">a</span><span class="tok-p">]]</span>

<span class="tok-c1">-- A &quot;transformation&quot; such as `takeFree`</span>
<span class="tok-kt">FreeT</span> <span class="tok-p">(</span><span class="tok-kt">Producer</span> <span class="tok-n">a</span> <span class="tok-n">m</span><span class="tok-p">)</span> <span class="tok-n">m</span> <span class="tok-nb">()</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">FreeT</span> <span class="tok-p">(</span><span class="tok-kt">Producer</span> <span class="tok-n">a</span> <span class="tok-n">m</span><span class="tok-p">)</span> <span class="tok-n">m</span> <span class="tok-nb">()</span>  <span class="tok-o">~</span>  <span class="tok-p">[[</span><span class="tok-n">a</span><span class="tok-p">]]</span> <span class="tok-ow">-&gt;</span> <span class="tok-p">[[</span><span class="tok-n">a</span><span class="tok-p">]]</span>

<span class="tok-c1">-- A &quot;joiner&quot; such as `concat` or `intercalate`</span>
<span class="tok-kt">FreeT</span> <span class="tok-p">(</span><span class="tok-kt">Producer</span> <span class="tok-n">a</span> <span class="tok-n">m</span><span class="tok-p">)</span> <span class="tok-n">m</span> <span class="tok-nb">()</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Producer</span> <span class="tok-n">a</span> <span class="tok-n">m</span> <span class="tok-nb">()</span>            <span class="tok-o">~</span>  <span class="tok-p">[[</span><span class="tok-n">a</span><span class="tok-p">]]</span> <span class="tok-ow">-&gt;</span>  <span class="tok-p">[</span><span class="tok-n">a</span><span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_errors_management">Errors management</h4>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">Empty Bytestring</div>
<div class="paragraph">
<p>If you want to transform a Producer of ByteString into another Producer, for instance of csv records, be careful to be immune of empty bytestring chunks.
Indeed <code>pipes-bytestring</code> operations don&#8217;t guarantee that they won&#8217;t drop empty bytestring chunks or create new ones.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-c1">-- first take the next elem of the source</span>
<span class="tok-nf">x</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">lift</span> <span class="tok-p">(</span><span class="tok-n">next</span> <span class="tok-n">source</span><span class="tok-p">)</span>
        <span class="tok-kr">case</span> <span class="tok-n">x</span> <span class="tok-kr">of</span>
            <span class="tok-kt">Left</span> <span class="tok-nb">()</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">feedParser</span> <span class="tok-p">(</span><span class="tok-n">k</span> <span class="tok-kt">B</span><span class="tok-o">.</span><span class="tok-n">empty</span><span class="tok-p">)</span> <span class="tok-p">(</span><span class="tok-n">return</span> <span class="tok-nb">()</span><span class="tok-p">)</span>
            <span class="tok-kt">Right</span> <span class="tok-p">(</span><span class="tok-n">bs</span><span class="tok-p">,</span> <span class="tok-n">source&#39;</span><span class="tok-p">)</span> <span class="tok-ow">-&gt;</span>
                <span class="tok-kr">if</span> <span class="tok-p">(</span><span class="tok-kt">B</span><span class="tok-o">.</span><span class="tok-n">null</span> <span class="tok-n">bs</span><span class="tok-p">)</span>
                <span class="tok-kr">then</span> <span class="tok-n">continue</span> <span class="tok-n">k</span> <span class="tok-n">source&#39;</span>
                <span class="tok-kr">else</span> <span class="tok-n">feedParser</span> <span class="tok-p">(</span><span class="tok-n">k</span> <span class="tok-n">bs</span><span class="tok-p">)</span> <span class="tok-n">source&#39;</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_managed">Managed</h5>
<div class="paragraph">
<p>You have a resource a that can be acquired and then released.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell bb"><span></span>-- | A @(Managed a)@ is a resource @(a)@ bracketed by acquisition and release
newtype Managed a = Manage
    { -- | Consume a managed resource
      with :: forall x . (a -&gt; IO x) -&gt; IO x
    }
Resource ((forall b. IO b -&gt; IO b) -&gt; IO (Allocated a))</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_arrows_and_push_based_pipe">Arrows and push based pipe</h4>
<div class="paragraph">
<p>Events are discrete &#8592; PUSH based.<br>
Behaviors are continuous &#8592; PULL based</p>
</div>
<div class="paragraph">
<p><code>ArrowChoice</code> corresponds to concurrency and <code>Arrow</code> corresponds to parallelism</p>
</div>
</div>
<div class="sect3">
<h4 id="_controller_model_view">Controller/Model/View</h4>
<div class="paragraph">
<div class="title">Controller</div>
<p>Represent concurrent effectful inputs to your system. A <code>controller</code> is really just a synonym for an <code>Input</code> from <code>pipes-concurrency</code>. So you have this function:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-nf">producer</span> <span class="tok-ow">::</span> <span class="tok-kt">Buffer</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Producer</span> <span class="tok-n">a</span> <span class="tok-kt">IO</span> <span class="tok-nb">()</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Managed</span> <span class="tok-p">(</span><span class="tok-kt">Controller</span> <span class="tok-n">a</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Model</div>
<p>A pure streaming transformation from the combined controller to the combined views.
You can test this pure kernel by swapping out controllers with predicable inputs.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-nf">asPipe</span> <span class="tok-ow">::</span> <span class="tok-kt">Pipe</span> <span class="tok-n">a</span> <span class="tok-n">b</span> <span class="tok-p">(</span><span class="tok-kt">State</span> <span class="tok-n">s</span><span class="tok-p">)</span> <span class="tok-nb">()</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Model</span> <span class="tok-n">s</span> <span class="tok-n">a</span> <span class="tok-n">b</span></code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">View</div>
<p>Handles all effectful outputs from the model.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-nf">asSink</span> <span class="tok-ow">::</span> <span class="tok-p">(</span><span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">IO</span> <span class="tok-nb">()</span><span class="tok-p">)</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">View</span> <span class="tok-n">aa</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Run it</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-nf">runMVC</span> <span class="tok-ow">::</span>
  <span class="tok-n">initialState</span>
  <span class="tok-ow">-&gt;</span> <span class="tok-kt">Model</span> <span class="tok-n">s</span> <span class="tok-n">a</span> <span class="tok-n">b</span>
  <span class="tok-ow">-&gt;</span> <span class="tok-kt">Managed</span> <span class="tok-p">(</span><span class="tok-kt">View</span> <span class="tok-n">b</span><span class="tok-p">,</span> <span class="tok-kt">Controller</span> <span class="tok-n">a</span><span class="tok-p">)</span>
  <span class="tok-ow">-&gt;</span> <span class="tok-kt">IO</span> <span class="tok-n">s</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_questions">Questions</h4>
<div class="paragraph">
<p><a href="https://github.com/Gabriel439/Haskell-Pipes-Parse-Library/blob/2.0.0/src/Pipes/Parse.hs#L236" class="bare">https://github.com/Gabriel439/Haskell-Pipes-Parse-Library/blob/2.0.0/src/Pipes/Parse.hs#L236</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-kr">type</span> <span class="tok-kt">Producer</span> <span class="tok-n">b</span> <span class="tok-ow">=</span>                    <span class="tok-kt">Proxy</span> <span class="tok-kt">Void</span> <span class="tok-nb">()</span> <span class="tok-nb">()</span> <span class="tok-n">b</span>
<span class="tok-kr">type</span> <span class="tok-kt">Producer&#39;</span> <span class="tok-n">b</span> <span class="tok-n">m</span> <span class="tok-n">r</span> <span class="tok-ow">=</span> <span class="tok-n">forall</span> <span class="tok-n">x&#39;</span> <span class="tok-n">x</span> <span class="tok-o">.</span> <span class="tok-kt">Proxy</span> <span class="tok-n">x&#39;</span> <span class="tok-n">x</span> <span class="tok-nb">()</span> <span class="tok-n">b</span> <span class="tok-n">m</span> <span class="tok-n">r</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_resources">Resources</h4>
<div class="ulist">
<ul>
<li>
<p><a href="http://stackoverflow.com/questions/23185690/event-handler-stack/23187159#23187159">Event handler (SOF)</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_dhall">Dhall</h3>
<div class="paragraph">
<p>Dhall is a programming language specialized for configuration files.</p>
</div>
<div class="listingblock">
<div class="title">/config/box</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-p">{</span> <span class="tok-n">userName</span>         <span class="tok-ow">=</span> <span class="tok-s">&quot;&quot;</span>
<span class="tok-p">,</span> <span class="tok-n">userEmail</span>        <span class="tok-ow">=</span> <span class="tok-s">&quot;&quot;</span>
<span class="tok-p">,</span> <span class="tok-n">userStacks</span>       <span class="tok-ow">=</span> <span class="tok-p">[</span><span class="tok-s">&quot;bos&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;irisbox&quot;</span><span class="tok-p">]</span>
<span class="tok-p">,</span> <span class="tok-n">plugins</span>          <span class="tok-ow">=</span> <span class="tok-kt">True</span>
<span class="tok-p">,</span> <span class="tok-n">mrRepoUrl</span>        <span class="tok-ow">=</span> <span class="tok-s">&quot;git://github.com/CIRB/vcsh_mr_template.git&quot;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-cm">{-# LANGUAGE DeriveGeneric #-}</span>

<span class="tok-kr">data</span> <span class="tok-kt">BoxConfig</span>
  <span class="tok-ow">=</span> <span class="tok-kt">BoxConfig</span>
  <span class="tok-p">{</span> <span class="tok-n">_userName</span>        <span class="tok-ow">::</span> <span class="tok-kt">LText</span> <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="tok-p">,</span> <span class="tok-n">_userEmail</span>       <span class="tok-ow">::</span> <span class="tok-kt">LText</span>
  <span class="tok-p">,</span> <span class="tok-n">_userStacks</span>      <span class="tok-ow">::</span> <span class="tok-kt">Vector</span> <span class="tok-kt">LText</span> <i class="conum" data-value="2"></i><b>(2)</b>
  <span class="tok-p">,</span> <span class="tok-n">_plugins</span>         <span class="tok-ow">::</span> <span class="tok-kt">Bool</span>
  <span class="tok-p">,</span> <span class="tok-n">_mrRepoUrl</span>       <span class="tok-ow">::</span> <span class="tok-kt">LText</span>
  <span class="tok-p">}</span> <span class="tok-kr">deriving</span> <span class="tok-p">(</span><span class="tok-kt">Generic</span><span class="tok-p">,</span> <span class="tok-kt">Show</span><span class="tok-p">)</span>

<span class="tok-nf">makeLenses</span> <span class="tok-kt">&#39;&#39;BoxConfig</span>

<span class="tok-kr">instance</span> <span class="tok-kt">Interpret</span> <span class="tok-kt">BoxConfig</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Dhall uses lazy text by default</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Dhall uses vector instead of list</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-nf">main</span> <span class="tok-ow">::</span> <span class="tok-kt">IO</span> <span class="tok-nb">()</span>
<span class="tok-nf">main</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
  <span class="tok-n">box_config</span>  <span class="tok-ow">&lt;-</span> <span class="tok-kt">Dhall</span><span class="tok-o">.</span><span class="tok-n">input</span> <span class="tok-n">auto</span> <span class="tok-s">&quot;./config/box&quot;</span>
  <span class="tok-n">configure</span> <span class="tok-p">(</span><span class="tok-n">box_config</span><span class="tok-o">^.</span><span class="tok-n">userName</span><span class="tok-o">.</span><span class="tok-n">strict</span><span class="tok-p">)</span> <span class="tok-p">(</span><span class="tok-n">box_config</span><span class="tok-o">^.</span><span class="tok-n">userEmail</span><span class="tok-o">.</span><span class="tok-n">strict</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-ch">#! /usr/bin/env bash</span>
readarray arr <span class="tok-o">&lt;&lt;&lt;</span> <span class="tok-k">$(</span>dhall <span class="tok-o">&lt;&lt;&lt;</span> <span class="tok-s1">&#39;(./config/box ).userStacks&#39;</span> <span class="tok-m">2</span>&gt; /dev/null <span class="tok-p">|</span> jq -r <span class="tok-s1">&#39;join (&quot; &quot;)&#39;</span><span class="tok-k">)</span>
<span class="tok-k">for</span> s in <span class="tok-si">${</span><span class="tok-nv">arr</span><span class="tok-si">}</span><span class="tok-p">;</span> <span class="tok-k">do</span>
    <span class="tok-nb">echo</span> <span class="tok-s2">&quot;</span><span class="tok-nv">$s</span><span class="tok-s2">&quot;</span>
<span class="tok-k">done</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_naming_convention">Naming convention</h3>
<div class="sect3">
<h4 id="_algebraic_data_type">Algebraic Data Type</h4>
<div class="paragraph">
<p>Quite common (used in <code>pipes</code>, <code>ekmett</code>, <code>servant</code>, <code>tibbe</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-kr">data</span> <span class="tok-kt">List</span> <span class="tok-n">a</span>
  <span class="tok-ow">=</span> <span class="tok-kt">Cons</span> <span class="tok-n">a</span> <span class="tok-p">(</span><span class="tok-kt">List</span> <span class="tok-n">a</span><span class="tok-p">)</span>
  <span class="tok-o">|</span> <span class="tok-kt">Nil</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Also used for simple <code>sum</code> or <code>product</code> declaration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-kr">data</span> <span class="tok-kt">MySum</span> <span class="tok-ow">=</span> <span class="tok-kt">A</span> <span class="tok-o">|</span> <span class="tok-kt">B</span>
<span class="tok-kr">data</span> <span class="tok-kt">MyProduct</span> <span class="tok-ow">=</span> <span class="tok-kt">MyProduct</span> <span class="tok-kt">Int</span> <span class="tok-kt">String</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_record">Record</h4>
<div class="paragraph">
<p>The most common (used in the <code>lens</code>, <code>fpcomplete</code>, <code>servant</code>, <code>tibbe</code>, <code>hindent</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-kr">data</span> <span class="tok-kt">Person</span> <span class="tok-ow">=</span> <span class="tok-kt">Person</span>
  <span class="tok-p">{</span> <span class="tok-n">_firstName</span> <span class="tok-ow">::</span> <span class="tok-kt">String</span> <span class="tok-c1">-- ^ First name</span>
  <span class="tok-p">,</span> <span class="tok-n">_lastName</span>  <span class="tok-ow">::</span> <span class="tok-kt">String</span> <span class="tok-c1">-- ^ Last name</span>
  <span class="tok-p">}</span> <span class="tok-kr">deriving</span> <span class="tok-p">(</span><span class="tok-kt">Eq</span><span class="tok-p">,</span> <span class="tok-kt">Show</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In order to mimic ADT and to make it easy with the haskell-indentation we could go with this instead (but it is less common !):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-kr">data</span> <span class="tok-kt">Person</span>
  <span class="tok-ow">=</span> <span class="tok-kt">Person</span>
  <span class="tok-p">{</span> <span class="tok-n">_firstName</span> <span class="tok-ow">::</span> <span class="tok-kt">String</span>
  <span class="tok-p">,</span> <span class="tok-n">_lastName</span>  <span class="tok-ow">::</span> <span class="tok-kt">String</span>
  <span class="tok-p">}</span> <span class="tok-kr">deriving</span> <span class="tok-p">(</span><span class="tok-kt">Eq</span><span class="tok-p">,</span> <span class="tok-kt">Show</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_module">Module</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-kr">module</span> <span class="tok-nn">Puppet.Parser</span> <span class="tok-p">(</span>
         <span class="tok-nf">expression</span>
       <span class="tok-p">,</span> <span class="tok-nf">puppetParser</span>
       <span class="tok-p">,</span> <span class="tok-nf">runPParser</span>
       <span class="tok-p">)</span> <span class="tok-kr">where</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_idioms">Idioms</h3>
<div class="sect3">
<h4 id="_maybe">Maybe</h4>
<div class="paragraph">
<p>Use of a <code>case</code> to pattern match a <code>maybe</code> value is quite common:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span>  <span class="tok-n">readline</span> <span class="tok-o">&gt;&gt;=</span> <span class="tok-nf">\</span><span class="tok-kr">case</span>
    <span class="tok-kt">Just</span> <span class="tok-s">&quot;Y&quot;</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">pure</span> <span class="tok-nb">()</span>
    <span class="tok-kr">_</span>        <span class="tok-ow">-&gt;</span> <span class="tok-n">die</span> <span class="tok-s">&quot;Abort&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You might want to define a <code>unwrapWith</code> utility mimicking <code>rust</code> <code>unwrap_with</code> but it would be limited and unpractical:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-c1">-- | Unwrap a maybe value in an io computation</span>
<span class="tok-c1">-- passing an alert action in case of Nothing</span>
<span class="tok-nf">unwrapWith</span> <span class="tok-ow">::</span> <span class="tok-kt">MonadIO</span> <span class="tok-n">io</span> <span class="tok-ow">=&gt;</span> <span class="tok-n">io</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Maybe</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">io</span> <span class="tok-n">a</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-nf">unwrapWith</span> <span class="tok-n">io_alert</span> <span class="tok-n">v</span> <span class="tok-ow">=</span> <span class="tok-n">maybe</span> <span class="tok-n">io_alert</span> <span class="tok-n">pure</span> <span class="tok-n">v</span>
<span class="tok-o">&lt;</span><span class="tok-mi">1</span><span class="tok-o">&gt;</span> <span class="tok-kt">Note</span> <span class="tok-n">how</span> <span class="tok-p">`</span><span class="tok-n">a</span><span class="tok-p">`</span> <span class="tok-n">fixes</span> <span class="tok-n">the</span> <span class="tok-n">input</span><span class="tok-o">/</span><span class="tok-n">output</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>At the end of the day it is better to stick with the 'case pattern-matching' idiom even for simple cases and avoid the less readable <code>maybe</code> variant:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span> <span class="tok-n">readline</span> <span class="tok-o">&gt;&gt;=</span> <span class="tok-nf">\</span><span class="tok-kr">case</span>
   <span class="tok-kt">Nothing</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">die</span> <span class="tok-s">&quot;Abort&quot;</span>
   <span class="tok-kt">Just</span> <span class="tok-n">v</span>  <span class="tok-ow">-&gt;</span> <span class="tok-n">pure</span> <span class="tok-n">v</span>

  <span class="tok-n">readline</span> <span class="tok-o">&gt;&gt;=</span> <span class="tok-n">maybe</span> <span class="tok-p">(</span><span class="tok-n">die</span> <span class="tok-s">&quot;Abort&quot;</span><span class="tok-p">)</span> <span class="tok-n">pure</span> <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>shorter but arguably more cryptic</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_extensions">Extensions</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">Syntax</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>LambdaCase</p>
</li>
<li>
<p>GADTSyntax</p>
</li>
<li>
<p>RankNTypes</p>
</li>
<li>
<p>BangPatterns</p>
</li>
<li>
<p>RecordWildCards</p>
</li>
<li>
<p>DuplicateRecordFields</p>
</li>
<li>
<p>MultiWayIf</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Common</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>ScopedTypeVariables (69)</p>
</li>
<li>
<p>DeriveGeneric (66)</p>
</li>
<li>
<p>TupleSections (59)</p>
</li>
<li>
<p>MultiParamTypeClasses (56)</p>
</li>
<li>
<p>FlexibleInstances (33)</p>
</li>
<li>
<p>FlexibleContexts (31)</p>
</li>
<li>
<p>TypeOperators (29)</p>
</li>
<li>
<p>FunctionalDependencies (15)</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Unknown</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>MonadComprehensions (12)</p>
</li>
<li>
<p>EmptyCase (3)</p>
</li>
<li>
<p>DisambiguateRecordFields (14)</p>
</li>
<li>
<p>RecursiveDo (10)</p>
</li>
<li>
<p>ParallelListComp</p>
</li>
<li>
<p>TypeFamilies,</p>
</li>
<li>
<p>PatternSynonyms</p>
</li>
<li>
<p>PartialTypeSignatures</p>
</li>
<li>
<p>TypeApplications</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_common_functions">Common functions</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-c1">-- give a default and always get an a from a maybe value</span>
<span class="tok-nf">maybe</span><span class="tok-ow">::</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Maybe</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">a</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_gats">GATS</h3>
<div class="paragraph">
<p>GADTs let you associate different type parameters for different data constructors of a type.</p>
</div>
<div class="paragraph">
<p>For example, imagine we represent simple language terms that can only be bool/int literals and And/Add operations between those:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-kr">data</span> <span class="tok-kt">Expr</span> <span class="tok-ow">=</span> <span class="tok-kt">ExprInt</span> <span class="tok-kt">Int</span>
          <span class="tok-o">|</span> <span class="tok-kt">ExprBool</span> <span class="tok-kt">Bool</span>
          <span class="tok-o">|</span> <span class="tok-kt">ExprAnd</span> <span class="tok-kt">Expr</span> <span class="tok-kt">Expr</span>
          <span class="tok-o">|</span> <span class="tok-kt">ExprAdd</span> <span class="tok-kt">Expr</span> <span class="tok-kt">Expr</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This would let us do invalid things like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-kt">ExprAnd</span> <span class="tok-p">(</span><span class="tok-kt">ExprInt</span> <span class="tok-mi">5</span><span class="tok-p">)</span> <span class="tok-p">(</span><span class="tok-kt">ExprBool</span> <span class="tok-kt">True</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Firstly and less importantly, GADTs let us write the same definition using a different notation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-kr">data</span> <span class="tok-kt">Expr</span> <span class="tok-kr">where</span>
  <span class="tok-kt">ExprInt</span>  <span class="tok-ow">::</span> <span class="tok-kt">Int</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Expr</span>
  <span class="tok-kt">ExprBool</span> <span class="tok-ow">::</span> <span class="tok-kt">Bool</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Expr</span>
  <span class="tok-kt">ExprAnd</span>  <span class="tok-ow">::</span> <span class="tok-kt">Expr</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Expr</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Expr</span>
  <span class="tok-kt">ExprAdd</span>  <span class="tok-ow">::</span> <span class="tok-kt">Expr</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Expr</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Expr</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The real point of this notation is that it is an opportunity to associate different constructors of <code>Expr</code> with different type constraints and type parameters:
So you restrict the return value of the</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-kr">data</span> <span class="tok-kt">Expr</span>  <span class="tok-ow">::</span> <span class="tok-o">*</span> <span class="tok-ow">-&gt;</span> <span class="tok-o">*</span> <span class="tok-kr">where</span>
  <span class="tok-kt">ExprInt</span>  <span class="tok-ow">::</span> <span class="tok-kt">Int</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Expr</span> <span class="tok-kt">Int</span>
  <span class="tok-kt">ExprBool</span> <span class="tok-ow">::</span> <span class="tok-kt">Bool</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Expr</span> <span class="tok-kt">Bool</span>
  <span class="tok-kt">ExprAnd</span>  <span class="tok-ow">::</span> <span class="tok-kt">Expr</span> <span class="tok-kt">Bool</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Expr</span> <span class="tok-kt">Bool</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Expr</span> <span class="tok-kt">Bool</span>
  <span class="tok-kt">ExprAdd</span>  <span class="tok-ow">::</span> <span class="tok-kt">Expr</span> <span class="tok-kt">Int</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Expr</span> <span class="tok-kt">Int</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Expr</span> <span class="tok-kt">Int</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This rules out non-sensical terms like:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>ExprAnd (ExprInt 5) (ExprBool True)</pre>
</div>
</div>
<div class="paragraph">
<p>Additionally, GADTs let you add type-class constraints and forall&#8217;d variables to each of the constructors.
For example, let&#8217;s say we want to represent a length-indexed list:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-kr">data</span> <span class="tok-kt">LenList</span> <span class="tok-ow">::</span> <span class="tok-kt">Nat</span> <span class="tok-ow">-&gt;</span> <span class="tok-o">*</span> <span class="tok-ow">-&gt;</span> <span class="tok-o">*</span> <span class="tok-kr">where</span>
  <span class="tok-kt">Nil</span> <span class="tok-ow">::</span> <span class="tok-kt">LenList</span> <span class="tok-mi">0</span> <span class="tok-n">a</span>
  <span class="tok-kt">Cons</span> <span class="tok-ow">::</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">LenList</span> <span class="tok-n">n</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">LenList</span> <span class="tok-p">(</span><span class="tok-mi">1</span> <span class="tok-o">+</span> <span class="tok-n">n</span><span class="tok-p">)</span> <span class="tok-n">a</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that not only do the 2 differing constructors have differing type params (0/1+n), they also have constraints linking the "n" from the "LenList" type index (aka type parameter) to the "n" of the given list.</p>
</div>
<div class="paragraph">
<p>Another important facet of GADTs is that all this extra information is not just used to type-check value constructions as shown above. It also gives you back type information when you do case analysis.
i.e:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-kr">case</span> <span class="tok-n">myLenList</span> <span class="tok-kr">of</span>
  <span class="tok-kt">Nil</span>       <span class="tok-ow">-&gt;</span> <span class="tok-o">...</span> <span class="tok-c1">-- ^ the type of myLenList in this case is inferred to (LenList 0 a)</span>
  <span class="tok-kt">Cons</span> <span class="tok-n">x</span> <span class="tok-n">xs</span> <span class="tok-ow">-&gt;</span> <span class="tok-o">...</span> <span class="tok-c1">-- ^ the type of myLenList in this case is inferred to</span>
                   <span class="tok-p">(</span><span class="tok-kt">LenList</span> <span class="tok-p">(</span><span class="tok-mi">1</span> <span class="tok-o">+</span> <span class="tok-n">n</span><span class="tok-p">)</span> <span class="tok-n">a</span><span class="tok-p">)</span> <span class="tok-n">and</span> <span class="tok-n">the</span> <span class="tok-kr">type</span> <span class="tok-kr">of</span> <span class="tok-n">xs</span> <span class="tok-n">is</span> <span class="tok-n">inferred</span> <span class="tok-n">to</span> <span class="tok-p">(</span><span class="tok-kt">LenList</span> <span class="tok-n">n</span> <span class="tok-n">a</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre> f
To reiterate, the type of the term we're case analyzing is inferred differently according to runtime values (which constructor is chosen).</pre>
</div>
</div>
<div class="paragraph">
<p>Lastly, by allowing interesting types and constraints on each constructor, GADTs implicitly allow existential quantification, and storing of type-class instances inside values.</p>
</div>
<div class="paragraph">
<p>For example, this existentially quantified (and mostly useless) type:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>data SomeShowable = forall a. Show a =&gt; MkSomeShowable a</pre>
</div>
</div>
<div class="paragraph">
<p>Can be represented with GADTs as:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>data SomeShowable where
  MkSomeShowable :: Show a =&gt; a -&gt; SomeShowable</pre>
</div>
</div>
<div class="paragraph">
<p>Note the <code>forall a.</code> can be left implicit in the GADT version.</p>
</div>
<div class="paragraph">
<p>Interestingly, with GADTs, you can have existential quantification only in some of your constructors. You can have differing type-class instances stored inside different constructors.
When you pattern-match your GADT constructor, the instance implicitly comes into scope.</p>
</div>
</div>
<div class="sect2">
<h3 id="_operational">Operational</h3>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>think of monads as sequences of primitive instructions.</p>
</div>
</blockquote>
</div>
</div>
<div class="sect2">
<h3 id="_operator_colloquial_name">Operator colloquial name</h3>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&gt;&gt;=</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bind</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&gt;&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">then</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">*&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">then</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8594;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">to</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">a &#8594; b: a to b</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8592;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bind</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(as it desugars to &gt;&gt;=)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;$&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(f)map</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;$</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">map-replace by</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0 &lt;$ f: "f map-replace by 0"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;*&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ap(ply)</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">$</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">apply to or of</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">after</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">a . b $ c: "a after b applied to c"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">!!</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">index</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">!</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">index, strict</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">a ! b: "a index b", foo !x: foo strict x</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;|&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">or, appbin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">expr &lt;|&gt; term: "expr or term"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">++</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">append</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">[]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">empty list</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">cons</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">::</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">of type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f x :: Int: f x of type Int</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">\</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lambda</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">@</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">as</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">go ll@(l:ls): go ll as l cons ls</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">~</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lazy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">go ~(a,b): go lazy pair a, b</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&gt;=&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">fish</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;=&lt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">left fish</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_developments">Developments</h3>
<div class="listingblock">
<div class="title">generate TAGS</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-nf">hasktags</span> <span class="tok-o">-</span><span class="tok-n">e</span> <span class="tok-n">src</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_blast">Blast</h3>
<div class="paragraph">
<p>Two main ideas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>build two 'isomorphic' AST for the slave and the master. The nodes (shape) is the same but each node is slighlty different in the master and slaves</p>
</li>
<li>
<p>find a way so that the execution of <code>f x</code> can be done in a typed safed way on the slaves using the cache</p>
</li>
<li>
<p>you know from the start how many slaves you have</p>
<div class="dlist">
<dl>
<dt class="hdlist1">Kubernetes</dt>
<dd>
<p>Chaque pod dans Kubernetes possède une adresse IP unique &#8594; One slave == one pod</p>
</dd>
</dl>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>One slave is failing, you get another one inside the pod &#8594; same IP</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_spacemacs">Spacemacs</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_cheatsheet">Cheatsheet</h3>
<div class="sect3">
<h4 id="_magit">Magit</h4>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;SPC&gt; g e</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ediff a file (awesome)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;SPC&gt; g d r</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Revert hunk</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_helm">Helm</h4>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">c-k</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"abort" helm completion !!</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_ido">Ido</h4>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">c-Return</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dired</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">c-o</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">| open in a new buffer</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">c-s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">- open in a new buffer</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_search">Search</h4>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;SPC&gt; s l</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">helm-semantic-or-imenu</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;SPC&gt; s w g</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">search with google</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;SPC&gt; s f</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">search within a path</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;SPC&gt; s s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">helm-swoop</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_misc">Misc</h4>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;SPC&gt; v</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">expand region mode</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;SPC&gt; a u</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"undo-tree-visualize"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;SPC&gt; p f</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">helm-find file for your project !amazing!</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;SPC&gt; f e h</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">open helm spacemacs for help</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;SPC&gt; f S</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">save all buffers</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;SPC&gt; f y</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">show file name</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;SPC&gt; i K</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">insert empty line above</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;SPC&gt; b b</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">helm find buffer</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;SPC&gt; x J / SPC x K</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">move lines up and down i</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;SPC&gt; r y</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">kill ring</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">,gg</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">jump to def (awesome!)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;SPC&gt; p y</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">find tags</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;SPC&gt; /</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ag search</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;SPC&gt; m c R</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">reload .spacemacs</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;SPC&gt; f e d</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">open .spacemacs</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;SPC&gt; n r</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">narrow region</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>(define-key evil-normal-state-map (kbd "C-p C-b") 'ibuffer)</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_surround">Surround</h3>
<div class="paragraph">
<p>Enter visual state with <code>v</code>&gt;&gt; <code>e</code> for selecting expression &gt;&gt; <code>s</code> for surrounding &gt;&gt; <code>)</code> with parents without extra spaces.</p>
</div>
<div class="sect3">
<h4 id="_tramp">Tramp</h4>
<div class="paragraph">
<p>/ssh:saltmaster_testing|sudo:root@saltmaster:/srv/myfile.sls</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_replace_on_multiple_files">Replace on multiple files</h3>

</div>
</div>
</div>
<div class="sect1">
<h2 id="_docker">Docker</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_intro">Intro</h3>
<div class="paragraph">
<p>Containers work by isolating the differences between applications inside the container so that everything outside the container can be standardized.
At the core of container technology are <code>cGroups</code> and <code>namespaces</code>. Control groups work by allowing the host to share and limit the resources each process or container can consume. Processes are limited
to see only the process ID in the same namespace.</p>
</div>
<div class="paragraph">
<p>A Docker environment is made up of filesystems layered over each other. At the base is a boot filesystem, docker&#8217;s next layer is the root filesystem, rootfs. Then Docker takes advantage of a union mount to add more readonly filesystems on top. These filesystems are called "images". Finally, Docker mounts a read-write filesystem on top of any layers below. This is where whatever process we want our Docker container to run will execute.</p>
</div>
<div class="paragraph">
<p>User images are named using "initial/name:tag"</p>
</div>
<div class="paragraph">
<p>The <code>RUN</code> instruction in a <code>Dockerfile</code> executes commands on the current image and commits the results.</p>
</div>
</div>
<div class="sect2">
<h3 id="_useful_command">Useful command</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>docker build -t initial/name .
docker commit containerid imagename
docker ps
docker images
docker run -i -t initial/name /bin/bash
docker run -d --net compose_default puppet/puppet-agent-centos  <i class="conum" data-value="1"></i><b>(1)</b> <i class="conum" data-value="2"></i><b>(2)</b>
docker <span class="tok-nb">exec</span> <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>-d</code> for detached (will run in the background)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>--net compose_default</code> specify the network (this one is created by default by docker-compose)
&lt;3&gt;</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_link">Link</h3>
<div class="paragraph">
<p>Links is used to enable secure communication between two containers. The first container is oddly enough called the child. This is odd because it is usually a server and it has to be started first &#8230;&#8203; The first container will expose a port and be labelled with a name.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Child or first container</span>
sudo docker run -i -t -h puppet -name puppetmaster pra/pmaster /bin/bash

<span class="tok-c1"># Parent or second container have all info to connect to the first</span>
sudo docker run -i -t -h minion -name minion -link puppetmaster:puppet pra/minion /bin/bash</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ssh_tunnel">SSH-tunnel</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>ssh -q -M -S my-ctrl-socket -fnNT -L <span class="tok-m">27017</span>:localhost:27017 alhazen@pulp.irisnet.be

<span class="tok-c1"># to use the host network: --net host</span>
docker run --net host -e <span class="tok-nv">PULP_LOGIN</span><span class="tok-o">=</span><span class="tok-k">$(</span>PULP_LOGIN<span class="tok-k">)</span> -e <span class="tok-nv">PULP_PWD</span><span class="tok-o">=</span><span class="tok-k">$(</span>PULP_PWD<span class="tok-k">)</span> --rm -v <span class="tok-k">$(</span>PWD<span class="tok-k">)</span>:/code -ti <span class="tok-nb">test</span> /code/bin/clean.py <span class="tok-k">$(</span>ENV<span class="tok-k">)</span> --repo-name<span class="tok-o">=</span><span class="tok-k">$(</span>REPO_ID<span class="tok-k">)</span>

ssh -q -S my-ctrl-socket -O <span class="tok-nb">exit</span> alhazen@pulp.irisnet.be <span class="tok-m">2</span>&gt; /dev/null</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_export_import">Export/Import</h3>
<div class="paragraph">
<p>Export acts on containers ! It currently does not work from containers to images &#8230;&#8203; It is really briddle right now (just wait for 1.0)</p>
</div>
<div class="paragraph">
<p>In the meanwhile it is possible to use any image as your base image in the Dockfile &#8230;&#8203;</p>
</div>
</div>
<div class="sect2">
<h3 id="_mount">Mount</h3>
<div class="paragraph">
<p>You cannot mount a host dir with the VOLUME instruction inside the Dockerfile. You need to pass it at runtime :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># !! first -v, then -t !!</span>
run -it -v /media/puppet-stack-middleware:/etc/puppet/environments/middleware_local:ro pra/puppetmaster /bin/bash

docker run -it -v /media/puppet-stack-middleware:/etc/puppet/environments/middleware_local:ro pra/puppetmaster /bin/bash</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_initial_win7_host_setup">Initial Win7 host setup</h3>
<div class="paragraph">
<p>Win7 hosts a docker ubuntu VM (standard install) using vagrant.</p>
</div>
<div class="paragraph">
<p>Change the Vagrantfile to mount the shared `puppet-stack-middleware`directory:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>config.vm.share_folder "puppet-stack-middleware", "/media/puppet-stack-middleware", "C:/Users/pradermecker/VirtualBox VMs/shared/puppet-stack-middleware"</pre>
</div>
</div>
<div class="paragraph">
<p>Connection to the docker vms from an arch vms with:</p>
</div>
<div class="paragraph">
<p><code>ssh -p 2222 vagrant@10.0.2.2</code></p>
</div>
<div class="paragraph">
<p>Create a dir <code>puppetmaster</code> and a file inside called <code>Dockerfile</code>. Build with <code>sudo docker build .</code></p>
</div>
<div class="paragraph">
<p>Then you need to ssh-copy-id your public id_rsa.pub key to be able to fetch the Docker configuration from Github.</p>
</div>
</div>
<div class="sect2">
<h3 id="_trouble_shouting">Trouble Shouting</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">WARNING</dt>
<dd>
<p>In centos <code>6.4</code> <code>usePAM</code> needs to be set to <code>no</code> while it needs to be set to <code>yes</code> in <code>6.5</code></p>
</dd>
<dt class="hdlist1">WARNING</dt>
<dd>
<p>The Centos latest official images, currently 6.5, comes with a broken <code>centos.plus</code> version of <code>libselinux</code>. To remove it you need to:</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>yum downgrade --skip-broken libselinux libselinux-utils</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_docker_compose">Docker compose</h3>

</div>
<div class="sect2">
<h3 id="_swarm_node">Swarm node</h3>
<div class="paragraph">
<p>Each node is configured by puppet and contain:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a container swarm running inside a docker (spawn with the docker engine daemon)</p>
</li>
<li>
<p>a docker registrator running inside a docker (spawn with the docker engine daemon)</p>
</li>
<li>
<p>a consult agent (doesn&#8217;t run within a docker)</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_dns">DNS</h3>
<div class="paragraph">
<p>You can use <code>Consul</code> as a DNS service. <code>dnsmask</code> is configured within each swarm node while every dockers inside a node is running with <code>--dns 172.17.0.1</code>.<sup class="footnote">[<a id="_footnoteref_7" class="footnote" href="#_footnote_7" title="View footnote.">7</a>]</sup></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_salt">Salt</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_targeting">Targeting</h3>
<div class="sect3">
<h4 id="_minion_id">Minion id</h4>
<div class="ulist">
<ul>
<li>
<p>unique (FQDN by default)</p>
</li>
<li>
<p>can be overridden in the minion config file</p>
</li>
<li>
<p>if changed, P/P keys need to be regenerated</p>
</li>
<li>
<p>match by shell-style globbing around the minion id or top file</p>
</li>
<li>
<p>use single quote</p>
</li>
<li>
<p>Perl-compatible regex can be used with the -E option</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="Shell"><span></span>salt &#39;*.be.brussels&#39; test.ping
salt -L &#39;web1,web2,web3&#39; disk.usage
salt -E &#39;web[0-9]&#39; cmd.exec_code python &#39;import sys; print sys.version&#39;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>base:
<span class="tok-s1">&#39;web-(develjstaging)&#39;</span>
  - match: pcre
  - webserver</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_grains">Grains</h4>
<div class="ulist">
<ul>
<li>
<p>static bits of information that a minion collects when the minion starts</p>
</li>
<li>
<p>can be statically described in the minion config file with the option grains</p>
</li>
<li>
<p>available to Salt modules</p>
</li>
<li>
<p>automatically sync when state.highstate is called.</p>
<div class="literalblock">
<div class="content">
<pre>salt -G 'os:CentOS' --batch-size 25% grains.item num_cpus</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_node_groups">Node groups</h4>
<div class="ulist">
<ul>
<li>
<p>predefined group of minions declared in the master</p>
</li>
<li>
<p>declared using compound matchers (see doc)</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_salt_states">Salt states</h3>
<div class="paragraph">
<p>Use SLS files (SaLt State) to represent the state of a system.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>SLS files are just dictionaries, lists, strings, and numbers (HighState data structure)</p>
</li>
<li>
<p>default serialization format is YAML with the Jinja2 templating system</p>
</li>
<li>
<p>system data and function can be used via salt, grain and pillar</p>
</li>
<li>
<p>files are combined to form a salt state tree using source, include and extend</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">declaration-id</span><span class="tok-p tok-p-Indicator">:</span> <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">pkg</span><span class="tok-p tok-p-Indicator">:</span>
    <span class="tok-p tok-p-Indicator">-</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">installed</span>
  <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">service</span><span class="tok-p tok-p-Indicator">:</span>
    <span class="tok-p tok-p-Indicator">-</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">running</span>
    <span class="tok-p tok-p-Indicator">-</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">watch</span><span class="tok-p tok-p-Indicator">:</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-p tok-p-Indicator">-</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">pkg</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">apache</span>
    <span class="tok-p tok-p-Indicator">-</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">file</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/etc/httpd/conf/httpd.conf</span>

<span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/etc/httpd/conf/httpd.conf</span><span class="tok-p tok-p-Indicator">:</span>
  <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">file.managed</span><span class="tok-p tok-p-Indicator">:</span>
    <span class="tok-p tok-p-Indicator">-</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">source</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">salt://apache/httpd.conf</span>
    <span class="tok-p tok-p-Indicator">-</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">user</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">root</span>
    <span class="tok-p tok-p-Indicator">-</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">group</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">root</span>
    <span class="tok-p tok-p-Indicator">-</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">mode</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">644</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><strong>declaration-id</strong> set the name of the thing that needs to be manipulated</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><strong>watch</strong> &amp; <strong>require</strong> to manage order and events</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="shell"><span></span># given a sls web/apache.sls
salt &#39;*&#39; state.sls web.apache</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_salt_file_server_top_file_environment">Salt file server &amp; top file &amp; environment</h4>
<div class="paragraph">
<p>The <strong>top file</strong> is used to map what modules get loaded onto what minions</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">base</span><span class="tok-p tok-p-Indicator">:</span> <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="tok-s">&#39;bmob&#39;</span><span class="tok-p tok-p-Indicator">:</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-p tok-p-Indicator">-</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">packages</span> <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>environment</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>target for state.highstate</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>sls module name</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <strong>file server</strong> is  suitable for distributing files to minions</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">file_roots</span><span class="tok-p tok-p-Indicator">:</span>
  <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">base</span><span class="tok-p tok-p-Indicator">:</span>
    <span class="tok-p tok-p-Indicator">-</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/srv/salt</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_external_auth">External Auth</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-c1"># The external auth system</span>
<span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">external_auth</span><span class="tok-p tok-p-Indicator">:</span>
  <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">ldap</span><span class="tok-p tok-p-Indicator">:</span>
    <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">GP_APP_JENKINS%</span><span class="tok-p tok-p-Indicator">:</span>
         <span class="tok-p tok-p-Indicator">-</span> <span class="tok-s">&#39;test.*&#39;</span>
         <span class="tok-p tok-p-Indicator">-</span> <span class="tok-s">&#39;grains.*&#39;</span>
         <span class="tok-p tok-p-Indicator">-</span> <span class="tok-s">&#39;pillar.*&#39;</span>
    <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">pradermecker</span><span class="tok-p tok-p-Indicator">:</span>
      <span class="tok-p tok-p-Indicator">-</span> <span class="tok-s">&#39;G@hostname:middleware&#39;</span><span class="tok-p tok-p-Indicator">:</span> <i class="conum" data-value="1"></i><b>(1)</b>
         <span class="tok-p tok-p-Indicator">-</span> <span class="tok-s">&#39;.*&#39;</span>
         <span class="tok-p tok-p-Indicator">-</span> <span class="tok-s">&#39;@runner&#39;</span> <i class="conum" data-value="2"></i><b>(2)</b>
         <span class="tok-p tok-p-Indicator">-</span> <span class="tok-s">&#39;@wheel&#39;</span>
         <span class="tok-p tok-p-Indicator">-</span> <span class="tok-s">&#39;@jobs&#39;</span>
    <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">jfroche</span><span class="tok-p tok-p-Indicator">:</span>
         <span class="tok-p tok-p-Indicator">-</span> <span class="tok-s">&#39;saltutil.*&#39;</span>
         <span class="tok-p tok-p-Indicator">-</span> <span class="tok-s">&#39;@runner&#39;</span>
         <span class="tok-p tok-p-Indicator">-</span> <span class="tok-s">&#39;@wheel&#39;</span>
         <span class="tok-p tok-p-Indicator">-</span> <span class="tok-s">&#39;@jobs&#39;</span>

<span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">auth.ldap.basedn</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">OU=ACCOUNTS,OU=CIRB-CIBG,DC=ad,DC=cirb,DC=lan</span>
<span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">auth.ldap.binddn</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">CN=&lt;%= @ldap_name %&gt;,OU=Saltmasters,OU=Apps,OU=Service_Groups_Accounts,OU=ACCOUNTS,OU=CIRB-CIBG,DC=ad,DC=cirb,DC=lan</span>
<span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">auth.ldap.bindpw</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">&lt;%= @ldap_pwd %&gt;</span>
<span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">auth.ldap.filter</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">(sAMAccountName={{username}})</span>
<span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">auth.ldap.port</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">389</span>
<span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">auth.ldap.server</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">svidscavw003.prd.srv.cirb.lan</span>
<span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">auth.ldap.tls</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">False</span>
<span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">auth.ldap.no_verify</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">True</span>
<span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">auth.ldap.activedirectory</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">True</span>
<span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">auth.ldap.groupclass</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">group</span>
<span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">auth.ldap.accountattributename</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">sAMAccountName</span>
<span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">auth.ldap.persontype</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">person</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Define the allow targets (compount). No relation to the salt notion of environment.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Access to the runner module but this work only via the <code>salt-api</code>
On the command line, <code>salt-run</code> does not support the <code>pam</code> or <code>ldap</code> flag.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_standalone_minions">Standalone minions</h3>
<div class="paragraph">
<p>Minion can run without master.
In the minion config file, set the option <code>file client: local</code></p>
</div>
<div class="paragraph">
<p>By default the contents of the master configuration file are loaded into pillar for all minions, this is to enable the master configuration file to be used for global configuration of minions. To disable the master config from being added to the pillar set pillar_opts to False.</p>
</div>
</div>
<div class="sect2">
<h3 id="_master_event">Master Event</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nv">event</span> <span class="tok-o">=</span> salt.utils.event.MasterEvent<span class="tok-o">(</span><span class="tok-s1">&#39;/home/vagrant/projects/jules/var/run/salt/master&#39;</span><span class="tok-o">)</span>
event.get_event<span class="tok-o">(</span><span class="tok-nv">wait</span><span class="tok-o">=</span><span class="tok-m">20</span>, <span class="tok-nv">tag</span><span class="tok-o">=</span><span class="tok-s1">&#39;salt&#39;</span><span class="tok-o">)</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_pillars">Pillars</h3>
<div class="paragraph">
<p>The data can be arbitrary.
The pillar is built in a similar fashion as the state tree, it is comprised of sls files and has a top file, just like the state
tree.
The default location for the pillar is in /srv/pillar ("pillar_roots" master config key).</p>
</div>
</div>
<div class="sect2">
<h3 id="_gitfs">GITFS</h3>
<div class="paragraph">
<p>When using the gitfs backend, Salt translates git branches and tags into environments, making environment management very simple.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">fileserver_backend</span><span class="tok-p tok-p-Indicator">:</span>
  <span class="tok-p tok-p-Indicator">-</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">git</span>

<span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">gitfs_remotes</span><span class="tok-p tok-p-Indicator">:</span>
  <span class="tok-p tok-p-Indicator">-</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">http://stash.cirb.lan/scm/middleware/salt-stack.git</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_salt_api">Salt API</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="shell"><span></span>curl -si 192.168.30.100:8000/login \
        -H &quot;Accept: application/json&quot; \
        -d username=&#39;jfroche&#39; \
        -d password=&#39;xMLrzzzz&#39; \
        -d eauth=&#39;pam&#39; &gt; /tmp/cookies.txt
curl -b /tmp/cookies.txt -si 192.168.30.100:8000 \
    -d client=&#39;runner&#39; \
    -d mods=&#39;orchestration.bootstrap-puppet&#39; \
    -d fun=&#39;state.orchestrate&#39; \
    -d eauth=&#39;pam&#39;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_orchestration">Orchestration</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-o">[</span>main<span class="tok-o">]</span>
<span class="tok-nv">SALTAPI_URL</span><span class="tok-o">=</span>http://saltmaster.sandbox.srv.cirb.lan:8000
<span class="tok-nv">SALTAPI_USER</span><span class="tok-o">=</span>pradermecker
<span class="tok-nv">SALTAPI_PASS</span><span class="tok-o">=</span>pass
<span class="tok-nv">SALTAPI_EAUTH</span><span class="tok-o">=</span>pam</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>salt-run state.orchestrate orch.test <span class="tok-nv">saltenv</span><span class="tok-o">=</span>middleware <i class="conum" data-value="1"></i><b>(1)</b>
pepper <span class="tok-s1">&#39;*&#39;</span> test.ping
pepper <span class="tok-s1">&#39;puppetmaster2*&#39;</span>  grains.item subgroup role
pepper --client<span class="tok-o">=</span>runner state.orchestrate <span class="tok-nv">mods</span><span class="tok-o">=</span>orchestration.bootstrap-puppet</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>pick up the gitfs branch that host <code>orch.test</code> source</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span>
<span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">set_puppet_role_to_master</span><span class="tok-p tok-p-Indicator">:</span>
    <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">salt.function</span><span class="tok-p tok-p-Indicator">:</span>
        <span class="tok-p tok-p-Indicator">-</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">name</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">utils.set_role</span>
        <span class="tok-p tok-p-Indicator">-</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">tgt</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-s">&#39;G@role:server</span><span class="tok-nv"> </span><span class="tok-s">and</span><span class="tok-nv"> </span><span class="tok-s">G@subgroup:puppet&#39;</span>
        <span class="tok-p tok-p-Indicator">-</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">kwarg</span><span class="tok-p tok-p-Indicator">:</span>
            <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">role</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">master</span>
        <span class="tok-p tok-p-Indicator">-</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">require</span><span class="tok-p tok-p-Indicator">:</span>
          <span class="tok-p tok-p-Indicator">-</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">salt</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">run_saltmaster</span>

<span class="tok-c1"># /srv/salt/orch/test-puppet.sls</span>
<span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">run_puppet_jenkinsmaster</span><span class="tok-p tok-p-Indicator">:</span>
    <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">salt.state</span><span class="tok-p tok-p-Indicator">:</span> <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="tok-p tok-p-Indicator">-</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">sls</span><span class="tok-p tok-p-Indicator">:</span>
          <span class="tok-p tok-p-Indicator">-</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">puppet</span> <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="tok-p tok-p-Indicator">-</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">tgt</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-s">&#39;G@role:master</span><span class="tok-nv"> </span><span class="tok-s">and</span><span class="tok-nv"> </span><span class="tok-s">G@subgroup:jenkins&#39;</span>
        <span class="tok-p tok-p-Indicator">-</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">tgt_type</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">compound</span>

<span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">ping_saltmaster</span><span class="tok-p tok-p-Indicator">:</span>
    <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">salt.function</span><span class="tok-p tok-p-Indicator">:</span> <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-p tok-p-Indicator">-</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">name</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">test.ping</span>
        <span class="tok-p tok-p-Indicator">-</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">tgt</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-s">&#39;role:saltmaster&#39;</span>
        <span class="tok-p tok-p-Indicator">-</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">tgt_type</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">grain</span>
        <span class="tok-p tok-p-Indicator">-</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">require</span><span class="tok-p tok-p-Indicator">:</span> <i class="conum" data-value="2"></i><b>(2)</b>
           <span class="tok-p tok-p-Indicator">-</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">salt</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">run_puppet_jenkinsmaster</span>

<span class="tok-c1"># /srv/salt/puppet.sls:</span>
<span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">puppet</span><span class="tok-p tok-p-Indicator">:</span>
    <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">module.run</span><span class="tok-p tok-p-Indicator">:</span>
        <span class="tok-p tok-p-Indicator">-</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">name</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">cmd.run</span>
        <span class="tok-p tok-p-Indicator">-</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">arg</span><span class="tok-p tok-p-Indicator">:</span>
           <span class="tok-p tok-p-Indicator">-</span> <span class="tok-s">&#39;puppet</span><span class="tok-nv"> </span><span class="tok-s">agent</span><span class="tok-nv"> </span><span class="tok-s">--verbose</span><span class="tok-nv"> </span><span class="tok-s">--onetime</span><span class="tok-nv"> </span><span class="tok-s">--no-daemonize</span><span class="tok-nv"> </span><span class="tok-s">--color</span><span class="tok-nv"> </span><span class="tok-s">false&#39;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>To execute a function, use salt.function</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Force order</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>To execute a module, use salt.state</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Execute the module /srv/salt/puppet.sls</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_salt_ssl">Salt SSL</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="shell"><span></span>make salt-ssh HOST=jenkins2 ZONE=prod CMD=&quot;state.sls utils.migrate_puppet3&quot;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_useful_commands">Useful commands</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="shell"><span></span>salt &#39;*&#39; saltutil.sync_all
pep &#39;svappcavl704.dev.srv.cirb.lan&#39; cmd.run &quot;cat /etc/salt/master&quot; | jq &#39;.return[]&#39; | jq -r &#39;.[]&#39;
pep &#39;svappcsvl028.prd.srv.cirb.lan&#39; cmd.run &quot;cat /etc/salt/master&quot; | jq &#39;.return[]&#39; | jq -r &#39;.[]&#39;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_postgrest">Postgrest</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>http://pgserver.sandbox.srv.cirb.lan:3000/jids?jid<span class="tok-o">=</span>eq.20150831150415858891
http://pgserver.sandbox.srv.cirb.lan:3000/salt_returns?full_ret-&gt;&gt;jid<span class="tok-o">=</span>eq.20150831150437889173</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_install_prd_bootstrap">Install PRD / Bootstrap</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1">## get salt/puppet version we want</span>
<span class="tok-c1">## We do need to update puppet because the current salt config does not work wih &lt; 3.8</span>
yum versionlock delete <span class="tok-m">0</span>:*
yum install salt-master salt-minion puppet
<span class="tok-c1"># temp /etc/hosts to point to the new salt master</span>
systemctl start salt-master
systemctl start salt-minion
salt <span class="tok-s1">&#39;*&#39;</span> saltutil.sync_all

<span class="tok-c1">## we need to manually change the config of /etc/salt/master:</span>
<span class="tok-c1">#</span>
<span class="tok-c1">#  file_roots:</span>
<span class="tok-c1">#    base:</span>
<span class="tok-c1">#      - /srv/salt/</span>
<span class="tok-c1">#    middleware:</span>
<span class="tok-c1">#      - /srv/salt/middleware</span>

<span class="tok-c1">## new puppetmaster, foreman, puppetdb, pgserver</span>
<span class="tok-c1"># temp /etc/hosts to point to the new salt master</span>

<span class="tok-c1"># we still need to manually</span>
yum makecache fast
yum update -y
yum clean all

<span class="tok-c1"># we still need to manually</span>
mkdir -p /etc/facter/facts.d/
vim /etc/facter/facts.d/host-info.txt

<span class="tok-c1"># and finally we need piera to get hiera data before we can bootstrap ...</span>


<span class="tok-c1">## Do test every pings are working correctly</span>

salt-run state.orchestrate orch.ping <span class="tok-nv">saltenv</span><span class="tok-o">=</span>middleware

<span class="tok-c1">## There are issues when puppetconfig restart the minion during the orchestration process</span>
<span class="tok-c1">## Let&#39;s do it manually</span>

salt -C <span class="tok-s1">&#39;G@role:master and G@subgroup:puppet and G@hostgroup:middleware&#39;</span> puppetutils.run_apply  <span class="tok-nv">hostgroup</span><span class="tok-o">=</span>middleware <span class="tok-nv">role</span><span class="tok-o">=</span>server <span class="tok-nv">zone</span><span class="tok-o">=</span>prod <span class="tok-nv">subgroup</span><span class="tok-o">=</span>puppet


salt -C <span class="tok-s1">&#39;G@role:saltmaster and G@hostgroup:middleware and G@zone:prod&#39;</span> puppetutils.install_stackrpm <span class="tok-nv">hostgroup</span><span class="tok-o">=</span>middleware <span class="tok-nv">zone</span><span class="tok-o">=</span>prod

salt -C <span class="tok-s1">&#39;G@role:saltmaster and G@hostgroup:middleware and G@zone:prod&#39;</span> puppetutils.run_apply <span class="tok-nv">hostgroup</span><span class="tok-o">=</span>middleware <span class="tok-nv">role</span><span class="tok-o">=</span>saltmaster <span class="tok-nv">zone</span><span class="tok-o">=</span>prod

salt -C <span class="tok-s1">&#39;G@role:pgserver and G@hostgroup:middleware and G@zone:prod&#39;</span> puppetutils.run_agent <span class="tok-nv">hostgroup</span><span class="tok-o">=</span>middleware <span class="tok-nv">zone</span><span class="tok-o">=</span>prod</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_issues">Issues</h3>
<div class="ulist">
<ul>
<li>
<p>When the master restart, windows minion does not seem to be able to reconnect (without a minion restart)
/etc/httpd/conf/httpd.conf:</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_git">Git</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_internals">Internals</h3>
<div class="paragraph">
<p>Git maintained snapshot of directory&#8217;s contents. It is a content-addressable filesystem, a simple key value data store. Keys are SHA-1 hash and values are objects.</p>
</div>
<div class="paragraph">
<p>There are 4 different types of objects:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Blob stores files (it does not store the name of the file)</p>
</li>
<li>
<p>Tree references other trees and/or blobs, stores the file name and groups them together (as directories do)</p>
</li>
<li>
<p>Commit points to a single tree and realize "snapshots".</p>
</li>
<li>
<p>Tag marks a specific commit</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_tips">Tips</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">Ignore files in all projects but keep this for yourself</dt>
<dd>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add to your ~/.gitconfig file</p>
<div class="literalblock">
<div class="content">
<pre>```
[core]
excludesfile = /home/username/.gitignore
```</pre>
</div>
</div>
</li>
<li>
<p>Create a ~/.gitignore file with file patterns to be ignored</p>
</li>
</ol>
</div>
</dd>
<dt class="hdlist1">Delete a range of tags both locally and remotely</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-k">for</span> i in <span class="tok-sb">`</span>seq <span class="tok-m">248</span> <span class="tok-m">638</span><span class="tok-sb">`</span><span class="tok-p">;</span> <span class="tok-k">do</span> git tag -d <span class="tok-nv">$i</span><span class="tok-p">;</span> git push --delete origin <span class="tok-nv">$i</span><span class="tok-p">;</span><span class="tok-k">done</span></code></pre>
</div>
</div>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_linux">Linux</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_script">Script</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-ch">#!/bin/bash -xe</span>
<span class="tok-k">while</span> <span class="tok-nb">read</span> host
<span class="tok-k">do</span>
       cat plone_team.pub <span class="tok-p">|</span> ssh alhazen@<span class="tok-s2">&quot;</span><span class="tok-nv">$host</span><span class="tok-s2">&quot;</span>.prd.srv.cirb.lan <span class="tok-s2">&quot;grep plone ~/.ssh/authorized_keys || cat &gt;&gt; ~/.ssh/authorized_keys&quot;</span>
<span class="tok-k">done</span> &lt; plone-prod-uniq.txt</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>pandoc --latex-engine<span class="tok-o">=</span>xelatex -o blog.pdf http://blog.jakubarnold.cz/2014/07/22/building-monad-transformers-part-1.html</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_lvm">LVM</h3>
<div class="ulist">
<ul>
<li>
<p>change disk size on the VCloud</p>
</li>
<li>
<p>create a new partition with fdisk (ie: sdb1) so we don&#8217;t change anything on the existing partition table</p>
</li>
<li>
<p>add this new partition as a new physical volume: <code>pvcreate /dev/sdb1</code></p>
</li>
<li>
<p><code>vgextend system_vg /dev/sdb1</code></p>
</li>
<li>
<p><code>lvextend -L+12G /dev/system_vg/data</code></p>
</li>
<li>
<p><code>xfs_growfs /dev/system_vg/data</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>or by adding a new disk using puppet :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>add a new disk on the VCloud</p>
</li>
<li>
<p>after a few delay, VCloud will automatically create a new partition for instance '/dev/sdd'</p>
</li>
<li>
<p>add this new partition as a new physical volume: <code>pvcreate /dev/sdd</code>. You bb can see it with <code>pvs</code></p>
</li>
<li>
<p><code>vgextend vg_rhel /dev/sdd</code> (the name to 'vg_rhel' is fixed for our new RHEL 7 template)</p>
</li>
<li>
<p><code>puppet agent -t</code> will now create a new lv <code>nix</code>. You can see it with <code>lvs</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>at the CIRB the easier is:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>to ask for a machine with 40G (second disk usually /dev/sdb)</p>
</li>
<li>
<p>The machine will be received with a full <code>vg_rhel</code> of 40G. Go to the vcloud console and extend the second disk to 60G</p>
</li>
<li>
<p>The machine now has a /dev/sdb disk with 60G. Extends the pv using <code>pvresize -v /dev/sdb</code>. And check with <code>vgdisplay or pvs</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_tips_2">Tips</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">Add route in windows</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>route ADD <span class="tok-m">192</span>.168.30.0 MASK <span class="tok-m">255</span>.255.255.0 <span class="tok-m">10</span>.255.10.4</code></pre>
</div>
</div>
</dd>
<dt class="hdlist1">SCP copy from local to remote</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>scp -i ~/.ssh/user_rsa -r folder user@svifscapl003.prd.srv.cirb.lan:/tmp</code></pre>
</div>
</div>
</dd>
<dt class="hdlist1">SCP copy from remote to remote</dt>
<dd>
<p>Using your local computer</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>ssh-add ~/.ssh/alhazen_rsa
<span class="tok-c1"># Give alhazen the permission to write on targetfqdn:/srv/tmp</span>
ssh -A -i  ~/.ssh/alhazen_rsa alhazen@sourcefqdn <span class="tok-se">\</span>
<span class="tok-s2">&quot;scp -o StrictHostKeyChecking=No /srv/data/pgserver.dump alhazen@targetfqdn:/srv/tmp&quot;</span></code></pre>
</div>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_definitions">Definitions</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">Push (SSE) vs Pull (REQ/REP)</dt>
<dt class="hdlist1">Application layer</dt>
<dd>
<p>HTTP, SNMP, AMQP, XMPP, IRC, DHCP, WebDAV, SSH, FTP, SIP, Telnet</p>
</dd>
<dt class="hdlist1">Transport layer</dt>
<dd>
<p>TCP, UDP (SCTP)</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_logs">Logs</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>journalctl -r - show logs in reverse order
journalctl -b - show logs since last boot
journalctl -k - show kernel logs
journalctl -p warning - show logs with warning priority
journalctl -p error - show logs with error priority
journalctl --since<span class="tok-o">=</span><span class="tok-m">2016</span>-08-01 - show logs since
journalctl --until<span class="tok-o">=</span><span class="tok-m">2016</span>-08-03 - show logs <span class="tok-k">until</span>
journalctl --until<span class="tok-o">=</span>today - show logs <span class="tok-k">until</span> midnight today
journalctl --since<span class="tok-o">=</span>yesterday - show logs since yesterday midnight
journalctl --since<span class="tok-o">=</span>-2week - show logs <span class="tok-k">for</span> last <span class="tok-m">2</span> weeks
journalctl -u &lt;unit-name&gt; - show logs of certain unit
journalctl /dev/sda - show kernel message of device
journalctl -o json - show logs in json format</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_postgres">Postgres</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_general">General</h3>
<div class="sect3">
<h4 id="_glossary">Glossary</h4>
<div class="dlist">
<dl>
<dt class="hdlist1">PEM</dt>
<dd>
<p>Postgres Enterprise Manager</p>
</dd>
<dt class="hdlist1">PPAS</dt>
<dd>
<p>Postgres Plus Advanced Server</p>
</dd>
<dt class="hdlist1">WAL</dt>
<dd>
<div class="paragraph">
<p>At all times, PostgreSQL maintains a WAL (Write Ahead Log) in the pg_xlog/ subdirectory of the cluster&#8217;s data directory. The log describes every change made to the database&#8217;s data files. This log exists primarily for crash-safety purposes: if the system crashes, the database can be restored to consistency by "replaying" the log entries made since the last checkpoint. However, the existence of the log makes it possible to use a third strategy for backing up databases: we can combine a file-system-level backup with backup of the WAL files. If recovery is needed, we restore the backup and then replay from the backed-up WAL files to bring the backup up to current time.</p>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_architecture">Architecture</h4>
<div class="paragraph">
<p>One process per user, NO THREAD !
Processes are managed by Postmaster that acts as a listener for new connection and as a supervisor to restart them.</p>
</div>
<div class="paragraph">
<p>The term "buffer" is usually used for blocks in memory.</p>
</div>
<div class="paragraph">
<p>7500 concurrent user &#8594; connection pooling</p>
</div>
<div class="paragraph">
<p>16MB</p>
</div>
</div>
<div class="sect3">
<h4 id="_cluster">Cluster</h4>
<div class="paragraph">
<p>A cluster is a collection of databases. Clusters have separate:
	* data directory
	* TCP port
	* set of processes</p>
</div>
<div class="paragraph">
<p>To create a cluster execute the following comming with the postgres user (! not root !):
	[postgres]$ initdb --locale en_US.UTF-8 -E UTF8 -D '/var/lib/postgres/data'</p>
</div>
<div class="paragraph">
<p>To create a second cluster on the same machine you need to:
	* as root, create a DATA directory
	* as root, change owner of the DATA directory to enterprisedb or postgres (depending on the version of postgres enterprise or community)
	* as postgres (or enterprisedb), do:
		initdb  -D '/var/lib/postgres/data'</p>
</div>
<div class="paragraph">
<p>There is a little tricky behavior with the second cluster when you want to connect with a client. By default, connections will be refused for user "enterprisedb" &#8230;&#8203; You need to change the pg_hba file and set "trust" for enterprisedb &#8230;&#8203; Then set a password with the client and put it pack to md5.</p>
</div>
<div class="paragraph">
<p>host    all             enterprisedb    192.168.104.0/24        trust</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_nixos_2">NixOS</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>services.postgresql <span class="tok-o">=</span> <span class="tok-o">{</span>
    <span class="tok-nb">enable</span> <span class="tok-o">=</span> true<span class="tok-p">;</span>
    <span class="tok-nv">authentication</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;&#39;</span>
      <span class="tok-nb">local</span> saltstack all trust
    <span class="tok-s1">&#39;&#39;</span><span class="tok-p">;</span>
  <span class="tok-o">}</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>CREATE USER vagrant SUPERSUSER LOGIN<span class="tok-p">;</span> <i class="conum" data-value="1"></i><b>(1)</b>

CREATE USER salt LOGIN<span class="tok-p">;</span> <i class="conum" data-value="2"></i><b>(2)</b>
CREATE DATABASE saltstack WITH <span class="tok-nv">owner</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;salt&#39;</span><span class="tok-p">;</span>
ALTER USER salt WITH password <span class="tok-s1">&#39;saltpass&#39;</span><span class="tok-p">;</span>

psql saltstack -U salt <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>as root</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>as vagrant</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>as vagrant, check that you can connect to the db</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_tips_3">Tips</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">Allocate a multiple records select in a variable in psql</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>
CREATE OR REPLACE FUNCTION notify_result<span class="tok-o">()</span> RETURNS TRIGGER AS <span class="tok-nv">$$</span>

DECLARE
notification jsonb<span class="tok-p">;</span>
chan text<span class="tok-p">;</span>

BEGIN

-- Get the user as the name of the channel
SELECT load-&gt;&gt;<span class="tok-s1">&#39;user&#39;</span> into chan from jids where <span class="tok-nv">jid</span> <span class="tok-o">=</span> NEW.jid<span class="tok-p">;</span>
-- This is not working because salt_returns table haven<span class="tok-err">&#39;</span>t been filled in yet ...
notification :<span class="tok-o">=</span> <span class="tok-o">(</span>SELECT array_to_json<span class="tok-o">(</span>array_agg<span class="tok-o">(</span>row_to_json<span class="tok-o">(</span>t<span class="tok-o">)))</span> from <span class="tok-o">(</span>SELECT r.full_ret FROM salt_returns r where r.jid <span class="tok-o">=</span> NEW.jid<span class="tok-o">)</span> t<span class="tok-o">)</span><span class="tok-p">;</span>

-- Execute pg_notify<span class="tok-o">(</span>channel, notification<span class="tok-o">)</span>
PERFORM pg_notify<span class="tok-o">(</span>chan, NEW.jid<span class="tok-o">)</span><span class="tok-p">;</span>

-- Result is ignored since this is an AFTER trigger
RETURN NULL<span class="tok-p">;</span>
END<span class="tok-p">;</span>

<span class="tok-nv">$$</span> LANGUAGE plpgsql<span class="tok-p">;</span>

DROP TRIGGER IF EXISTS notify_result on jids<span class="tok-p">;</span>
CREATE TRIGGER notify_result AFTER INSERT ON jids
    FOR EACH ROW EXECUTE PROCEDURE notify_result<span class="tok-o">()</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">COPY</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>COPY edbstore.categories TO <span class="tok-s1">&#39;/tmp/test.csv&#39;</span> WITH <span class="tok-o">(</span>FORMAT <span class="tok-s1">&#39;csv&#39;</span><span class="tok-o">)</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Backup &amp; Recovery</dt>
<dd>
<p>for small DB, we can use a sql dump several time a day:</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>pg_dump dbname <span class="tok-p">|</span> gzip &gt; filename.gz
pg_dump dbname <span class="tok-p">|</span> split -b 1m - filename

psql dbname &lt; infile</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Shell</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>psql -h <span class="tok-m">192</span>.168.14.62 -W -U pradermecker postgres &lt; create_PGPUPPETDB.sql

<span class="tok-nb">export</span> <span class="tok-nv">PGPASSWORD</span><span class="tok-o">=</span>dbpasswordforpuppetdb
ssh puppetmaster-prod <span class="tok-s1">&#39;sudo -u postgres pg_dump puppetdb &#39;</span> <span class="tok-p">|</span> psql -h <span class="tok-m">192</span>.168.14.62 -U puppetdb -w PGPUPPETDB

<span class="tok-k">for</span> t in <span class="tok-k">$(</span>pqsl -U enterprisedb -d edbstore -t -c <span class="tok-s2">&quot;select tablename from pg_tables where tableowner=&#39;edbstore&#39;&quot;</span><span class="tok-k">)</span><span class="tok-p">;</span> <span class="tok-k">do</span>
  pg_dump -t edbstore.<span class="tok-nv">$t</span> -U enterprisedb edbstore &gt; <span class="tok-nv">$t</span>.sql<span class="tok-p">;</span>
<span class="tok-k">done</span>

<span class="tok-k">select</span> tablename from pg_tables where <span class="tok-nv">tableowner</span><span class="tok-o">=</span><span class="tok-s1">&#39;edbstore&#39;</span><span class="tok-p">;</span>
<span class="tok-k">select</span> table_name from information_schema.tables where <span class="tok-nv">table_schema</span><span class="tok-o">=</span><span class="tok-s1">&#39;edbstore&#39;</span><span class="tok-p">;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_replication">Replication</h3>
<div class="ulist">
<ul>
<li>
<p>Hot Streaming Replication (Warm Streaming Replication or Log WAL Shipping is deprecated)
There is a daemon process started by the PostMaster</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We don&#8217;t have to start the slave before the master. The slave can just wait for a master to start up.</p>
</div>
<div class="olist upperroman">
<ol class="upperroman" type="I">
<li>
<p>First shutdown the master and set it up for replication by:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>change <code>postgres.conf</code></p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nv">wal_level</span> <span class="tok-o">=</span> hot_standby
<span class="tok-nv">max_wal_senders</span> <span class="tok-o">=</span> <span class="tok-m">4</span>
<span class="tok-nv">wal_keep_segments</span> <span class="tok-o">=</span> <span class="tok-m">32</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nv">archive_mode</span> <span class="tok-o">=</span> on
<span class="tok-nv">archive_command</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;cp %p /data/archive/%f&#39;</span></code></pre>
</div>
</div>
</li>
<li>
<p>change <code>pg_hba.conf</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>host  replication  repuser slaveip/32  md5</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Configure the <code>pg_hba.conf</code> of the slave:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang=".slave"><span></span>host  replication  repuser masterip/32  md5</code></pre>
</div>
</div>
</li>
<li>
<p>Initialize the cluster</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>On a local server, you can just copy the <code>data</code> folder from the master to the slave or <code>pg_basebackup -h localhost -D /opt/PostgresPlus/9.3AS/data1</code> but on a real set up you would follow these steps:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>on the master:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nv">postgres</span><span class="tok-o">=</span><span class="tok-c1"># select pg_start_backup(&#39;cluster_init&#39;);</span></code></pre>
</div>
</div>
</li>
<li>
<p>on the slave:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>rsync -avz --delete --inplace --exclude-from<span class="tok-o">=</span>/srv/pgsql/do-not-sync  root@195.244.165.68:/srv/pgsql/data/ /srv/pgsql/data <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>with the postgres user</td>
</tr>
</table>
</div>
</li>
<li>
<p>on the master</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nv">postgres</span><span class="tok-o">=</span><span class="tok-c1"># select pg_stop_backup();</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>"	PAX process</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Select * from pg_stat_activity
select * from pg</pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_programming_notes">Programming Notes</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_notion">Notion</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">Functional Programming</dt>
<dd>
<p>The meaning of the programs is centered around evaluating expressions rather than executing instructions.</p>
</dd>
</dl>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>This is the key to functional programming’s power — it allows improved modularization</p>
</div>
<div class="paragraph">
<p>In a functional program what is important is that it is a value oriented language; what we are building are sentences made from different values and higher order functions. The types and higher order values are defining the grammar of those sentences.</p>
</div>
</blockquote>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Algebraic Data Type</dt>
<dd>
<p>A struct or new type, composed from other types either as a product or a sum type.</p>
</dd>
</dl>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Member</th>
<th class="tableblock halign-left valign-top">Inhabitant</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Void</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">()</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bool</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">True, False</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Going from there you can define by sum a type with 3 elements:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-kr">data</span> <span class="tok-kt">Add</span> <span class="tok-n">a</span> <span class="tok-n">b</span> <span class="tok-ow">=</span> <span class="tok-kt">AddL</span> <span class="tok-n">a</span> <span class="tok-o">|</span> <span class="tok-kt">AddR</span> <span class="tok-n">b</span>
<span class="tok-c1">-- or</span>
<span class="tok-kr">data</span> <span class="tok-kt">Either</span> <span class="tok-n">a</span> <span class="tok-n">b</span> <span class="tok-ow">=</span> <span class="tok-kt">Left</span> <span class="tok-n">a</span> <span class="tok-o">|</span> <span class="tok-kt">Right</span> <span class="tok-n">b</span>

<span class="tok-c1">-- if a is Bool and b is () you have got:</span>
<span class="tok-nf">addValues</span> <span class="tok-ow">=</span> <span class="tok-p">[</span><span class="tok-kt">AddL</span> <span class="tok-kt">False</span><span class="tok-p">,</span> <span class="tok-kt">AddL</span> <span class="tok-kt">True</span><span class="tok-p">,</span> <span class="tok-kt">AddR</span> <span class="tok-nb">()</span><span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also use a product type with Mul:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span></span><span class="tok-kr">data</span> <span class="tok-kt">Mul</span> <span class="tok-n">a</span> <span class="tok-n">b</span> <span class="tok-ow">=</span> <span class="tok-kt">Mul</span> <span class="tok-n">a</span> <span class="tok-n">b</span>
<span class="tok-c1">-- or</span>
<span class="tok-kr">data</span> <span class="tok-p">(,)</span> <span class="tok-n">a</span> <span class="tok-n">b</span> <span class="tok-ow">=</span> <span class="tok-p">(</span><span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-n">b</span><span class="tok-p">)</span>

<span class="tok-nf">mulValues</span> <span class="tok-ow">=</span> <span class="tok-p">[</span><span class="tok-kt">Mul</span> <span class="tok-kt">False</span> <span class="tok-kt">False</span><span class="tok-p">,</span> <span class="tok-kt">Mul</span> <span class="tok-kt">False</span> <span class="tok-kt">True</span><span class="tok-p">,</span> <span class="tok-kt">Mul</span> <span class="tok-kt">True</span> <span class="tok-kt">False</span><span class="tok-p">,</span> <span class="tok-kt">Mul</span> <span class="tok-kt">True</span> <span class="tok-kt">True</span><span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Abstract Data Type (ADT)</dt>
<dd>
<p>A data type is said to be abstract when its implementation is hidden from the client.
ADT&#8217;s are types which encapsulates a set of operations.
The concept originates from CLU (Liskov, 1972) :</p>
</dd>
</dl>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Modules &#8594; Partitions &#8594; ADTs</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>The canonical example is a <code>Stack</code> for which we define a set of operations including a way to construct/get a new empty Stack.</p>
</div>
<div class="paragraph">
<p>This is very different and even dual to the concept of objects in OO. ADT operations belongs to its datatype whereas OO objects are implemented as collections of observations (methods) that can be performed upon them. The focus on observations, rather than construction, means that objects are best understood as co-algebras.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Hash Value</dt>
<dd>
<p><code>Hashing</code> is a transformation <code>AnyText &#8594; TextWithFixedSmallerSize</code> (array of bites) called <code>digest</code> or <code>hash value</code> with the following (ideal) properties:</p>
<div class="ulist">
<ul>
<li>
<p>it is quick to compute</p>
</li>
<li>
<p>it is not reversible: you cannot get anyText from the digest</p>
</li>
<li>
<p>the <code>digest</code> is unique so that two different <code>AnyText</code> will always have a different digest.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The idea is to store this mapping in a database so that you use <code>digest</code> as a representation for <code>AnyText</code> (the <code>digest</code> becomes the id/handle for the Text).
Given such a mapping you can also hash <code>AnyText</code>, get a <code>digest</code> and do a lookup in the table to see if the mapping already exists.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">CAP</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Consistency</p>
</li>
<li>
<p>Availability</p>
</li>
<li>
<p>Partition</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Glossary</dt>
<dd>
<div class="paragraph">
<div class="title">nibble</div>
<p>Half of one byte. So 4 bits/digits &#8594; 16 values</p>
</div>
<div class="paragraph">
<div class="title">subroutine</div>
<p>Synonym for function</p>
</div>
<div class="literalblock">
<div class="title">subtype</div>
<div class="content">
<pre>Circle &lt;: Shape</pre>
</div>
</div>
<div class="paragraph">
<div class="title">Object Orientated Programming</div>
<p>Objects by definition include mutable state &#8594; intensional object identity !!</p>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_quotes">Quotes</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">Monitoring</dt>
</dl>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Software should be designed from the start to be monitored</p>
</div>
</blockquote>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">ORM</dt>
</dl>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>ORMs are mixing different concerns. There were introduced by OO zealots to avoid the declarative nature of SQL. Now according to Martin Fowler they are just a way to get memory cache. Yes right but that is not the way ORMs have been sold ?</p>
</div>
<div class="paragraph">
<p>The whole ORM story looks like a complete disaster. Building a graph of objects in memory across sessions has proven to make little sense in many projects I had worked on.</p>
</div>
<div class="paragraph">
<p>If you deal with a relational database, abstracting it with mutable pojos is dubious at best. I am pretty convinced a nice API query interface such as LINQ can solve the problems of the myriads of SQL statements to handle.</p>
</div>
<div class="paragraph">
<p>Here is the problem, at the end, data are used to be feed into viewer. So let&#8217;s get this straight. Output JSON directly from a query language interface !</p>
</div>
</blockquote>
</div>
</div>
<div class="sect2">
<h3 id="_scrible">Scrible</h3>
<div class="paragraph">
<p>Please do understand the difference between &#8594; and &#8658; &#8230;&#8203; what you need here is "lead to" maybe implies</p>
</div>
<div class="paragraph">
<p>RAM : Heap &amp; Stack</p>
</div>
<div class="paragraph">
<p>IDENDITY LABEL FOR A TIMELINE
CONFLATE ID WITH STATE
REF TYPE BOXES TO VALUES</p>
</div>
<div class="paragraph">
<p>How do we express polymorphism in UML. You mark class with a stereotype. You have to see class as something really global in UML. It is just a blueprint of code.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_elastic_search">Elastic Search</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_characteristics">Characteristics</h3>
<div class="paragraph">
<p>ES only keeps one version of a document</p>
</div>
<div class="paragraph">
<p>Automatic index creation by generating a "mapping"</p>
</div>
<div class="paragraph">
<p>All documents live in an index.  An index is roughtly the same as a database which mean it is just a namespace. A type is like a table, a collection of similar thing. A document is like a row and a field is similar to a column.</p>
</div>
<div class="paragraph">
<p>Everything is stored in an inversed index.</p>
</div>
<div class="paragraph">
<p>a namespace
* index
* index type</p>
</div>
<div class="paragraph">
<p>By default each index is divided in 5 pieces called Shards. A document will live on a single shard + by default on replica for each shard.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_category_theory">Category theory</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Abstract algebra of function
In category theory we never look inside objects. All information about objects is encoded in the arrows (morphisms) between them.</p>
</div>
</blockquote>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">definition</dt>
<dd>
<p>A category is a bunch of objects together with <code>morphisms</code> <sup class="footnote">[<a id="_footnoteref_8" class="footnote" href="#_footnote_8" title="View footnote.">8</a>]</sup>.
The objects have not structure or meaning, actually they only serve to mark the beginning or end of an arrow.
Morphisms are direct mappings between these objects <sup class="footnote">[<a id="_footnoteref_9" class="footnote" href="#_footnote_9" title="View footnote.">9</a>]</sup> that preverse a <code>structure</code>.
The structure whatever it is characterizes the category.</p>
<div class="ulist">
<ul>
<li>
<p>there must exist a morphism called <code>identity</code> (the zero) that maps an object into itself (e.g: 1A).</p>
</li>
<li>
<p>the morphisms need to compose while respecting <code>associativity</code>:<br>
<code>h∘(g∘f) == (h∘g)∘f</code></p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<div class="title">Example:</div>
<p>In a functional programming language, morphisms/arrows are <code>functions</code> and objects are <code>types</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_purescript">Purescript</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_quick_setup">Quick setup</h3>
<div class="listingblock">
<div class="title">Install</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>→ nix-env -iA nixos.purescript
→ nix-env -iA nixos.psc-package
→ nix-env -f ~/.config/nixpkgs/pin.nix -iA nodePackages.pulp</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Project</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>→ pulp --psc-package init
→ pulp build --to dist/test.js
→ cat &gt; dist/test.html <span class="tok-s">&lt;&lt;EOF</span>
<span class="tok-s">&lt;!doctype html&gt;</span>
<span class="tok-s">&lt;html&gt;</span>
<span class="tok-s">  &lt;head&gt;</span>
<span class="tok-s">    &lt;title&gt;Test Purescript&lt;/title&gt;</span>
<span class="tok-s">    &lt;style&gt;</span>
<span class="tok-s">      body {</span>
<span class="tok-s">        font-family: sans-serif;</span>
<span class="tok-s">        max-width: 570px;</span>
<span class="tok-s">        margin: auto;</span>
<span class="tok-s">      }</span>
<span class="tok-s">    &lt;/style&gt;</span>
<span class="tok-s">  &lt;/head&gt;</span>
<span class="tok-s">  &lt;body&gt;</span>
<span class="tok-s">    &lt;script src=&quot;test.js&quot;&gt;&lt;/script&gt;</span>
<span class="tok-s">  &lt;/body&gt;</span>
<span class="tok-s">&lt;/html&gt;</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_tips_tricks">Tips &amp; tricks</h3>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">Purescript</th>
<th class="tableblock halign-center valign-top">Haskell</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>&lt;&lt;&lt;</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>.</code></p></td>
</tr>
</tbody>
</table>
<script>
(function() {
    var sidetext = document.getElementsByClassName("sidebarblock");
    for (var i = 0; i < sidetext.length; i++) {
        var e = sidetext[i];
        try {
          var content = e.children[0].children[1].children[0];
        } catch (e) { continue;}
        var tri = e.children[0].children[0].children[0];
        // make all sidetext invisible by default
        content.style.display = 'none';
        e.onclick = function () {
            var style = content.style;
            if(style.display == 'block') {
                style.display = 'none';
                tri.classList.remove("toggle");
            } else {
                style.display = 'block';
                tri.classList.add("toggle");
            }
        }
    }
})();
</script>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnote_1">
<a href="#_footnoteref_1">1</a>. If no such files exists, it will default to <code>&lt;nixpkgs&gt;</code>
</div>
<div class="footnote" id="_footnote_2">
<a href="#_footnoteref_2">2</a>. similar to <code>overrridePackages</code> which is only used outside of the special <code>config.nix</code> for specific use cases
</div>
<div class="footnote" id="_footnote_3">
<a href="#_footnoteref_3">3</a>. Each instance implements the same function differently or to say it  diffently one function will behave diffently according to the types of its arguments
</div>
<div class="footnote" id="_footnote_4">
<a href="#_footnoteref_4">4</a>. Unfolding is then associated to producers or <code>monads</code>.
</div>
<div class="footnote" id="_footnote_5">
<a href="#_footnoteref_5">5</a>. state monad transformer.
</div>
<div class="footnote" id="_footnote_6">
<a href="#_footnoteref_6">6</a>. a mental model that might help is to look at each filepath as being a list of string not just one string
</div>
<div class="footnote" id="_footnote_7">
<a href="#_footnoteref_7">7</a>. the DNS host for every docker is always 172.17.0.1
</div>
<div class="footnote" id="_footnote_8">
<a href="#_footnoteref_8">8</a>. also called arrows
</div>
<div class="footnote" id="_footnote_9">
<a href="#_footnoteref_9">9</a>. you can have zero, one or many arrows from one object to another
</div>
</div>
</body>
</html>