= Kubernetes


== Cluster description

=== Namespaces

- kube-public
- kube-system
- default

=== Control plane


- kube-apiserver
- kube-scheduler
- kube-controller-manager
- kube-proxy
- kube-flannel
- https://coredns.io/[coredns]


=== Worker

.join the cluster
```
kubeadm join --discovery-token 951876.7dd42a6e33a2b7af --discovery-token-ca-cert-hash sha256:1234..cdef 1.2.3.4:644
```

=== Helm

To install `helm`, install the client using the package manager of your OS.
You currently need to deploy the server into your cluster with the `helm init` command :

```
→ kubectl apply -f helm-rbac.yaml
→ helm init --service-account tiller
→ helm version
→ helm search stable/jenkins
→ helm install --name mediawiki stable/mediawiki
→ helm ls
→ helm delete mediawiki
```

=== Dashboard

```
kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v1.10.1/src/deploy/recommended/kubernetes-dashboard.yaml
```

.dashboard-user.yaml
```
apiVersion: v1
kind: ServiceAccount
metadata:
  name: admin-user
  namespace: kube-system
---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRoleBinding
metadata:
  name: admin-user
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: admin-user
  namespace: kube-system
```

```
kubectl apply -f dashboard-user.yaml
kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | cut -f1 -d ' ')
```

```
kubectl proxy
xdg-open http://localhost:8001/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy/#!/login <1>
```
<1> http://localhost:8080/api/v1/namespaces/kube-system/services/kubernetes-dashboard might also work.


== Useful commands

.node description
```
kubectl describe node master
```

.pod description
```
kubectl -n kube-system get pod -o wide
```

.kubeadmin config
```
kubectl -n kube-system get cm kubeadm-config -oyaml
```

.remove evicted pods
```
kubectl get po -a --all-namespaces -o json | jq  '.items[] | select(.status.reason!=null) | select(.status.reason | contains("Evicted")) | "kubectl delete po \(.metadata.name) -n \(.metadata.namespace)"' | xargs -n 1 bash -c
```

.api
```
http://127.0.0.1:8080/api/v1/proxy/namespaces/kube-system/services/
```

== Minikube on Windows

.using chocolatey
```
choco install -f -y kubernetes-helm
```

== Resources

https://metallb.universe.tf/[metalLB]::
a load-balancer implementation for bare metal Kubernetes clusters, using standard routing protocols.
